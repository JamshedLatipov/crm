# Линковка логов звонков с задачами

## Обзор изменений

Реализована функциональность автоматической связи задач с логами звонков при создании задачи из контекста звонка.

## Изменённые файлы

### Backend

1. **apps/back/src/app/modules/tasks/task.entity.ts**
   - Добавлено поле `callLogId: string` (UUID) для хранения ссылки на лог звонка

2. **apps/back/src/app/modules/tasks/task.dto.ts**
   - Добавлено `callLogId?: string` в `CreateTaskDto`
   - Добавлено `callLogId?: string` в `UpdateTaskDto`

3. **apps/back/src/app/modules/tasks/task.service.ts**
   - Добавлена обработка `callLogId` при создании задачи:
     ```typescript
     if (data.callLogId) {
       taskData.callLogId = data.callLogId;
     }
     ```

4. **apps/back/src/app/modules/tasks/migrations/1740000000003-AddCallLogIdToTasks.ts**
   - Создана миграция для добавления колонки `callLogId` в таблицу `tasks`
   - Добавлен индекс `IDX_tasks_callLogId` для оптимизации поиска

5. **apps/back/src/app/modules/tasks/migrations/index.ts**
   - Зарегистрирована новая миграция

### Frontend

1. **apps/front/src/app/tasks/tasks.service.ts**
   - Добавлено `callLogId?: string` в интерфейс `TaskDto`

2. **apps/front/src/app/tasks/components/task-modal/task-modal.component.ts**
   - Добавлена логика включения `callLogId` из конфига в DTO при сохранении:
     ```typescript
     const cfg = this.config();
     if (cfg.callLogId) {
       taskDto.callLogId = cfg.callLogId;
     }
     ```

3. **apps/front/src/app/softphone/softphone.component.ts**
   - Изменён метод `manualRegisterCall()` на async
   - Реализована последовательность:
     1. Сохранение лога звонка
     2. Получение ID лога
     3. Открытие модалки задачи с переданным `callLogId`

## Поток выполнения

1. **Пользователь выбирает скрипт и включает toggle "Создать задачу сразу"**
2. **Нажимает "Сохранить"**
3. **Вызывается `softphone.manualRegisterCall()`:**
   ```typescript
   const logResult = await this.callHistoryService.saveCallLog(callId, {...});
   savedLogId = logResult?.id || logResult?.logId || null;
   ```
4. **Открывается модалка задачи:**
   ```typescript
   this.taskModal.openModal({ 
     mode: 'create', 
     title, 
     note: noteToSave,
     callLogId: savedLogId 
   });
   ```
5. **При сохранении задачи `callLogId` добавляется в DTO:**
   ```typescript
   if (cfg.callLogId) {
     taskDto.callLogId = cfg.callLogId;
   }
   ```
6. **Backend сохраняет задачу со ссылкой на лог:**
   ```typescript
   if (data.callLogId) {
     taskData.callLogId = data.callLogId;
   }
   ```

## База данных

### Новая колонка в таблице `tasks`:
```sql
ALTER TABLE "tasks" ADD COLUMN "callLogId" uuid NULL;
CREATE INDEX "IDX_tasks_callLogId" ON "tasks" ("callLogId");
```

## Применение миграции

После запуска бэкенда миграция применится автоматически благодаря TypeORM.

Для ручного применения:
```bash
npm run migration:run
```

## Использование

1. Оператор совершает звонок
2. Открывает вкладку "Сценарии" в софтфоне
3. Выбирает скрипт звонка
4. Заполняет заметку (опционально)
5. Включает toggle "Создать задачу сразу"
6. Нажимает "Сохранить"
7. Открывается модалка с предзаполненным названием задачи
8. После сохранения задача будет связана с логом звонка через `callLogId`

## Преимущества

- **Полная трассировка**: каждая задача знает из какого звонка она создана
- **Аналитика**: возможность построения отчётов по эффективности звонков → задач
- **Контекст**: в будущем можно показывать детали звонка при просмотре задачи
- **Целостность данных**: UUID связь гарантирует уникальность

## Дальнейшие улучшения

- [ ] Показывать информацию о связанном звонке в карточке задачи
- [ ] Фильтр задач по наличию связанного звонка
- [ ] Статистика конверсии звонок → задача → результат
- [ ] Воспроизведение записи звонка из карточки задачи

---

**Дата:** 2024
**Автор:** GitHub Copilot
