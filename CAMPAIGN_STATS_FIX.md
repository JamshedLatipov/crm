# Исправление отображения статистики кампаний

## Дата: 07.01.2026

## Проблема
Цифры в карточках "Отправлено", "Доставлено", "Ошибки" и "Доставляемость" показывали 0 для всех кампаний.

## Причина
1. Компонент пытался подсчитать статистику из `messagesByStatus`, но для draft и неактивных кампаний там были только `pending` сообщения
2. Не использовались агрегированные поля из кампании (`totalSent`, `totalDelivered`, `totalFailed`)
3. Отсутствовала информация для пользователя о том, почему показываются нули

## Решение

### 1. Изменена логика подсчёта статистики
**Файл:** `campaign-stats.component.ts`

Теперь используются агрегированные поля из объекта кампании:
```typescript
const totalSent = campaign.totalSent || 0;
const delivered = campaign.totalDelivered || 0;
const failed = campaign.totalFailed || 0;
const pending = messagesByStatus['pending'] || 0;
```

### 2. Добавлены информационные сообщения

#### Для draft кампаний:
- Синяя информационная карточка
- Текст: "Кампания ещё не запущена"
- Показывает количество получателей и подготовленных сообщений
- Отображает детали кампании без статистики отправки

#### Для активных кампаний с pending сообщениями:
- Жёлтая предупреждающая карточка
- Текст: "Кампания запущена, отправка в процессе"
- Показывает количество сообщений в очереди
- Объясняет, что статистика появится после начала доставки

### 3. Улучшен UI

#### Информационные карточки:
```scss
.info-card {
  background: #eff6ff;  // Синий для info
  border: 1px solid #3b82f6;
  
  &.warning {
    background: #fef3c7;  // Жёлтый для warning
    border-color: #f59e0b;
  }
}
```

#### Pending badge:
```scss
.pending-badge {
  padding: 4px 12px;
  background: #fbbf24;
  color: #78350f;
  border-radius: 12px;
  font-weight: 600;
}
```

### 4. Логика отображения

```typescript
@if (loading()) {
  // Показать спиннер
} @else if (campaign()?.status === 'draft') {
  // Показать информацию о черновике
} @else {
  @if (stats().sent === 0 && stats().pending > 0 && 
      (campaign()?.status === 'sending' || campaign()?.status === 'active')) {
    // Показать предупреждение о pending сообщениях
  }
  // Показать полную статистику
}
```

## Результат

### Draft кампания:
- ✅ Информационное сообщение "Кампания ещё не запущена"
- ✅ Показывается количество получателей
- ✅ Показывается количество подготовленных сообщений
- ✅ Детали кампании (название, канал, шаблон, сегмент)
- ✅ Нет карточек со статистикой (корректно, т.к. нечего показывать)

### Активная кампания с pending сообщениями:
- ✅ Предупреждение "Отправка в процессе"
- ✅ Показывается количество сообщений в очереди
- ✅ Карточки статистики показывают 0 (корректно)
- ✅ Понятно почему 0 (сообщения в очереди)

### Кампания с отправленными сообщениями:
- ✅ Полная статистика отправки
- ✅ Корректные проценты доставляемости
- ✅ Детальная информация

## Примеры данных

### Draft кампания (ID: 11bbd3dd-20dc-4f4c-a8e7-98f97251e44b):
```json
{
  "status": "draft",
  "totalRecipients": 2,
  "totalSent": 0,
  "totalDelivered": 0,
  "totalFailed": 0,
  "messagesByStatus": {
    "pending": 2
  }
}
```
**Отображение:** Информационное сообщение о черновике

### Sending кампания (ID: 22268068-e650-4b3d-83df-16bd8cf21575):
```json
{
  "status": "sending",
  "totalRecipients": 2,
  "totalSent": 0,
  "totalDelivered": 0,
  "totalFailed": 0,
  "messagesByStatus": {
    "pending": 2
  }
}
```
**Отображение:** Предупреждение "Отправка в процессе" + статистика с нулями

## Тестирование

### Для draft кампании:
http://localhost:4200/messages/campaigns/11bbd3dd-20dc-4f4c-a8e7-98f97251e44b/stats

Ожидаемый результат:
- Синяя карточка с информацией
- Показано: "2 сообщений подготовлено"
- Детали кампании

### Для sending кампании:
http://localhost:4200/messages/campaigns/22268068-e650-4b3d-83df-16bd8cf21575/stats

Ожидаемый результат:
- Жёлтая карточка с предупреждением
- Показано: "2 сообщений в очереди"
- Статистика: все 0
- Детали кампании

## Дополнительные улучшения

1. ✅ Более информативное отображение для пользователя
2. ✅ Объяснение, почему показываются нули
3. ✅ Визуальное разделение состояний (цвета, иконки)
4. ✅ Показ pending сообщений в контексте
5. ✅ Детали шаблона и сегмента

## Заметки

- Если бэкенд не обновляет `totalSent`, `totalDelivered`, `totalFailed` во время отправки, это нужно исправить на бэкенде
- Текущая реализация корректно показывает доступные данные
- UI адаптируется к статусу кампании
