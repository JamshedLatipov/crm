<app-page-layout [title]="forecast()?.name || 'Прогноз'" subtitle="Детальная информация о прогнозе">
  <div page-actions>
    <button mat-button routerLink="/forecasting">
      <mat-icon>arrow_back</mat-icon>
      Назад к списку
    </button>
    <button mat-button color="accent" (click)="exportToCSV()" [disabled]="loading() || periods().length === 0">
      <mat-icon>download</mat-icon>
      Экспорт CSV
    </button>
    <button mat-raised-button color="primary" (click)="calculate()" [disabled]="loading() || calculating()">
      <mat-spinner *ngIf="calculating()" diameter="20"></mat-spinner>
      <mat-icon *ngIf="!calculating()">refresh</mat-icon>
      {{ calculating() ? 'Расчет...' : 'Пересчитать' }}
    </button>
  </div>

  <div *ngIf="loading()" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!loading() && forecast()" class="forecast-detail-container">
    <!-- Summary Cards -->
    <div class="summary-cards">
      <div class="stat-card stat-card-target">
        <div class="stat-icon">
          <mat-icon>flag</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Целевое значение</div>
          <div class="stat-value">{{ formatCurrency(forecast()?.targetValue) }}</div>
        </div>
      </div>

      <div class="stat-card stat-card-predicted">
        <div class="stat-icon">
          <mat-icon>insights</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Прогноз</div>
          <div class="stat-value">{{ forecast()?.predictedValue ? formatCurrency(forecast()?.predictedValue) : '-' }}</div>
        </div>
      </div>

      <div class="stat-card stat-card-actual">
        <div class="stat-icon">
          <mat-icon>analytics</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Факт</div>
          <div class="stat-value">{{ forecast()?.actualValue ? formatCurrency(forecast()?.actualValue) : '-' }}</div>
        </div>
      </div>

      <div class="stat-card stat-card-confidence">
        <div class="stat-icon">
          <mat-icon>verified</mat-icon>
        </div>
        <div class="stat-content">
          <div class="stat-label">Уверенность</div>
          <div class="stat-value">{{ formatPercentage(forecast()?.confidence) }}</div>
        </div>
      </div>
    </div>

    <!-- Main Information -->
    <div class="info-grid">
      <mat-card class="info-card">
        <div class="card-header">
          <mat-icon>info</mat-icon>
          <h3>Основная информация</h3>
        </div>
        <div class="info-content">
          <div class="info-item">
            <span class="label">Тип прогноза</span>
            <span class="value">{{ typeLabels[forecast()!.type] }}</span>
          </div>
          <div class="info-item">
            <span class="label">Метод расчета</span>
            <span class="value">{{ methodLabels[forecast()!.method] }}</span>
          </div>
          <div class="info-item">
            <span class="label">Статус</span>
            <span class="value">
              <span [class]="'status-chip status-' + forecast()?.status">
                {{ statusLabels[forecast()!.status] }}
              </span>
            </span>
          </div>
          <div class="info-item">
            <span class="label">Период прогноза</span>
            <span class="value">
              <mat-icon class="inline-icon">date_range</mat-icon>
              {{ formatDateRange(forecast()?.startDate, forecast()?.endDate) }}
            </span>
          </div>
          <div class="info-item" *ngIf="forecast()?.description">
            <span class="label">Описание</span>
            <span class="value">{{ forecast()?.description }}</span>
          </div>
        </div>
      </mat-card>

      <mat-card class="info-card">
        <div class="card-header">
          <mat-icon>assessment</mat-icon>
          <h3>Метрики эффективности</h3>
        </div>
        <div class="info-content">
          <div class="info-item">
            <span class="label">Точность прогноза</span>
            <span class="value">
              {{ forecast()?.accuracy ? formatPercentage(forecast()?.accuracy) : '-' }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">Общее отклонение</span>
            <span class="value" [class]="'variance-' + getVarianceColor(getTotalVariance())">
              {{ formatCurrency(getTotalVariance()) }}
            </span>
          </div>
          <div class="info-item">
            <span class="label">Периодов создано</span>
            <span class="value">{{ periods().length }}</span>
          </div>
          <div class="info-item">
            <span class="label">Дата создания</span>
            <span class="value">{{ forecast()?.createdAt | date:'dd.MM.yyyy HH:mm' }}</span>
          </div>
        </div>
      </mat-card>
    </div>

    <!-- Charts Section -->
    <mat-tab-group class="charts-tabs">
      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>show_chart</mat-icon>
          Цель vs Прогноз vs Факт
        </ng-template>
        <div class="chart-card">
          <div class="chart-container">
            <canvas baseChart
              [data]="lineChartData"
              [options]="lineChartOptions"
              [type]="lineChartType">
            </canvas>
          </div>
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>bar_chart</mat-icon>
          Отклонения
        </ng-template>
        <div class="chart-card">
          <div class="chart-container">
            <canvas baseChart
              [data]="barChartData"
              [options]="barChartOptions"
              [type]="barChartType">
            </canvas>
          </div>
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>pie_chart</mat-icon>
          Распределение
        </ng-template>
        <div class="chart-card">
          <div class="chart-container chart-container-pie">
            <canvas baseChart
              [data]="pieChartData"
              [options]="pieChartOptions"
              [type]="pieChartType">
            </canvas>
          </div>
        </div>
      </mat-tab>

      <mat-tab>
        <ng-template mat-tab-label>
          <mat-icon>timeline</mat-icon>
          Уверенность
        </ng-template>
        <div class="chart-card">
          <div class="chart-container">
            <canvas baseChart
              [data]="confidenceChartData"
              [options]="confidenceChartOptions"
              [type]="confidenceChartType">
            </canvas>
          </div>
        </div>
      </mat-tab>
    </mat-tab-group>

    <!-- Comparison Section (Сравнение прогноза с фактом) -->
    <div class="comparison-section" *ngIf="getPeriodsWithData().withActual > 0">
      <h3>
        <mat-icon>compare_arrows</mat-icon>
        Сравнение прогноза с фактом
      </h3>

      <!-- Карточки метрик -->
      <div class="comparison-grid">
        <div class="comparison-card">
          <div class="label">Средняя точность</div>
          <div class="value" [ngClass]="getAverageAccuracy() >= 80 ? 'positive' : getAverageAccuracy() >= 60 ? '' : 'negative'">
            {{ getAverageAccuracy() | number:'1.1-1' }}%
          </div>
          <div class="sublabel">{{ getPeriodsWithData().withActual }} из {{ getPeriodsWithData().total }} периодов</div>
        </div>

        <div class="comparison-card">
          <div class="label">MAPE</div>
          <div class="value" [ngClass]="getMAPE() <= 20 ? 'positive' : getMAPE() <= 40 ? '' : 'negative'">
            {{ getMAPE() | number:'1.1-1' }}%
          </div>
          <div class="sublabel">Средняя процентная ошибка</div>
        </div>

        <div class="comparison-card">
          <div class="label">Общее отклонение</div>
          <div class="value" [ngClass]="getTotalVariance() > 0 ? 'positive' : getTotalVariance() < 0 ? 'negative' : ''">
            {{ formatCurrency(getTotalVariance()) }}
          </div>
          <div class="sublabel">{{ getTotalVariance() > 0 ? 'Превышение' : getTotalVariance() < 0 ? 'Недовыполнение' : 'Точное выполнение' }}</div>
        </div>

        <div class="comparison-card" *ngIf="forecast()?.targetValue && forecast()?.actualValue">
          <div class="label">Достижение цели</div>
          <div class="value" [ngClass]="getTargetAchievement() >= 100 ? 'positive' : getTargetAchievement() >= 80 ? '' : 'negative'">
            {{ getTargetAchievement() | number:'1.1-1' }}%
          </div>
          <div class="sublabel">{{ formatCurrency(forecast()!.actualValue!) }} из {{ formatCurrency(forecast()!.targetValue!) }}</div>
        </div>
      </div>

      <!-- Лучший и худший периоды -->
      <div class="best-worst-periods" *ngIf="getBestAndWorstPeriods() as periods">
        <div class="period-highlight best-period" *ngIf="periods.best">
          <div class="period-header">
            <mat-icon>star</mat-icon>
            <span class="period-title">Лучший период</span>
          </div>
          <div class="period-info">
            <div class="period-name">{{ periods.best.periodLabel }}</div>
            <div class="period-stats">
              <span class="stat">
                <span class="stat-label">Цель:</span>
                <span class="stat-value">{{ formatCurrency(periods.best.targetValue) }}</span>
              </span>
              <span class="stat">
                <span class="stat-label">Прогноз:</span>
                <span class="stat-value">{{ formatCurrency(periods.best.predictedValue) }}</span>
              </span>
              <span class="stat">
                <span class="stat-label">Факт:</span>
                <span class="stat-value">{{ formatCurrency(periods.best.actualValue) }}</span>
              </span>
            </div>
          </div>
        </div>

        <div class="period-highlight worst-period" *ngIf="periods.worst">
          <div class="period-header">
            <mat-icon>warning</mat-icon>
            <span class="period-title">Требует внимания</span>
          </div>
          <div class="period-info">
            <div class="period-name">{{ periods.worst.periodLabel }}</div>
            <div class="period-stats">
              <span class="stat">
                <span class="stat-label">Цель:</span>
                <span class="stat-value">{{ formatCurrency(periods.worst.targetValue) }}</span>
              </span>
              <span class="stat">
                <span class="stat-label">Прогноз:</span>
                <span class="stat-value">{{ formatCurrency(periods.worst.predictedValue) }}</span>
              </span>
              <span class="stat">
                <span class="stat-label">Факт:</span>
                <span class="stat-value">{{ formatCurrency(periods.worst.actualValue) }}</span>
              </span>
            </div>
          </div>
        </div>
      </div>

      <!-- Пояснение метрик -->
      <div class="metrics-explanation">
        <mat-icon>info_outline</mat-icon>
        <div class="explanation-text">
          <strong>Средняя точность</strong> показывает, насколько близки прогнозы к фактическим значениям. 
          <strong>MAPE</strong> (Mean Absolute Percentage Error) - стандартная метрика точности прогноза.
          Чем ниже MAPE, тем лучше прогноз (хорошо: &lt;20%, приемлемо: 20-40%, плохо: &gt;40%).
        </div>
      </div>
    </div>

    <!-- Periods Table -->
    <mat-card class="periods-table-card">
      <mat-card-header>
        <mat-card-title>
          <mat-icon>view_list</mat-icon>
          Периоды прогноза ({{ periods().length }})
        </mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <crm-table
          *ngIf="periods().length > 0"
          [columns]="periodsColumns"
          [data]="periods()"
          [pageSize]="10"
          [pageSizeOptions]="[5, 10, 25]"
        >
          <ng-template crmColumnTemplate="periodLabelTemplate" let-row>
            <div class="period-label">
              <mat-icon class="table-icon">event</mat-icon>
              <strong>{{ row.periodLabel }}</strong>
            </div>
          </ng-template>

          <ng-template crmColumnTemplate="targetTemplate" let-row>
            <span class="number-cell">{{ formatCurrency(row.targetValue) }}</span>
          </ng-template>

          <ng-template crmColumnTemplate="predictedTemplate" let-row>
            <span class="number-cell predicted">
              {{ row.predictedValue ? formatCurrency(row.predictedValue) : '-' }}
            </span>
          </ng-template>

          <ng-template crmColumnTemplate="actualTemplate" let-row>
            <span class="number-cell actual">
              {{ row.actualValue ? formatCurrency(row.actualValue) : '-' }}
            </span>
          </ng-template>

          <ng-template crmColumnTemplate="varianceTemplate" let-row>
            <span [class]="'number-cell variance-' + getVarianceColor(row.variance)">
              <mat-icon *ngIf="row.variance > 0" class="variance-icon">trending_up</mat-icon>
              <mat-icon *ngIf="row.variance < 0" class="variance-icon">trending_down</mat-icon>
              {{ row.variance ? formatCurrency(row.variance) : '-' }}
            </span>
          </ng-template>

          <ng-template crmColumnTemplate="confidenceTemplate" let-row>
            <span [class]="'confidence-chip confidence-' + getConfidenceColor(row.confidence)">
              {{ formatPercentage(row.confidence) }}
            </span>
          </ng-template>

          <ng-template crmColumnTemplate="actionsTemplate" let-row>
            <button mat-icon-button color="primary" 
                    (click)="editPeriodActual(row)"
                    matTooltip="Редактировать факт">
              <mat-icon>edit</mat-icon>
            </button>
          </ng-template>
        </crm-table>

        <div *ngIf="periods().length === 0" class="no-data">
          <mat-icon>info</mat-icon>
          <p>Нет данных о периодах</p>
        </div>
      </mat-card-content>
    </mat-card>
  </div>
</app-page-layout>
