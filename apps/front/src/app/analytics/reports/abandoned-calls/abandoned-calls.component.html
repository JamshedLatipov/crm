<div class="abandoned-calls-report">
  <app-report-filters (filtersChange)="onFiltersChange($event)" />

  <div *ngIf="loading()" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="error()" class="error-message">
    {{ error() }}
  </div>

  <div *ngIf="!loading() && !error() && hasData()" class="report-content">
    <!-- Summary KPIs -->
    <div class="kpi-cards">
      <mat-card class="kpi-card danger">
        <mat-card-header>
          <mat-card-title>Всего брошенных</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{ data()?.totalAbandoned || 0 }}</div>
          <div class="kpi-subtitle">из {{ data()?.totalCalls || 0 }} звонков</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card" [ngClass]="getSeverityClass(data()?.abandonRate || 0)">
        <mat-card-header>
          <mat-card-title>Процент отказа</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{ (data()?.abandonRate || 0).toFixed(1) }}%</div>
          <div class="kpi-subtitle">целевой показатель &lt; 5%</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-header>
          <mat-card-title>Среднее время отказа</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{ formatTime(data()?.avgAbandonTime || 0) }}</div>
          <div class="kpi-subtitle">медиана: {{ formatTime(data()?.medianAbandonTime || 0) }}</div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Распределение по часам</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas
              baseChart
              [data]="hourlyChartData()"
              [options]="hourlyChartOptions"
              type="line"
            ></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Динамика по дням</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas
              baseChart
              [data]="dailyChartData()"
              [options]="dailyChartOptions"
              type="line"
            ></canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Reasons Pie Chart and Table -->
    <div class="reasons-section">
      <mat-card class="reasons-chart-card">
        <mat-card-header>
          <mat-card-title>Причины отказа</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas
              baseChart
              [data]="reasonsChartData()"
              [options]="reasonsChartOptions"
              type="pie"
            ></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="reasons-table-card">
        <mat-card-header>
          <mat-card-title>Детализация причин</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="data()?.reasons || []" class="reasons-table">
            <ng-container matColumnDef="reason">
              <th mat-header-cell *matHeaderCellDef>Причина</th>
              <td mat-cell *matCellDef="let row">{{ row.reason }}</td>
            </ng-container>

            <ng-container matColumnDef="count">
              <th mat-header-cell *matHeaderCellDef>Количество</th>
              <td mat-cell *matCellDef="let row">{{ row.count }}</td>
            </ng-container>

            <ng-container matColumnDef="percentage">
              <th mat-header-cell *matHeaderCellDef>Процент</th>
              <td mat-cell *matCellDef="let row">{{ row.percentage.toFixed(1) }}%</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="displayedColumnsReasons"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsReasons"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Queue Performance Table -->
    <mat-card class="queue-table-card">
      <mat-card-header>
        <mat-card-title>Брошенные звонки по очередям</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="data()?.byQueue || []" class="queue-table">
          <ng-container matColumnDef="queue">
            <th mat-header-cell *matHeaderCellDef>Очередь</th>
            <td mat-cell *matCellDef="let row">{{ row.queue }}</td>
          </ng-container>

          <ng-container matColumnDef="abandonedCount">
            <th mat-header-cell *matHeaderCellDef>Брошено</th>
            <td mat-cell *matCellDef="let row">{{ row.abandonedCount }}</td>
          </ng-container>

          <ng-container matColumnDef="totalCalls">
            <th mat-header-cell *matHeaderCellDef>Всего звонков</th>
            <td mat-cell *matCellDef="let row">{{ row.totalCalls }}</td>
          </ng-container>

          <ng-container matColumnDef="abandonRate">
            <th mat-header-cell *matHeaderCellDef>% отказа</th>
            <td mat-cell *matCellDef="let row">
              <span [ngClass]="getSeverityClass(row.abandonRate)">
                {{ row.abandonRate.toFixed(1) }}%
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="avgAbandonTime">
            <th mat-header-cell *matHeaderCellDef>Среднее время</th>
            <td mat-cell *matCellDef="let row">{{ formatTime(row.avgAbandonTime) }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsQueue"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsQueue"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="!loading() && !error() && !hasData()" class="no-data">
    Нет данных за выбранный период
  </div>
</div>
