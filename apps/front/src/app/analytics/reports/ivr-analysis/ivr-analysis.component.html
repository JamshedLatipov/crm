<div class="ivr-analysis-report">
  <app-report-filters (filtersChange)="onFiltersChange($event)" />

  <div *ngIf="loading()" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="error()" class="error-message">{{ error() }}</div>

  <div *ngIf="!loading() && !error() && hasData()" class="report-content">
    <div class="kpi-cards">
      <mat-card class="kpi-card">
        <mat-card-header><mat-card-title>Всего сессий IVR</mat-card-title></mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{ data()?.totalSessions || 0 }}</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card" [ngClass]="getCompletionClass(data()?.completionRate || 0)">
        <mat-card-header><mat-card-title>Завершено</mat-card-title></mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{ (data()?.completionRate || 0).toFixed(1) }}%</div>
          <div class="kpi-subtitle">{{ data()?.completedSessions || 0 }} звонков</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-header><mat-card-title>Среднее время в IVR</mat-card-title></mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{ formatTime(data()?.avgIvrDuration || 0) }}</div>
        </mat-card-content>
      </mat-card>
    </div>

    <div class="charts-row">
      <mat-card class="chart-card">
        <mat-card-header><mat-card-title>Топ 5 путей IVR</mat-card-title></mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas baseChart [data]="pathsChartData()" [options]="chartOptions" type="pie"></canvas>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-header><mat-card-title>DTMF выборы</mat-card-title></mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            <canvas baseChart [data]="dtmfChartData()" [options]="chartOptions" type="bar"></canvas>
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-card class="table-card">
      <mat-card-header><mat-card-title>Детальная статистика путей</mat-card-title></mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="data()?.paths || []">
          <ng-container matColumnDef="path">
            <th mat-header-cell *matHeaderCellDef>Путь</th>
            <td mat-cell *matCellDef="let row">{{ row.path }}</td>
          </ng-container>
          <ng-container matColumnDef="callCount">
            <th mat-header-cell *matHeaderCellDef>Звонков</th>
            <td mat-cell *matCellDef="let row">{{ row.callCount }}</td>
          </ng-container>
          <ng-container matColumnDef="percentage">
            <th mat-header-cell *matHeaderCellDef>%</th>
            <td mat-cell *matCellDef="let row">{{ row.percentage.toFixed(1) }}%</td>
          </ng-container>
          <ng-container matColumnDef="avgTimeInIvr">
            <th mat-header-cell *matHeaderCellDef>Среднее время</th>
            <td mat-cell *matCellDef="let row">{{ formatTime(row.avgTimeInIvr) }}</td>
          </ng-container>
          <ng-container matColumnDef="completionRate">
            <th mat-header-cell *matHeaderCellDef>Завершено</th>
            <td mat-cell *matCellDef="let row">
              <span [ngClass]="getCompletionClass(row.completionRate)">{{ row.completionRate.toFixed(1) }}%</span>
            </td>
          </ng-container>
          <tr mat-header-row *matHeaderRowDef="displayedColumnsPaths"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsPaths"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <div class="tables-row">
      <mat-card class="table-card">
        <mat-card-header><mat-card-title>Статистика узлов</mat-card-title></mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="data()?.nodes || []">
            <ng-container matColumnDef="nodeName">
              <th mat-header-cell *matHeaderCellDef>Узел</th>
              <td mat-cell *matCellDef="let row">{{ row.nodeName }}</td>
            </ng-container>
            <ng-container matColumnDef="visits">
              <th mat-header-cell *matHeaderCellDef>Посещений</th>
              <td mat-cell *matCellDef="let row">{{ row.visits }}</td>
            </ng-container>
            <ng-container matColumnDef="exitCount">
              <th mat-header-cell *matHeaderCellDef>Выходов</th>
              <td mat-cell *matCellDef="let row">{{ row.exitCount }}</td>
            </ng-container>
            <ng-container matColumnDef="exitRate">
              <th mat-header-cell *matHeaderCellDef>% выхода</th>
              <td mat-cell *matCellDef="let row">{{ row.exitRate.toFixed(1) }}%</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="displayedColumnsNodes"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsNodes"></tr>
          </table>
        </mat-card-content>
      </mat-card>

      <mat-card class="table-card">
        <mat-card-header><mat-card-title>DTMF детализация</mat-card-title></mat-card-header>
        <mat-card-content>
          <table mat-table [dataSource]="data()?.dtmfSelections || []">
            <ng-container matColumnDef="digit">
              <th mat-header-cell *matHeaderCellDef>Цифра</th>
              <td mat-cell *matCellDef="let row">{{ row.digit }}</td>
            </ng-container>
            <ng-container matColumnDef="nodeName">
              <th mat-header-cell *matHeaderCellDef>Узел</th>
              <td mat-cell *matCellDef="let row">{{ row.nodeName }}</td>
            </ng-container>
            <ng-container matColumnDef="count">
              <th mat-header-cell *matHeaderCellDef>Количество</th>
              <td mat-cell *matCellDef="let row">{{ row.count }}</td>
            </ng-container>
            <ng-container matColumnDef="percentage">
              <th mat-header-cell *matHeaderCellDef>%</th>
              <td mat-cell *matCellDef="let row">{{ row.percentage.toFixed(1) }}%</td>
            </ng-container>
            <tr mat-header-row *matHeaderRowDef="displayedColumnsDtmf"></tr>
            <tr mat-row *matRowDef="let row; columns: displayedColumnsDtmf"></tr>
          </table>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <div *ngIf="!loading() && !error() && !hasData()" class="no-data">
    Нет данных за выбранный период
  </div>
</div>
