<div class="conversion-container">
  <app-report-filters (filtersChange)="onFiltersChange($event)"></app-report-filters>

  @if (data(); as conversion) {
    <div class="content-wrapper">
    <!-- KPI Cards -->
    <div class="kpi-grid">
      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Total Calls</div>
          <div class="kpi-value">{{ conversion.totalCalls }}</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Lead Conversion Rate</div>
          <div class="kpi-value">{{ conversion.leadConversionRate.toFixed(1) }}%</div>
          <div class="kpi-detail">{{ conversion.callsWithLeads }} calls</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Deal Conversion Rate</div>
          <div class="kpi-value">{{ conversion.dealConversionRate.toFixed(1) }}%</div>
          <div class="kpi-detail">{{ conversion.callsWithDeals }} deals</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Total Revenue</div>
          <div class="kpi-value">{{ formatCurrency(conversion.totalRevenue) }}</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Average Revenue per Deal</div>
          <div class="kpi-value">{{ formatCurrency(conversion.avgRevenue) }}</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-content>
          <div class="kpi-label">Revenue per Call (ROI)</div>
          <div class="kpi-value">{{ formatCurrency(conversion.revenuePerCall) }}</div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Charts Row -->
    <div class="charts-row">
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Agent Performance with Revenue</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            @if (agentChartData) {
              <canvas
                baseChart
                [data]="agentChartData"
                [options]="agentChartOptions"
                type="bar">
              </canvas>
            }
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Conversion Trend</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container">
            @if (trendChartData) {
              <canvas
                baseChart
                [data]="trendChartData"
                [options]="trendChartOptions"
                type="line">
              </canvas>
            }
          </div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Deal Stages Pie Chart -->
    @if (conversion.dealStages.length > 0) {
      <mat-card class="chart-card">
        <mat-card-header>
          <mat-card-title>Deal Stages Distribution</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="chart-container-small">
            @if (dealStageChartData) {
              <canvas
                baseChart
                [data]="dealStageChartData"
                [options]="dealStageChartOptions"
                type="pie">
              </canvas>
            }
          </div>
        </mat-card-content>
      </mat-card>
    }

    <!-- Agent Details Table -->
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Agent Conversion Details</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="conversion.byAgent" class="full-width-table">
            <ng-container matColumnDef="agent">
              <th mat-header-cell *matHeaderCellDef>Agent</th>
              <td mat-cell *matCellDef="let row">{{ row.agent }}</td>
            </ng-container>

            <ng-container matColumnDef="totalCalls">
              <th mat-header-cell *matHeaderCellDef>Total Calls</th>
              <td mat-cell *matCellDef="let row">{{ row.totalCalls }}</td>
            </ng-container>

            <ng-container matColumnDef="callsWithLeads">
              <th mat-header-cell *matHeaderCellDef>Calls → Leads</th>
              <td mat-cell *matCellDef="let row">{{ row.callsWithLeads }}</td>
            </ng-container>

            <ng-container matColumnDef="callsWithDeals">
              <th mat-header-cell *matHeaderCellDef>Calls → Deals</th>
              <td mat-cell *matCellDef="let row">{{ row.callsWithDeals }}</td>
            </ng-container>

            <ng-container matColumnDef="leadConversionRate">
              <th mat-header-cell *matHeaderCellDef>Lead Conv. %</th>
              <td mat-cell *matCellDef="let row">{{ row.leadConversionRate.toFixed(1) }}%</td>
            </ng-container>

            <ng-container matColumnDef="dealConversionRate">
              <th mat-header-cell *matHeaderCellDef>Deal Conv. %</th>
              <td mat-cell *matCellDef="let row">{{ row.dealConversionRate.toFixed(1) }}%</td>
            </ng-container>

            <ng-container matColumnDef="totalRevenue">
              <th mat-header-cell *matHeaderCellDef>Total Revenue</th>
              <td mat-cell *matCellDef="let row">{{ formatCurrency(row.totalRevenue) }}</td>
            </ng-container>

            <ng-container matColumnDef="avgRevenue">
              <th mat-header-cell *matHeaderCellDef>Avg Revenue</th>
              <td mat-cell *matCellDef="let row">{{ formatCurrency(row.avgRevenue) }}</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="agentColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: agentColumns"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Trend Details Table -->
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Conversion Trend Details (Last 30 Days)</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="table-container">
          <table mat-table [dataSource]="conversion.trend.slice(-30)" class="full-width-table">
            <ng-container matColumnDef="date">
              <th mat-header-cell *matHeaderCellDef>Date</th>
              <td mat-cell *matCellDef="let row">{{ row.date | date:'dd.MM.yyyy' }}</td>
            </ng-container>

            <ng-container matColumnDef="totalCalls">
              <th mat-header-cell *matHeaderCellDef>Total Calls</th>
              <td mat-cell *matCellDef="let row">{{ row.totalCalls }}</td>
            </ng-container>

            <ng-container matColumnDef="callsWithLeads">
              <th mat-header-cell *matHeaderCellDef>Calls → Leads</th>
              <td mat-cell *matCellDef="let row">{{ row.callsWithLeads }}</td>
            </ng-container>

            <ng-container matColumnDef="callsWithDeals">
              <th mat-header-cell *matHeaderCellDef>Calls → Deals</th>
              <td mat-cell *matCellDef="let row">{{ row.callsWithDeals }}</td>
            </ng-container>

            <ng-container matColumnDef="leadConversionRate">
              <th mat-header-cell *matHeaderCellDef>Lead Conv. %</th>
              <td mat-cell *matCellDef="let row">{{ row.leadConversionRate.toFixed(1) }}%</td>
            </ng-container>

            <ng-container matColumnDef="dealConversionRate">
              <th mat-header-cell *matHeaderCellDef>Deal Conv. %</th>
              <td mat-cell *matCellDef="let row">{{ row.dealConversionRate.toFixed(1) }}%</td>
            </ng-container>

            <tr mat-header-row *matHeaderRowDef="trendColumns"></tr>
            <tr mat-row *matRowDef="let row; columns: trendColumns"></tr>
          </table>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Deal Stages Table -->
    @if (conversion.dealStages.length > 0) {
      <mat-card class="table-card">
        <mat-card-header>
          <mat-card-title>Deal Stages Breakdown</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="table-container">
            <table mat-table [dataSource]="conversion.dealStages" class="full-width-table">
              <ng-container matColumnDef="status">
                <th mat-header-cell *matHeaderCellDef>Status</th>
                <td mat-cell *matCellDef="let row">{{ row.status }}</td>
              </ng-container>

              <ng-container matColumnDef="count">
                <th mat-header-cell *matHeaderCellDef>Count</th>
                <td mat-cell *matCellDef="let row">{{ row.count }}</td>
              </ng-container>

              <ng-container matColumnDef="totalValue">
                <th mat-header-cell *matHeaderCellDef>Total Value</th>
                <td mat-cell *matCellDef="let row">{{ formatCurrency(row.totalValue) }}</td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="dealStageColumns"></tr>
              <tr mat-row *matRowDef="let row; columns: dealStageColumns"></tr>
            </table>
          </div>
        </mat-card-content>
      </mat-card>
    }
    </div>
  } @else {
    @if (loading()) {
      <div class="loading-container">
        <mat-spinner></mat-spinner>
      </div>
    } @else if (error()) {
      <mat-card class="error-card">
        <mat-card-content>
          <p class="error-message">{{ error() }}</p>
        </mat-card-content>
      </mat-card>
    }
  }
</div>
