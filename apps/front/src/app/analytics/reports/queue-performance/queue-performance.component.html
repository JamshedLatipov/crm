<div class="queue-performance-report">
  <app-report-filters (filtersChange)="onFiltersChange($event)" />

  <div *ngIf="loading()" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="error()" class="error-message">
    {{ error() }}
  </div>

  <div *ngIf="!loading() && !error() && hasData()" class="report-content">
    <!-- Summary KPIs -->
    <div class="kpi-cards">
      <mat-card class="kpi-card">
        <mat-card-header>
          <mat-card-title>Всего звонков</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{ data()?.totalCalls || 0 }}</div>
          <div class="kpi-subtitle">во всех очередях</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card" [ngClass]="getAnswerRateClass(data()?.overallAnswerRate || 0)">
        <mat-card-header>
          <mat-card-title>Общий процент ответов</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{ (data()?.overallAnswerRate || 0).toFixed(1) }}%</div>
          <div class="kpi-subtitle">целевой показатель &gt; 85%</div>
        </mat-card-content>
      </mat-card>

      <mat-card class="kpi-card">
        <mat-card-header>
          <mat-card-title>Среднее время ожидания</mat-card-title>
        </mat-card-header>
        <mat-card-content>
          <div class="kpi-value">{{ formatTime(data()?.overallAvgWaitTime || 0) }}</div>
          <div class="kpi-subtitle">все очереди</div>
        </mat-card-content>
      </mat-card>
    </div>

    <!-- Hourly Chart -->
    <mat-card class="chart-card">
      <mat-card-header>
        <mat-card-title>Распределение звонков по часам</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <div class="chart-container">
          <canvas
            baseChart
            [data]="hourlyChartData()"
            [options]="hourlyChartOptions"
            type="bar"
          ></canvas>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Queue Statistics Table -->
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Статистика по очередям</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="data()?.queueStats || []" class="stats-table">
          <ng-container matColumnDef="queue">
            <th mat-header-cell *matHeaderCellDef>Очередь</th>
            <td mat-cell *matCellDef="let row">{{ row.queue }}</td>
          </ng-container>

          <ng-container matColumnDef="totalCalls">
            <th mat-header-cell *matHeaderCellDef>Всего</th>
            <td mat-cell *matCellDef="let row">{{ row.totalCalls }}</td>
          </ng-container>

          <ng-container matColumnDef="answeredCalls">
            <th mat-header-cell *matHeaderCellDef>Отвечено</th>
            <td mat-cell *matCellDef="let row">{{ row.answeredCalls }}</td>
          </ng-container>

          <ng-container matColumnDef="abandonedCalls">
            <th mat-header-cell *matHeaderCellDef>Брошено</th>
            <td mat-cell *matCellDef="let row">{{ row.abandonedCalls }}</td>
          </ng-container>

          <ng-container matColumnDef="answerRate">
            <th mat-header-cell *matHeaderCellDef>% ответов</th>
            <td mat-cell *matCellDef="let row">
              <span [ngClass]="getAnswerRateClass(row.answerRate)">
                {{ row.answerRate.toFixed(1) }}%
              </span>
            </td>
          </ng-container>

          <ng-container matColumnDef="avgWaitTime">
            <th mat-header-cell *matHeaderCellDef>Ср. ожидание</th>
            <td mat-cell *matCellDef="let row">{{ formatTime(row.avgWaitTime) }}</td>
          </ng-container>

          <ng-container matColumnDef="maxWaitTime">
            <th mat-header-cell *matHeaderCellDef>Макс. ожидание</th>
            <td mat-cell *matCellDef="let row">{{ formatTime(row.maxWaitTime) }}</td>
          </ng-container>

          <ng-container matColumnDef="avgTalkTime">
            <th mat-header-cell *matHeaderCellDef>Ср. разговор</th>
            <td mat-cell *matCellDef="let row">{{ formatTime(row.avgTalkTime) }}</td>
          </ng-container>

          <ng-container matColumnDef="serviceLevelCompliance">
            <th mat-header-cell *matHeaderCellDef>SLA %</th>
            <td mat-cell *matCellDef="let row">
              <span [ngClass]="getSlaClass(row.serviceLevelCompliance)">
                {{ row.serviceLevelCompliance.toFixed(1) }}%
              </span>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsQueue"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsQueue"></tr>
        </table>
      </mat-card-content>
    </mat-card>

    <!-- Top Agents Table -->
    <mat-card class="table-card">
      <mat-card-header>
        <mat-card-title>Топ операторов по очередям</mat-card-title>
      </mat-card-header>
      <mat-card-content>
        <table mat-table [dataSource]="data()?.topAgents || []" class="agents-table">
          <ng-container matColumnDef="queue">
            <th mat-header-cell *matHeaderCellDef>Очередь</th>
            <td mat-cell *matCellDef="let row">{{ row.queue }}</td>
          </ng-container>

          <ng-container matColumnDef="agent">
            <th mat-header-cell *matHeaderCellDef>Оператор</th>
            <td mat-cell *matCellDef="let row">{{ row.agent }}</td>
          </ng-container>

          <ng-container matColumnDef="callsHandled">
            <th mat-header-cell *matHeaderCellDef>Обработано звонков</th>
            <td mat-cell *matCellDef="let row">{{ row.callsHandled }}</td>
          </ng-container>

          <ng-container matColumnDef="avgHandleTime">
            <th mat-header-cell *matHeaderCellDef>Среднее время обработки</th>
            <td mat-cell *matCellDef="let row">{{ formatTime(row.avgHandleTime) }}</td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumnsAgents"></tr>
          <tr mat-row *matRowDef="let row; columns: displayedColumnsAgents"></tr>
        </table>
      </mat-card-content>
    </mat-card>
  </div>

  <div *ngIf="!loading() && !error() && !hasData()" class="no-data">
    Нет данных за выбранный период
  </div>
</div>
