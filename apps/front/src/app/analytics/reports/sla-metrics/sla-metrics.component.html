<div class="sla-metrics-container">
  <mat-card>
    <mat-card-header>
      <mat-card-title>
        <h2>SLA метрики</h2>
      </mat-card-title>
    </mat-card-header>

    <mat-card-content>
      <app-report-filters (filtersChange)="onFiltersChange($event)"></app-report-filters>

      <div *ngIf="!loading() && !error() && data()" class="content">
        <!-- KPI Cards -->
        <div class="kpi-grid">
          <div class="kpi-card" [ngClass]="getComplianceClass(data()!.slaComplianceRate)">
            <mat-icon>verified</mat-icon>
            <div class="kpi-value">{{ data()!.slaComplianceRate.toFixed(1) }}%</div>
            <div class="kpi-label">SLA соответствие</div>
            <div class="kpi-detail">
              {{ data()!.slaCompliantCalls }} из {{ data()!.totalCalls }}
            </div>
          </div>

          <div class="kpi-card success">
            <mat-icon>check_circle</mat-icon>
            <div class="kpi-value">{{ data()!.slaCompliantCalls }}</div>
            <div class="kpi-label">Успешных звонков</div>
          </div>

          <div class="kpi-card danger">
            <mat-icon>error</mat-icon>
            <div class="kpi-value">{{ data()!.slaViolatedCalls }}</div>
            <div class="kpi-label">Нарушений SLA</div>
          </div>

          <div class="kpi-card info">
            <mat-icon>schedule</mat-icon>
            <div class="kpi-value">{{ formatTime(data()!.avgFirstResponseTime) }}</div>
            <div class="kpi-label">Ср. время до ответа</div>
          </div>

          <div class="kpi-card warning">
            <mat-icon>phone_disabled</mat-icon>
            <div class="kpi-value">{{ data()!.abandonedCallsCount }}</div>
            <div class="kpi-label">Брошенных звонков</div>
            <div class="kpi-detail">{{ data()!.abandonRate.toFixed(1) }}%</div>
          </div>

          <div class="kpi-card info">
            <mat-icon>timer_off</mat-icon>
            <div class="kpi-value">{{ formatTime(data()!.avgAbandonTime) }}</div>
            <div class="kpi-label">Ср. время доброса</div>
          </div>
        </div>

        <!-- Trend Chart -->
        <mat-card class="chart-card">
          <mat-card-header>
            <mat-card-title>Динамика SLA соответствия</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <canvas
              *ngIf="getTrendChartData()"
              baseChart
              [type]="'line'"
              [data]="getTrendChartData()!"
              [options]="lineChartOptions"
            ></canvas>
            <div *ngIf="!getTrendChartData()" class="no-data">
              <p>Недостаточно данных для графика</p>
            </div>
          </mat-card-content>
        </mat-card>

        <!-- Queue Table -->
        <mat-card class="table-card">
          <mat-card-header>
            <mat-card-title>SLA по очередям</mat-card-title>
          </mat-card-header>
          <mat-card-content>
            <div class="table-container" *ngIf="data()!.byQueue.length > 0">
              <table mat-table [dataSource]="data()!.byQueue" class="queue-table">
                <ng-container matColumnDef="queue">
                  <th mat-header-cell *matHeaderCellDef>Очередь</th>
                  <td mat-cell *matCellDef="let row">{{ row.queue }}</td>
                </ng-container>

                <ng-container matColumnDef="totalCalls">
                  <th mat-header-cell *matHeaderCellDef>Всего звонков</th>
                  <td mat-cell *matCellDef="let row">{{ row.totalCalls }}</td>
                </ng-container>

                <ng-container matColumnDef="compliantCalls">
                  <th mat-header-cell *matHeaderCellDef>Соответствует SLA</th>
                  <td mat-cell *matCellDef="let row" class="success">
                    {{ row.compliantCalls }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="violatedCalls">
                  <th mat-header-cell *matHeaderCellDef>Нарушений</th>
                  <td mat-cell *matCellDef="let row" class="danger">
                    {{ row.violatedCalls }}
                  </td>
                </ng-container>

                <ng-container matColumnDef="complianceRate">
                  <th mat-header-cell *matHeaderCellDef>Соответствие</th>
                  <td mat-cell *matCellDef="let row">
                    <span class="compliance-badge" [ngClass]="getComplianceClass(row.complianceRate)">
                      {{ row.complianceRate.toFixed(1) }}%
                    </span>
                  </td>
                </ng-container>

                <ng-container matColumnDef="avgWaitTime">
                  <th mat-header-cell *matHeaderCellDef>Ср. ожидание</th>
                  <td mat-cell *matCellDef="let row">
                    {{ formatTime(row.avgWaitTime) }}
                  </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns"></tr>
              </table>
            </div>

            <div *ngIf="data()!.byQueue.length === 0" class="no-data">
              <mat-icon>info</mat-icon>
              <p>Нет данных по очередям</p>
            </div>
          </mat-card-content>
        </mat-card>
      </div>

      <div *ngIf="loading()" class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Загрузка данных...</p>
      </div>

      <div *ngIf="error()" class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error() }}</p>
      </div>
    </mat-card-content>
  </mat-card>
</div>
