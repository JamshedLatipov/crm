<div class="pipeline-root">
  <h2>Sales Pipeline</h2>

  <div class="pipeline-toolbar">
    <button (click)="triggerAutomation()">Run Automation</button>
    <button (click)="load()">Refresh</button>
  </div>

  <div class="pipeline-forms">
    <div class="form-block">
      <h4>Создать этап</h4>
      <input placeholder="Название этапа" [(ngModel)]="newStageName" />
      <button (click)="createStage()">Создать</button>
    </div>
  </div>

  <div class="pipeline-grid">
    <div *ngFor="let s of stages" class="stage">
      <h3>{{ s.name }}</h3>
      <div class="deals" cdkDropList [id]="'stage-'+s.id" [class.drag-over]="activeDropListId === 'stage-'+s.id" [cdkDropListConnectedTo]="getConnectedListIds()" [cdkDropListData]="getDealsForStage(s.id)" (cdkDropListDropped)="dropToStage($event, s.id)" (cdkDropListEntered)="onDropListEntered($event, s.id)" (cdkDropListExited)="onDropListExited($event, s.id)">
        <ng-container *ngFor="let deal of getDealsForStage(s.id)">
          <div class="deal" cdkDrag [cdkDragData]="deal">
            <div class="deal-title">{{ deal.title }}</div>
            <div class="deal-contact" *ngIf="deal.contact">{{ deal.contact.name }}</div>
            <div class="deal-company" *ngIf="deal.company">{{ deal.company.name }}</div>
            <div class="deal-lead" *ngIf="deal.lead">Лид: {{ deal.lead.name }}</div>
            <div class="deal-amount">{{ deal.amount | currency:deal.currency:'symbol':'1.0-0' }}</div>
            <div class="deal-probability">{{ deal.probability }}% вероятность</div>
            <div class="deal-date">{{ deal.expectedCloseDate | date:'shortDate' }}</div>
          </div>
        </ng-container>
      </div>
    </div>
  </div>

  <div class="analytics" *ngIf="analytics && analytics.byStage">
    <h3>Analytics</h3>
    <div *ngFor="let b of analytics.byStage">
      {{ b.name }}: {{ b.count }} leads — {{ b.conversion }}%
    </div>
  </div>
</div>
