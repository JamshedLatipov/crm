<div class="pipeline-page">
  <!-- Page Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Pipeline продаж</h1>
      <p class="subtitle">Управление сделками и процессом продаж</p>
    </div>
    <div class="header-actions">
      <button (click)="openAnalytics()"
              [disabled]="isLoadingAnalytics()"
              class="action-btn analytics-btn">
        <mat-icon *ngIf="!isLoadingAnalytics()">analytics</mat-icon>
        <mat-icon *ngIf="isLoadingAnalytics()" class="animate-spin">refresh</mat-icon>
        <span>{{ isLoadingAnalytics() ? 'Загрузка...' : 'Аналитика' }}</span>
      </button>
      <button (click)="triggerAutomation()" class="action-btn automation-btn">
        <mat-icon>play_arrow</mat-icon>
        <span>Автоматизация</span>
      </button>
      <button (click)="load()" class="action-btn refresh-btn" [disabled]="isLoadingData()">
        <mat-icon [class.animate-spin]="isLoadingData()">refresh</mat-icon>
        <span>Обновить</span>
      </button>
      <button mat-raised-button color="primary" (click)="createStage()" class="create-btn">
        <mat-icon>add</mat-icon>
        <span>Добавить этап</span>
      </button>
    </div>
  </div>

  <!-- Filters Panel -->
  <div class="filters-panel">
    <div class="filter-group">
      <mat-icon>search</mat-icon>
      <input type="text" 
             placeholder="Поиск сделок..." 
             [value]="searchQuery()"
             (input)="searchQuery.set($any($event.target).value)"
             class="search-input">
    </div>
    
    <div class="filter-group">
      <mat-icon>filter_list</mat-icon>
      <select [value]="statusFilter()" 
              (change)="statusFilter.set($any($event.target).value)"
              class="filter-select">
        <option value="all">Все статусы</option>
        <option value="open">Открытые</option>
        <option value="won">Выиграны</option>
        <option value="lost">Проиграны</option>
      </select>
    </div>
    
    <div *ngIf="filteredDeals().length !== deals().length" class="filter-results">
      Показано: {{ filteredDeals().length }} из {{ deals().length }}
    </div>
    
    <div *ngIf="useVirtualScroll()" class="virtual-scroll-indicator" matTooltip="Виртуальный скроллинг активен для оптимизации производительности">
      <mat-icon>flash_on</mat-icon>
      <span>Быстрый режим</span>
    </div>
    
    <button *ngIf="searchQuery() || statusFilter() !== 'all'" 
            (click)="resetFilters()" 
            class="clear-filters-btn"
            matTooltip="Сбросить фильтры">
      <mat-icon>clear</mat-icon>
      Сбросить
    </button>
  </div>

  <!-- Pipeline Container -->
  <div class="pipeline-container">
    <div class="pipeline-grid" #pipelineGrid>
      <div *ngFor="let s of stages()" class="stage" [id]="'stage-' + s.id"
           [class.won-stage]="s.type === 'won_stage'"
           [class.lost-stage]="s.type === 'lost_stage'">
        <div class="stage-header">
          <h3 class="flex items-center gap-2">
            {{ s.name }}
            <span *ngIf="s.type === 'won_stage'" class="px-2 py-1 text-xs bg-green-100 text-green-800 rounded">Won</span>
            <span *ngIf="s.type === 'lost_stage'" class="px-2 py-1 text-xs bg-red-100 text-red-800 rounded">Lost</span>
          </h3>
          <span class="stage-count">{{ getDealsForStage(s.id).length }}</span>
        </div>
        
        <!-- Virtual Scrolling для больших списков -->
        <cdk-virtual-scroll-viewport 
          *ngIf="useVirtualScroll() && getDealsForStage(s.id).length > VIRTUAL_SCROLL_THRESHOLD"
          [itemSize]="VIRTUAL_SCROLL_ITEM_SIZE"
          class="deals deals-virtual"
          cdkDropList 
          [id]="'stage-'+s.id" 
          [class.drag-over]="activeDropListId() === 'stage-'+s.id" 
          [cdkDropListConnectedTo]="getConnectedListIds()" 
          [cdkDropListData]="getDealsForStage(s.id)" 
          (cdkDropListDropped)="dropToStage($event, s.id)" 
          (cdkDropListEntered)="onDropListEntered($event, s.id)" 
          (cdkDropListExited)="onDropListExited($event, s.id)">
          <div *cdkVirtualFor="let deal of getDealsForStage(s.id)" 
               class="deal" 
               cdkDrag 
               [cdkDragData]="deal"
               (cdkDragStarted)="onDragStarted()"
               (cdkDragEnded)="onDragEnded()">
            <div class="deal-header">
              <div class="deal-title">{{ deal.title }}</div>
              <div class="deal-actions">
                <button mat-icon-button 
                        class="contact-action-btn"
                        [title]="deal.contact ? 'Изменить контакт' : 'Добавить контакт'"
                        (click)="openContactSelector(deal, $event)">
                  <mat-icon>{{ deal.contact ? 'person' : 'person_add' }}</mat-icon>
                </button>
              </div>
            </div>
            <div class="deal-status-row">
              <app-deal-status 
                [status]="getDealStatus(deal)" 
                size="small"
                [showIndicators]="true"
                [isOverdue]="isOverdue(deal)"
                [isHighValue]="isHighValue(deal)">
              </app-deal-status>
            </div>
            <div class="deal-contact" *ngIf="deal.contact">
              <mat-icon>person</mat-icon>
              {{ deal.contact.name }}
            </div>
            <div class="deal-company" *ngIf="deal.company">
              <mat-icon>business</mat-icon>
              {{ deal.company.name }}
            </div>
            <div class="deal-lead" *ngIf="deal.lead">
              <mat-icon>contacts</mat-icon>
              Лид: {{ deal.lead.name }}
            </div>
            <div class="deal-amount">{{ deal.amount | currency:deal.currency:'symbol':'1.0-0' }}</div>
            <div class="deal-probability">{{ deal.probability }}% вероятность</div>
            <div class="deal-date">{{ deal.expectedCloseDate | date:'shortDate' }}</div>
          </div>
        </cdk-virtual-scroll-viewport>
        
        <!-- Обычный скроллинг для небольших списков -->
        <div *ngIf="!useVirtualScroll() || getDealsForStage(s.id).length <= VIRTUAL_SCROLL_THRESHOLD"
             class="deals" 
             cdkDropList 
             [id]="'stage-'+s.id" 
             [class.drag-over]="activeDropListId() === 'stage-'+s.id" 
             [cdkDropListConnectedTo]="getConnectedListIds()" 
             [cdkDropListData]="getDealsForStage(s.id)" 
             (cdkDropListDropped)="dropToStage($event, s.id)" 
             (cdkDropListEntered)="onDropListEntered($event, s.id)" 
             (cdkDropListExited)="onDropListExited($event, s.id)">
          <ng-container *ngFor="let deal of getDealsForStage(s.id)">
            <div class="deal" 
                 cdkDrag 
                 [cdkDragData]="deal"
                 (cdkDragStarted)="onDragStarted()"
                 (cdkDragEnded)="onDragEnded()">
              <div class="deal-header">
                <div class="deal-title">{{ deal.title }}</div>
                <div class="deal-actions">
                  <button mat-icon-button 
                          class="contact-action-btn"
                          [title]="deal.contact ? 'Изменить контакт' : 'Добавить контакт'"
                          (click)="openContactSelector(deal, $event)">
                    <mat-icon>{{ deal.contact ? 'person' : 'person_add' }}</mat-icon>
                  </button>
                </div>
              </div>
              <div class="deal-status-row">
                <app-deal-status 
                  [status]="getDealStatus(deal)" 
                  size="small"
                  [showIndicators]="true"
                  [isOverdue]="isOverdue(deal)"
                  [isHighValue]="isHighValue(deal)">
                </app-deal-status>
              </div>
              <div class="deal-contact" *ngIf="deal.contact">
                <mat-icon>person</mat-icon>
                {{ deal.contact.name }}
              </div>
              <div class="deal-company" *ngIf="deal.company">
                <mat-icon>business</mat-icon>
                {{ deal.company.name }}
              </div>
              <div class="deal-lead" *ngIf="deal.lead">
                <mat-icon>contacts</mat-icon>
                Лид: {{ deal.lead.name }}
              </div>
              <div class="deal-amount">{{ deal.amount | currency:deal.currency:'symbol':'1.0-0' }}</div>
              <div class="deal-probability">{{ deal.probability }}% вероятность</div>
              <div class="deal-date">{{ deal.expectedCloseDate | date:'shortDate' }}</div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>
</div>
