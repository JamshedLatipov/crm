<div class="pipeline-root">
  <div class="flex items-center justify-between">
    <div>
      <h1 class="text-[32px] font-bold leading-tight tracking-tighter">Sales Pipeline</h1>
      <p class="mt-1 text-base font-normal text-[#9eb7a8]">Drag and drop to customize your sales process.</p>
    </div>
    <div class="flex items-center gap-2">
      <button (click)="triggerAutomation()" class="px-3 py-2 rounded-full  border border-[#3d5245]">Run Automation</button>
      <button (click)="load()" class="px-3 py-2 rounded-full  border border-[#3d5245]">Refresh</button>
      <button mat-raised-button color="primary" (click)="createStage()" class="flex items-center gap-2 px-4 py-2 text-sm font-bold">
        <mat-icon>add</mat-icon>
        <span>Добавить этап</span>
      </button>
    </div>
  </div>

  <div class="mt-6">
    <div class="pipeline-grid">
      <div *ngFor="let s of stages" class="stage">
        <h3>{{ s.name }}</h3>
        <div class="deals" cdkDropList [id]="'stage-'+s.id" [class.drag-over]="activeDropListId === 'stage-'+s.id" [cdkDropListConnectedTo]="getConnectedListIds()" [cdkDropListData]="getDealsForStage(s.id)" (cdkDropListDropped)="dropToStage($event, s.id)" (cdkDropListEntered)="onDropListEntered($event, s.id)" (cdkDropListExited)="onDropListExited($event, s.id)">
          <ng-container *ngFor="let deal of getDealsForStage(s.id)">
            <div class="deal" cdkDrag [cdkDragData]="deal">
              <div class="deal-title">{{ deal.title }}</div>
              <div class="deal-contact" *ngIf="deal.contact">{{ deal.contact.name }}</div>
              <div class="deal-company" *ngIf="deal.company">{{ deal.company.name }}</div>
              <div class="deal-lead" *ngIf="deal.lead">Лид: {{ deal.lead.name }}</div>
              <div class="deal-amount">{{ deal.amount | currency:deal.currency:'symbol':'1.0-0' }}</div>
              <div class="deal-probability">{{ deal.probability }}% вероятность</div>
              <div class="deal-date">{{ deal.expectedCloseDate | date:'shortDate' }}</div>
            </div>
          </ng-container>
        </div>
      </div>
    </div>
  </div>

  <div class="analytics" *ngIf="analytics && analytics.byStage">
    <h3>Analytics</h3>
    <div *ngFor="let b of analytics.byStage">
      {{ b.name }}: {{ b.count }} leads — {{ b.conversion }}%
    </div>
  </div>
</div>
