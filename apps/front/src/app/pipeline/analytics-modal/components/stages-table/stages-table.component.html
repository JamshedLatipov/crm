<div class="table-container" *ngIf="stages?.length">
  <table mat-table [dataSource]="stages" class="analytics-table">

    <ng-container matColumnDef="name">
      <th mat-header-cell *matHeaderCellDef>Этап</th>
      <td mat-cell *matCellDef="let stage; let i = index" class="stage-name-cell">
        <div class="stage-info">
          <div class="stage-color" [style.background-color]="getFunnelColor(i)"></div>
          <span class="stage-name">{{ stage.name }}</span>
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="count">
      <th mat-header-cell *matHeaderCellDef>Сделок</th>
      <td mat-cell *matCellDef="let stage" class="count-cell">
        <div class="count-badge">{{ stage.count }}</div>
      </td>
    </ng-container>

    <ng-container matColumnDef="totalAmount">
      <th mat-header-cell *matHeaderCellDef>Общая сумма</th>
      <td mat-cell *matCellDef="let stage" class="amount-cell">
        {{ stage.totalAmount ? (stage.totalAmount | currency : 'RUB' : 'symbol' : '1.0-0') : '—' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="averageAmount">
      <th mat-header-cell *matHeaderCellDef>Средний чек</th>
      <td mat-cell *matCellDef="let stage" class="amount-cell">
        {{ stage.averageAmount ? (stage.averageAmount | currency : 'RUB' : 'symbol' : '1.0-0') : '—' }}
      </td>
    </ng-container>

    <ng-container matColumnDef="conversion">
      <th mat-header-cell *matHeaderCellDef>Конверсия</th>
      <td mat-cell *matCellDef="let stage" class="conversion-cell">
        <div class="conversion-badge" [ngClass]="{ 'high': stage.conversion>=80, 'medium-high': stage.conversion>=60 && stage.conversion<80, 'medium': stage.conversion>=40 && stage.conversion<60, 'low': stage.conversion<40 }">
          {{ stage.conversion }}%
        </div>
      </td>
    </ng-container>

    <ng-container matColumnDef="averageTimeInStage">
      <th mat-header-cell *matHeaderCellDef>Время в этапе</th>
      <td mat-cell *matCellDef="let stage" class="time-cell">
        {{ stage.averageTimeInStage ? stage.averageTimeInStage + ' дней' : '—' }}
      </td>
    </ng-container>

    <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
    <tr mat-row *matRowDef="let row; columns: displayedColumns" class="table-row"></tr>
  </table>
</div>
