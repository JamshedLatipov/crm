<div class="managers-analysis">
  <div class="header">
    <h3>Анализ по менеджерам</h3>
    <p class="subtitle">Сравнение эффективности работы менеджеров по продажам</p>
  </div>

  <!-- Карточки с ключевыми метриками -->
  <div class="metrics-cards" *ngIf="getTopPerformer() as topPerformer">
    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-icon">
          <mat-icon>emoji_events</mat-icon>
        </div>
        <div class="metric-content">
          <div class="metric-value">{{ topPerformer.managerName }}</div>
          <div class="metric-label">Лучший менеджер</div>
          <div class="metric-subtext">{{ topPerformer.conversionRate | number:'1.0-1' }}% конверсии</div>
        </div>
      </mat-card-content>
    </mat-card>

    <mat-card class="metric-card">
      <mat-card-content>
        <div class="metric-icon">
          <mat-icon>group</mat-icon>
        </div>
        <div class="metric-content">
          <div class="metric-value">{{ managersStats.length }}</div>
          <div class="metric-label">Активных менеджеров</div>
          <div class="metric-subtext">Средняя конверсия: {{ getAverageConversion() | number:'1.0-1' }}%</div>
        </div>
      </mat-card-content>
    </mat-card>
  </div>

  <!-- Таблица с деталями через crm-table -->
  <div class="table-container" *ngIf="!isLoading">
    <crm-table
      [columns]="columns"
      [data]="managersStats"
      [pageSize]="10"
      [pageSizeOptions]="[5, 10, 25]"
      [showPaginator]="true"
    >
      <!-- Template для общей суммы -->
      <ng-template crmColumnTemplate="totalAmount" let-row>
        <div class="amount-cell">
          {{ formatCurrency(row.totalAmount) }}
        </div>
      </ng-template>

      <!-- Template для средней суммы -->
      <ng-template crmColumnTemplate="averageAmount" let-row>
        <div class="amount-cell secondary">
          {{ formatCurrency(row.averageAmount) }}
        </div>
      </ng-template>

      <!-- Template для конверсии -->
      <ng-template crmColumnTemplate="conversionRate" let-row>
        <div class="conversion-cell">
          <div class="conversion-rate" [ngClass]="getConversionColor(row.conversionRate)">
            {{ row.conversionRate | number:'1.0-1' }}%
          </div>
          <mat-progress-bar
            mode="determinate"
            [value]="row.conversionRate"
            [ngClass]="getConversionColor(row.conversionRate)">
          </mat-progress-bar>
        </div>
      </ng-template>

      <!-- Template для показателя производительности -->
      <ng-template crmColumnTemplate="performance" let-row>
        <mat-chip
          [ngClass]="getPerformanceIndicator(row)"
          class="performance-chip"
        >
          <mat-icon>
            {{ getPerformanceIndicator(row) === 'excellent' ? 'star' :
               getPerformanceIndicator(row) === 'good' ? 'trending_up' :
               getPerformanceIndicator(row) === 'average' ? 'remove' : 'trending_down' }}
          </mat-icon>
          {{ getPerformanceIndicator(row) === 'excellent' ? 'Отлично' :
             getPerformanceIndicator(row) === 'good' ? 'Хорошо' :
             getPerformanceIndicator(row) === 'average' ? 'Средне' : 'Требует внимания' }}
        </mat-chip>
      </ng-template>
    </crm-table>
  </div>

  <!-- Индикатор загрузки -->
  <div class="loading" *ngIf="isLoading">
    <mat-icon>hourglass_empty</mat-icon>
    <p>Загрузка данных по менеджерам...</p>
  </div>

  <!-- Пустое состояние -->
  <div class="no-data" *ngIf="!isLoading && managersStats.length === 0">
    <mat-icon>person_off</mat-icon>
    <p>Нет данных по менеджерам</p>
    <p class="subtitle">Добавьте сделки с назначенными менеджерами</p>
  </div>
</div>
