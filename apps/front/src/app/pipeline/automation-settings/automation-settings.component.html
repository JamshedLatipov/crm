<div class="automation-settings">
  <div class="modal-header">
    <h2 mat-dialog-title>
      <mat-icon>settings</mat-icon>
      Автоматизация воронки продаж
    </h2>
    <button mat-icon-button [mat-dialog-close]="false" class="close-button">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div mat-dialog-content class="modal-content">
    <div class="content-grid">
      <!-- Левая колонка - список правил -->
      <div class="rules-list">
        <div class="section-header">
          <h3>Правила автоматизации</h3>
          <button mat-raised-button color="primary" (click)="createNewRule()">
            <mat-icon>add</mat-icon>
            Новое правило
          </button>
        </div>

        <div class="rules-container" *ngIf="!isLoading(); else loading">
          <mat-card
            *ngFor="let rule of rules()"
            class="rule-card"
            [class.active]="selectedRule()?.id === rule.id"
            (click)="selectRule(rule)"
          >
            <mat-card-content>
              <div class="rule-header">
                <div class="rule-info">
                  <h4>{{ rule.name }}</h4>
                  <p>{{ rule.description }}</p>
                </div>
                <mat-slide-toggle
                  [checked]="rule.isActive"
                  (click)="$event.stopPropagation()"
                  (change)="toggleRule(rule)"
                ></mat-slide-toggle>
              </div>

              <div class="rule-details">
                <div class="trigger-info">
                  <mat-icon>flash_on</mat-icon>
                  <span>{{ getTriggerLabel(rule.trigger) }}</span>
                </div>
                <div class="actions-info">
                  <mat-icon>play_arrow</mat-icon>
                  <span>{{ getActionsCount(rule.actions) }} действий</span>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <div *ngIf="rules().length === 0" class="no-rules">
            <mat-icon>info</mat-icon>
            <p>Нет правил автоматизации</p>
            <p class="subtitle">Создайте первое правило для автоматической обработки сделок</p>
          </div>
        </div>

        <ng-template #loading>
          <div class="loading">
            <mat-icon>hourglass_empty</mat-icon>
            <p>Загрузка правил...</p>
          </div>
        </ng-template>
      </div>

      <!-- Правая колонка - редактор правила -->
      <div class="rule-editor">
        <div *ngIf="selectedRule() || isEditingNew()">
          <div class="editor-header">
            <h3>{{ selectedRule()?.id ? 'Редактирование правила' : 'Создание правила' }}</h3>
            <div class="editor-actions">
              <button mat-button (click)="cancelEdit()">
                <mat-icon>cancel</mat-icon>
                Отмена
              </button>
              <button
                mat-raised-button
                color="primary"
                [disabled]="!(selectedRule() || isEditingNew()) || !(selectedRule()?.name?.trim() || newRule.name?.trim())"
                (click)="selectedRule()?.id ? updateRule(selectedRule()!) : createRule()"
              >
                <mat-icon>{{ selectedRule()?.id ? 'save' : 'add' }}</mat-icon>
                {{ selectedRule()?.id ? 'Сохранить' : 'Создать' }}
              </button>
            </div>
          </div>

          <div class="rule-form">
            <!-- Основная информация -->
            <mat-card class="form-section">
              <mat-card-header>
                <mat-card-title>Основная информация</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Название правила</mat-label>
                  <input matInput [(ngModel)]="(selectedRule() || newRule).name" placeholder="Например: Автоперемещение холодных лидов">
                </mat-form-field>

                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Описание</mat-label>
                  <textarea
                    matInput
                    [(ngModel)]="(selectedRule() || newRule).description"
                    rows="3"
                    placeholder="Опишите, что делает это правило"
                  ></textarea>
                </mat-form-field>
              </mat-card-content>
            </mat-card>

            <!-- Триггер -->
            <mat-card class="form-section">
              <mat-card-header>
                <mat-card-title>Триггер (условие запуска)</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <mat-form-field appearance="outline">
                  <mat-label>Тип триггера</mat-label>
                  <mat-select [(ngModel)]="(selectedRule() || newRule).trigger">
                    <mat-option *ngFor="let type of triggerTypes" [value]="type.value">
                      {{ type.label }}
                    </mat-option>
                  </mat-select>
                </mat-form-field>
              </mat-card-content>
            </mat-card>

            <!-- Условия -->
            <mat-card class="form-section conditions-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon class="section-icon">filter_list</mat-icon>
                  Условия (дополнительные фильтры)
                </mat-card-title>
                <div class="section-actions">
                  <span class="section-hint">Нажмите + чтобы добавить условие</span>
                  <button mat-icon-button color="accent" (click)="addCondition()" matTooltip="Добавить условие">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
              </mat-card-header>
              <mat-card-content>
                <div class="conditions-logic">
                  <span class="logic-label">Все условия должны выполняться (И)</span>
                </div>

                <div *ngFor="let condition of (selectedRule() || newRule).conditions; let i = index" class="condition-item">
                  <div class="condition-card">
                    <div class="condition-header">
                      <div class="condition-icon">
                        <mat-icon>{{ getConditionIcon(condition.field) }}</mat-icon>
                      </div>
                      <div class="condition-content">
                        <div class="condition-row">
                          <mat-form-field appearance="outline" class="condition-field">
                            <mat-label>Тип условия</mat-label>
                            <mat-select [(ngModel)]="condition.field" (ngModelChange)="onConditionFieldChange(i)">
                              <mat-option value="STAGE_EQUALS">
                                <mat-icon>timeline</mat-icon>
                                Этап равен
                              </mat-option>
                              <mat-option value="STAGE_NOT_EQUALS">
                                <mat-icon>timeline</mat-icon>
                                Этап не равен
                              </mat-option>
                              <mat-option value="STATUS_EQUALS">
                                <mat-icon>flag</mat-icon>
                                Статус равен
                              </mat-option>
                              <mat-option value="AMOUNT_GREATER_THAN">
                                <mat-icon>trending_up</mat-icon>
                                Сумма больше
                              </mat-option>
                              <mat-option value="AMOUNT_LESS_THAN">
                                <mat-icon>trending_down</mat-icon>
                                Сумма меньше
                              </mat-option>
                              <mat-option value="AMOUNT_BETWEEN">
                                <mat-icon>compare_arrows</mat-icon>
                                Сумма между
                              </mat-option>
                              <mat-option value="ASSIGNED_TO_EQUALS">
                                <mat-icon>person</mat-icon>
                                Назначен менеджеру
                              </mat-option>
                              <mat-option value="TAGS_CONTAIN">
                                <mat-icon>label</mat-icon>
                                Содержит теги
                              </mat-option>
                              <mat-option value="TAGS_NOT_CONTAIN">
                                <mat-icon>label_off</mat-icon>
                                Не содержит теги
                              </mat-option>
                              <mat-option value="SOURCE_EQUALS">
                                <mat-icon>link</mat-icon>
                                Источник равен
                              </mat-option>
                              <mat-option value="PRIORITY_EQUALS">
                                <mat-icon>priority_high</mat-icon>
                                Приоритет равен
                              </mat-option>
                              <mat-option value="SCORE_GREATER_THAN">
                                <mat-icon>star</mat-icon>
                                Скор больше
                              </mat-option>
                              <mat-option value="CREATED_WITHIN_DAYS">
                                <mat-icon>schedule</mat-icon>
                                Создан за последние дни
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <mat-form-field appearance="outline" class="condition-value" *ngIf="!isBetweenCondition(condition.field)">
                            <mat-label>{{ getConditionValueLabel(condition.field) }}</mat-label>
                            <input matInput [(ngModel)]="condition.value" [placeholder]="getConditionPlaceholder(condition.field)">
                            <mat-hint>{{ getConditionHint(condition.field) }}</mat-hint>
                          </mat-form-field>

                          <!-- Для условий "между" -->
                          <div class="between-values" *ngIf="isBetweenCondition(condition.field)">
                            <mat-form-field appearance="outline" class="condition-value">
                              <mat-label>От</mat-label>
                              <input matInput [(ngModel)]="condition.value" [placeholder]="getConditionPlaceholder(condition.field)">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="condition-value">
                              <mat-label>До</mat-label>
                              <input matInput [(ngModel)]="condition.value2" placeholder="Максимальное значение">
                            </mat-form-field>
                          </div>
                        </div>

                        <!-- Дополнительная информация -->
                        <div class="condition-info" *ngIf="condition.field">
                          <small class="condition-description">{{ getConditionDescription(condition.field) }}</small>
                        </div>
                      </div>

                      <div class="condition-actions">
                        <button mat-icon-button color="warn" (click)="removeCondition(i)" matTooltip="Удалить условие">
                          <mat-icon>delete</mat-icon>
                        </button>
                        <div class="condition-number">{{ i + 1 }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="!(selectedRule() || newRule).conditions?.length" class="no-conditions">
                  <mat-icon>filter_alt_off</mat-icon>
                  <div class="no-conditions-content">
                    <h4>Условий нет</h4>
                    <p>Правило будет применяться ко всем объектам, соответствующим триггеру.</p>
                    <p class="hint">Используйте кнопку "+" выше, чтобы добавить условия фильтрации и сделать правило более точным.</p>
                  </div>
                </div>

                <!-- Статистика условий -->
                <div class="conditions-summary" *ngIf="(selectedRule() || newRule).conditions?.length > 0">
                  <mat-chip-listbox>
                    <mat-chip>{{ (selectedRule() || newRule).conditions.length }} услови{{ getConditionsWord((selectedRule() || newRule).conditions.length) }}</mat-chip>
                  </mat-chip-listbox>
                </div>
              </mat-card-content>
            </mat-card>

            <!-- Действия -->
            <mat-card class="form-section actions-section">
              <mat-card-header>
                <mat-card-title>
                  <mat-icon class="section-icon">play_arrow</mat-icon>
                  Действия (автоматические операции)
                </mat-card-title>
                <div class="section-actions">
                  <span class="section-hint">Нажмите + чтобы добавить действие</span>
                  <button mat-icon-button color="accent" (click)="addAction()" matTooltip="Добавить действие">
                    <mat-icon>add</mat-icon>
                  </button>
                </div>
              </mat-card-header>
              <mat-card-content>
                <div class="actions-logic">
                  <span class="logic-label">Действия выполняются последовательно</span>
                </div>

                <div *ngFor="let action of (selectedRule() || newRule).actions; let i = index" class="action-item">
                  <div class="action-card">
                    <div class="action-header">
                      <div class="action-icon">
                        <mat-icon>{{ getActionIcon(action.type) }}</mat-icon>
                      </div>
                      <div class="action-content">
                        <div class="action-row">
                          <mat-form-field appearance="outline" class="action-field">
                            <mat-label>Тип действия</mat-label>
                            <mat-select [(ngModel)]="action.type">
                              <mat-option *ngFor="let type of actionTypes" [value]="type.value">
                                <mat-icon>{{ getActionIcon(type.value) }}</mat-icon>
                                {{ type.label }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>
                        </div>

                        <!-- Дополнительная информация -->
                        <div class="action-info" *ngIf="action.type">
                          <small class="action-description">{{ getActionDescription(action.type) }}</small>
                          <small class="action-hint" *ngIf="getActionHint(action.type)">{{ getActionHint(action.type) }}</small>
                        </div>

                        <!-- Конфигурация действия в зависимости от типа -->
                        <div class="action-config" [ngSwitch]="action.type">
                          <!-- Изменить этап -->
                          <mat-form-field appearance="outline" *ngSwitchCase="'change_stage'" class="config-field">
                            <mat-label>Выберите этап</mat-label>
                            <mat-select [(ngModel)]="action.config['stageId']">
                              <mat-option *ngFor="let stage of stages()" [value]="stage.id">
                                {{ stage.name }}
                              </mat-option>
                            </mat-select>
                          </mat-form-field>

                          <!-- Изменить статус -->
                          <mat-form-field appearance="outline" *ngSwitchCase="'change_status'" class="config-field">
                            <mat-label>Новый статус</mat-label>
                            <input matInput [(ngModel)]="action.config['status']" placeholder="Например: won, lost, pending">
                          </mat-form-field>

                          <!-- Назначить пользователю -->
                          <mat-form-field appearance="outline" *ngSwitchCase="'assign_to_user'" class="config-field">
                            <mat-label>ID пользователя</mat-label>
                            <input matInput [(ngModel)]="action.config['userId']" placeholder="ID менеджера">
                            <mat-hint>Пользователь, которому будет назначена сделка</mat-hint>
                          </mat-form-field>

                          <!-- Отправить уведомление -->
                          <div class="notification-section" *ngSwitchCase="'send_notification'">
                            <mat-form-field appearance="outline" class="config-field">
                              <mat-label>Тип уведомления</mat-label>
                              <mat-select [(ngModel)]="action.config['type']">
                                <mat-option *ngFor="let type of notificationTypes" [value]="type.value">
                                  {{ type.label }}
                                </mat-option>
                              </mat-select>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="config-field full-width">
                              <mat-label>Текст сообщения</mat-label>
                              <textarea
                                matInput
                                [(ngModel)]="action.config['message']"
                                rows="3"
                                placeholder="Введите текст уведомления. Используйте переменные: {deal.title}, {deal.amount}, {manager.name}"
                              ></textarea>
                              <mat-hint>Поддерживаются переменные: &#123;deal.title&#125;, &#123;deal.amount&#125;, &#123;manager.name&#125;</mat-hint>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="config-field full-width">
                              <mat-label>Получатели (email)</mat-label>
                              <input matInput [(ngModel)]="action.config['recipients']" placeholder="email1@example.com, email2@example.com">
                              <mat-hint>Несколько email через запятую</mat-hint>
                            </mat-form-field>
                          </div>

                          <!-- Создать задачу -->
                          <div class="task-section" *ngSwitchCase="'create_task'">
                            <div class="config-row">
                              <mat-form-field appearance="outline" class="config-field">
                                <mat-label>Название задачи</mat-label>
                                <input matInput [(ngModel)]="action.config['title']" placeholder="Краткое название">
                              </mat-form-field>

                              <mat-form-field appearance="outline" class="config-field">
                                <mat-label>Дедлайн (дни)</mat-label>
                                <input matInput type="number" [(ngModel)]="action.config['dueInDays']" min="1" placeholder="7">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="config-field full-width">
                              <mat-label>Описание</mat-label>
                              <textarea
                                matInput
                                [(ngModel)]="action.config['description']"
                                rows="2"
                                placeholder="Подробное описание задачи"
                              ></textarea>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="config-field">
                              <mat-label>Назначить</mat-label>
                              <input matInput [(ngModel)]="action.config['assignedTo']" placeholder="ID пользователя">
                              <mat-hint>ID менеджера, ответственного за задачу</mat-hint>
                            </mat-form-field>
                          </div>

                          <!-- Обновить сумму -->
                          <mat-form-field appearance="outline" *ngSwitchCase="'update_amount'" class="config-field">
                            <mat-label>Новая сумма (TJS)</mat-label>
                            <input matInput type="number" [(ngModel)]="action.config['amount']" min="0" placeholder="100000">
                            <mat-hint>Сумма в сомони без разделителей</mat-hint>
                          </mat-form-field>

                          <!-- Добавить теги -->
                          <mat-form-field appearance="outline" *ngSwitchCase="'add_tags'" class="config-field">
                            <mat-label>Теги (через запятую)</mat-label>
                            <input matInput [(ngModel)]="action.config['tags']" placeholder="vip, срочный, повторный">
                            <mat-hint>Теги для категоризации сделки</mat-hint>
                          </mat-form-field>

                          <!-- Отправить email -->
                          <div class="email-section" *ngSwitchCase="'send_email'">
                            <mat-form-field appearance="outline" class="config-field full-width">
                              <mat-label>Тема письма</mat-label>
                              <input matInput [(ngModel)]="action.config['subject']" placeholder="Тема email">
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="config-field full-width">
                              <mat-label>Текст письма</mat-label>
                              <textarea
                                matInput
                                [(ngModel)]="action.config['body']"
                                rows="4"
                                placeholder="Текст email-сообщения"
                              ></textarea>
                            </mat-form-field>

                            <mat-form-field appearance="outline" class="config-field full-width">
                              <mat-label>Получатели</mat-label>
                              <input matInput [(ngModel)]="action.config['recipients']" placeholder="email@example.com">
                              <mat-hint>Один или несколько email через запятую</mat-hint>
                            </mat-form-field>
                          </div>

                          <!-- Установить напоминание -->
                          <div class="reminder-section" *ngSwitchCase="'set_reminder'">
                            <div class="config-row">
                              <mat-form-field appearance="outline" class="config-field">
                                <mat-label>Через (часы)</mat-label>
                                <input matInput type="number" [(ngModel)]="action.config['hoursFromNow']" min="1" placeholder="24">
                              </mat-form-field>

                              <mat-form-field appearance="outline" class="config-field">
                                <mat-label>Назначить</mat-label>
                                <input matInput [(ngModel)]="action.config['assignedTo']" placeholder="ID пользователя">
                              </mat-form-field>
                            </div>

                            <mat-form-field appearance="outline" class="config-field full-width">
                              <mat-label>Текст напоминания</mat-label>
                              <textarea
                                matInput
                                [(ngModel)]="action.config['message']"
                                rows="2"
                                placeholder="Текст напоминания для менеджера"
                              ></textarea>
                            </mat-form-field>
                          </div>
                        </div>
                      </div>

                      <div class="action-actions">
                        <button mat-icon-button color="warn" (click)="removeAction(i)" matTooltip="Удалить действие">
                          <mat-icon>delete</mat-icon>
                        </button>
                        <div class="action-number">{{ i + 1 }}</div>
                      </div>
                    </div>
                  </div>
                </div>

                <div *ngIf="!(selectedRule() || newRule).actions?.length" class="no-actions">
                  <mat-icon>play_circle_outline</mat-icon>
                  <div class="no-actions-content">
                    <h4>Действий нет</h4>
                    <p>Добавьте хотя бы одно действие, которое будет выполняться при срабатывании правила.</p>
                    <p class="hint">Используйте кнопку "+" выше, чтобы добавить автоматические действия.</p>
                  </div>
                </div>

                <!-- Статистика действий -->
                <div class="actions-summary" *ngIf="(selectedRule() || newRule).actions?.length > 0">
                  <mat-chip-listbox>
                    <mat-chip>{{ (selectedRule() || newRule).actions.length }} действи{{ getActionsWord((selectedRule() || newRule).actions.length) }}</mat-chip>
                  </mat-chip-listbox>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>

        <ng-template #createNew>
          <div class="create-placeholder">
            <mat-icon>settings</mat-icon>
            <h3>Создайте правило автоматизации</h3>
            <p>Нажмите кнопку ниже, чтобы начать настройку</p>
            <button mat-raised-button color="primary" (click)="createNewRule()">
              <mat-icon>add</mat-icon>
              Создать новое правило
            </button>
            <p class="instructions">
              <strong>Как настроить правило:</strong><br>
              1. Выберите триггер (событие запуска)<br>
              2. Добавьте условия фильтрации (опционально)<br>
              3. Добавьте действия для автоматического выполнения
            </p>
          </div>
        </ng-template>
      </div>
    </div>
  </div>

  <div mat-dialog-actions class="modal-actions">
    <button mat-button [mat-dialog-close]="false">Закрыть</button>
    <button mat-raised-button color="primary" (click)="triggerAutomation()">
      <mat-icon>play_arrow</mat-icon>
      Запустить автоматизацию
    </button>
  </div>
</div>