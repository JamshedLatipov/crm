<mat-form-field [appearance]="appearance" class="user-selector-field">
  <mat-label>{{ label }}</mat-label>
  <mat-select 
    [value]="value" 
    (valueChange)="onValueChange($event)"
    [disabled]="isDisabled"
    [required]="required">
    
    <!-- Custom trigger for selected value display -->
    <mat-select-trigger *ngIf="selectedUser">
      <div class="selected-user-display">
        <mat-icon class="selected-user-icon">account_circle</mat-icon>
        <div class="selected-user-info">
          <span class="selected-user-name">{{ selectedUser.name }}</span>
          <span class="selected-user-meta" *ngIf="(showRole && selectedUser.role) || (showDepartment && selectedUser.department)">
            <ng-container *ngIf="showRole && selectedUser.role">{{ roleDisplay(selectedUser.role) }}</ng-container>
            <ng-container *ngIf="showRole && selectedUser.role && showDepartment && selectedUser.department"> · </ng-container>
            <ng-container *ngIf="showDepartment && selectedUser.department">{{ departmentDisplay(selectedUser.department) }}</ng-container>
          </span>
          <!-- Compact workload progress for selected user -->
          <div class="selected-user-workload" *ngIf="selectedUser">
            <ng-container *ngIf="getWorkloadFor(selectedUser) as sw">
              <mat-progress-bar class="selected-progress"
                                mode="determinate"
                                [value]="sw.workloadPercentage ?? 0"
                                [ngClass]="getWorkloadClass(sw.workloadPercentage)"
                                [style.--workload-fill]="getWorkloadColor(sw.workloadPercentage)">
              </mat-progress-bar>
              <span class="selected-workload-text">{{ sw.workload }} / {{ sw.maxCapacity }} ({{ sw.workloadPercentage ?? '-' }}%)</span>
            </ng-container>
          </div>
        </div>
      </div>
    </mat-select-trigger>
    
    <mat-option [value]="null">{{ placeholder }}</mat-option>
    
    <mat-option *ngIf="isLoading" disabled>
      <div class="loading-option">
        <mat-spinner diameter="18"></mat-spinner>
        <span>Загрузка пользователей...</span>
      </div>
    </mat-option>
    
    <mat-option *ngFor="let user of availableUsers" [value]="user.id">
      <div class="user-option">
        <div class="user-info">
          <div class="user-name">
            <ng-container *ngIf="showStatus">
              <ng-container *ngIf="getWorkloadFor(user) as uw">
                <span
                  class="status-indicator"
                  [ngClass]="getWorkloadClass(uw.workloadPercentage)"
                  [style.backgroundColor]="getWorkloadColor(uw.workloadPercentage)"
                  [attr.title]="uw.workloadPercentage !== null ? (uw.workload + ' / ' + uw.maxCapacity + ' (' + uw.workloadPercentage + '%)') : ''"
                ></span>
              </ng-container>
            </ng-container>
            {{ user.name }}
          </div>

          <div class="user-meta" *ngIf="showRole || showDepartment || (showEmail && user.email)">
            <span class="user-role" *ngIf="showRole && user.role">{{ roleDisplay(user.role) }}</span>
            <span *ngIf="showRole && user.role && showDepartment && user.department"> · </span>
            <span class="user-dept" *ngIf="showDepartment && user.department">
              {{ departmentDisplay(user.department) }}
            </span>
            <span *ngIf="(showRole || showDepartment) && showEmail && user.email"> · </span>
            <span class="user-email" *ngIf="showEmail && user.email">{{ user.email }}</span>
          </div>
          <!-- Workload progress bar shown under meta for each option -->
          <div class="user-workload" *ngIf="true">
            <ng-container *ngIf="getWorkloadFor(user) as uw">
              <mat-progress-bar class="option-progress"
                                mode="determinate"
                                [value]="uw.workloadPercentage ?? 0"
                                [ngClass]="getWorkloadClass(uw.workloadPercentage)"
                                [style.--workload-fill]="getWorkloadColor(uw.workloadPercentage)">
              </mat-progress-bar>
              <span class="workload-text">{{ uw.workload }} / {{ uw.maxCapacity }} • {{ uw.workloadPercentage ?? '-' }}%</span>
            </ng-container>
          </div>
        </div>
      </div>
    </mat-option>
  </mat-select>
  
  <mat-icon matSuffix *ngIf="icon">{{ icon }}</mat-icon>
  
  <mat-error *ngIf="required">{{ errorMessage }}</mat-error>
</mat-form-field>
