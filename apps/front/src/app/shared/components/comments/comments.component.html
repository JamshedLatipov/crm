<div class="comments-section">
  <!-- Заголовок и счетчик -->
  <!-- <div class="comments-header">
    <h3>
      <mat-icon>comment</mat-icon>
      Комментарии
      <span *ngIf="commentsData()?.total" class="comment-count"
        >({{ commentsData()?.total }})</span
      >
    </h3>
  </div> -->

  <!-- Загрузка -->
  <div class="loading-container" *ngIf="isLoading()">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Загрузка комментариев...</p>
  </div>

  <!-- Список комментариев -->
  <div class="comments-list" *ngIf="!isLoading()">
    <div *ngIf="comments().length === 0" class="no-comments">
      <mat-icon>chat_bubble_outline</mat-icon>
      <p>Пока нет комментариев. Будьте первым!</p>
    </div>

    <div *ngFor="let group of commentGroups(); trackBy: trackByGroupUser" class="comment-group">
      <!-- Header группы (аватарка + имя пользователя) -->
      <div class="group-header">
        <div class="author-avatar">
          <mat-icon>person</mat-icon>
        </div>
        <div class="author-info">
          <span class="author-name">{{ group.userName }}</span>
          <div class="comment-actions" *ngIf="canEditGroup(group)">
            <button mat-icon-button [matMenuTriggerFor]="groupMenu">
              <mat-icon>more_vert</mat-icon>
            </button>
            <mat-menu #groupMenu="matMenu">
              <button mat-menu-item (click)="startEditGroup(group)">
                <mat-icon>edit</mat-icon>
                Редактировать сообщения
              </button>
              <button
                mat-menu-item
                (click)="deleteGroup(group)"
                class="delete-action"
              >
                <mat-icon>delete</mat-icon>
                Удалить все сообщения
              </button>
            </mat-menu>
          </div>
        </div>
      </div>

      <!-- Сообщения группы -->
      <div class="group-messages">
        <div
          *ngFor="let comment of group.comments; trackBy: trackByCommentId"
          class="message-item"
        >
          <div class="message-content">
            <div class="comment-text">{{ comment.text }}</div>
            <div class="message-meta">
              <span class="message-time">{{ formatDate(comment.createdAt) }}</span>
              <span
                *ngIf="comment.updatedAt !== comment.createdAt"
                class="edited-indicator"
                title="Отредактирован {{ formatDate(comment.updatedAt) }}"
              >
                изменен
              </span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Пагинация -->
  <mat-paginator
    *ngIf="commentsData()?.totalPages && commentsData()!.totalPages > 1"
    [length]="commentsData()?.total || 0"
    [pageSize]="pageSize"
    [pageIndex]="currentPage - 1"
    [pageSizeOptions]="[10, 20, 50]"
    (page)="onPageChange($event)"
    showFirstLastButtons
  ></mat-paginator>

  <!-- Форма добавления комментария -->

  <mat-form-field class="full-width" *ngIf="isAuthenticated()">
    <mat-label>Добавить комментарий...</mat-label>
    <textarea
      matInput
      [formControl]="newCommentText"
      [disabled]="isSubmitting()"
      placeholder="Введите ваш комментарий"
      rows="3"
      maxlength="2000"
    ></textarea>
    <mat-hint align="end">{{ newCommentText.value?.length }}/2000</mat-hint>
  </mat-form-field>

  <div class="form-actions">
    <button
      mat-raised-button
      color="primary"
      (click)="addComment()"
      [disabled]="!canSubmit() || isSubmitting()"
    >
      <mat-icon *ngIf="isSubmitting()">hourglass_empty</mat-icon>
      <mat-icon *ngIf="!isSubmitting() && !editingComment()">send</mat-icon>
      <mat-icon *ngIf="!isSubmitting() && editingComment()">save</mat-icon>
      {{
        isSubmitting()
          ? 'Сохранение...'
          : editingComment()
          ? 'Сохранить'
          : 'Отправить'
      }}
    </button>

    <button mat-button (click)="cancelEdit()" *ngIf="editingComment()">
      <mat-icon>cancel</mat-icon>
      Отмена
    </button>
  </div>
</div>
