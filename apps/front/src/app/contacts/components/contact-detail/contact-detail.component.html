<div class="page-container">
    <!-- Header with breadcrumbs -->
    <div class="page-header">
        <div class="header-content">
            <div class="breadcrumb">
                <a routerLink="/contacts" class="breadcrumb-link">Контакты</a>
                <mat-icon class="breadcrumb-separator">chevron_right</mat-icon>
                <span class="breadcrumb-current">{{ contact ? contactsService.formatContactName(contact) : 'Загрузка...'
                    }}</span>
            </div>
            <div class="header-actions" *ngIf="contact && !loading">
                <button mat-button [matMenuTriggerFor]="actionsMenu">
                    <mat-icon>more_vert</mat-icon>
                    <span>Действия</span>
                </button>
                <mat-menu #actionsMenu="matMenu">
                    <button mat-menu-item (click)="onEdit()">
                        <mat-icon>edit</mat-icon>
                        <span>Редактировать</span>
                    </button>
                    <button mat-menu-item (click)="updateLastContact()">
                        <mat-icon>touch_app</mat-icon>
                        <span>Отметить контакт</span>
                    </button>
                    <button mat-menu-item (click)="toggleBlacklist()" [class.text-red-600]="contact.isBlacklisted">
                        <mat-icon>{{ contact.isBlacklisted ? 'person_add' : 'block' }}</mat-icon>
                        <span>{{ contact.isBlacklisted ? 'Убрать из черного списка' : 'В черный список' }}</span>
                    </button>
                    <mat-divider></mat-divider>
                    <button mat-menu-item (click)="deleteContact()" class="text-red-600">
                        <mat-icon>delete</mat-icon>
                        <span>Удалить</span>
                    </button>
                </mat-menu>
                <button mat-raised-button color="primary" (click)="onEdit()">
                    <mat-icon>edit</mat-icon>
                    <span>Редактировать</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Loading state -->
    <div *ngIf="loading" class="loading-container">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Загрузка контакта...</p>
    </div>

    <!-- Main content -->
    <div *ngIf="!loading && contact" class="contact-detail-content">
        <!-- Contact Profile Card (standalone component) -->
        <app-contact-profile-card [contact]="contact" [placeholderAvatar]="placeholderAvatar">
            <mat-chip-set>
                <mat-chip [class]="getStatusChipClass()" [matTooltip]="getStatusTooltip()">
                    <mat-icon matChipAvatar>{{ getStatusIcon() }}</mat-icon>
                    {{ getStatusText() }}
                </mat-chip>
                <mat-chip color="accent" *ngIf="contact.source">
                    <mat-icon matChipAvatar>{{ getSourceIcon() }}</mat-icon>
                    {{ contactsService.getContactSourceLabel(contact.source) }}
                </mat-chip>
                <mat-chip *ngFor="let tag of contact.tags" class="bg-gray-100 text-gray-800">
                    {{ tag }}
                </mat-chip>
            </mat-chip-set>
        </app-contact-profile-card>

        <!-- Content tabs -->
        <mat-tab-group [(selectedIndex)]="selectedTabIndex" class="contact-tabs">
            <mat-tab label="Детали">
                <app-contact-details-tab [contact]="contact" [hasAddressInfo]="hasAddressInfo"
                    [getFullAddress]="getFullAddress" [formatDate]="formatDate"
                    [contactsService]="contactsService"></app-contact-details-tab>
            </mat-tab>

            <mat-tab label="Активность">
                <div class="tab-content">
                    <div class="activity-section">
                        <div class="activity-header">
                            <h3 class="section-title">История активности</h3>
                        </div>

                        <div *ngIf="activitiesLoading" class="loading-container">
                            <mat-spinner diameter="30"></mat-spinner>
                            <p>Загрузка активности...</p>
                        </div>

                        <div *ngIf="!activitiesLoading && activities.length > 0" class="activity-list">
                            <div class="activity-item" *ngFor="let activity of activities; trackBy: trackActivityById">
                                <div class="activity-icon">
                                    <mat-icon [class]="'activity-icon-' + activity.type">{{
                                        getActivityIcon(activity.type) }}</mat-icon>
                                </div>
                                <div class="activity-content">
                                    <div class="activity-title">{{ activity.title }}</div>
                                    <div class="activity-description" *ngIf="activity.description">{{
                                        activity.description }}</div>
                                    <div class="activity-meta">
                                        <span class="activity-type-badge">{{
                                            contactsService.getActivityTypeLabel(activity.type) }}</span>
                                        <span class="activity-date">{{ formatDate(activity.date) }}</span>
                                        <span class="activity-user" *ngIf="activity.userName">{{ activity.userName
                                            }}</span>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div *ngIf="!activitiesLoading && activities.length === 0" class="empty-state">
                            <mat-icon class="empty-icon">history</mat-icon>
                            <h4>Нет записей об активности</h4>
                            <p>Добавьте первую запись о взаимодействии с контактом</p>
                        </div>
                    </div>
                </div>
            </mat-tab>

            <mat-tab label="Сделки">
                <div class="tab-content">
                    <div class="deals-section">
                        <h3 class="section-title">Связанные сделки</h3>

                        <!-- Состояние загрузки -->
                        <div *ngIf="dealsLoading" class="loading-section">
                            <mat-progress-spinner mode="indeterminate" diameter="40" color="primary">
                            </mat-progress-spinner>
                            <p>Загрузка сделок...</p>
                        </div>

                        <!-- Список сделок (standalone component) -->
                            <app-contact-details-deals-list [deals]="deals" [dealsLoading]="dealsLoading"
                                [getDealStatusLabel]="getDealStatusLabel" [openDeal]="openDeal" [editDeal]="editDeal"
                                [deleteDeal]="deleteDeal" [createDeal]="createDeal"></app-contact-details-deals-list>
                    </div>
                </div>
            </mat-tab>
        </mat-tab-group>
    </div>

    <!-- Error state -->
    <div *ngIf="!loading && !contact" class="error-state">
        <mat-icon class="error-icon">error_outline</mat-icon>
        <h3>Контакт не найден</h3>
        <p>Запрашиваемый контакт не существует или был удален</p>
        <button mat-raised-button routerLink="/contacts">
            <mat-icon>arrow_back</mat-icon>
            <span>Назад к контактам</span>
        </button>
    </div>
</div>