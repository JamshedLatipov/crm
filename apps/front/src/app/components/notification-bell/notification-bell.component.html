<button
  mat-icon-button
  [matMenuTriggerFor]="notificationMenu"
  [matBadge]="unreadCount()"
  [matBadgeHidden]="!hasUnreadNotifications()"
  matBadgeColor="warn"
  matBadgeSize="small"
  [matTooltip]="tooltipText()"
  (click)="onBellClick()"
  class="notification-bell"
>
  <mat-icon>notifications</mat-icon>
</button>

<mat-menu #notificationMenu="matMenu" class="notification-menu" xPosition="before">
  <div class="notification-header" (click)="$event.stopPropagation()">
    <h3>Уведомления</h3>
    <div class="notification-actions">
      @if (hasUnreadNotifications()) {
        <button 
          mat-button 
          color="primary" 
          class="mark-all-read-btn"
          (click)="markAllAsRead()"
          [disabled]="isLoading()"
        >
          Прочитать все
        </button>
      }
    </div>
  </div>

  <mat-divider></mat-divider>

  <div class="notification-content">
    @if (isLoading()) {
      <div class="loading-container">
        <mat-spinner diameter="30"></mat-spinner>
        <p>Загрузка уведомлений...</p>
      </div>
    } @else if (error()) {
      <div class="error-container">
        <mat-icon color="warn">error</mat-icon>
        <p>{{ error() }}</p>
        <button mat-button color="primary" (click)="reload()">
          Повторить
        </button>
      </div>
    } @else if (displayedNotifications().length === 0) {
      <div class="empty-container">
        <mat-icon>notifications_none</mat-icon>
        <p>Нет уведомлений</p>
      </div>
    } @else {
      <div class="notifications-list">
        @for (notification of displayedNotifications(); track notification.id) {
          <div 
            class="notification-item"
            [class.unread]="notification.status !== 'read'"
            [class.high-priority]="notification.priority === 'high' || notification.priority === 'urgent'"
            (click)="onNotificationClick(notification)"
          >
            <div class="notification-icon">
              {{ getNotificationIcon(notification.type) }}
            </div>
            <div class="notification-content">
              <div class="notification-title">
                {{ notification.title }}
              </div>
              <div class="notification-message">
                {{ notification.message }}
              </div>
              <div class="notification-time">
                {{ formatTimeAgo(notification.createdAt) }}
              </div>
            </div>
            <div class="notification-actions">
              @if (notification.status !== 'read') {
                <button 
                  mat-icon-button 
                  class="mark-read-btn"
                  (click)="markAsRead(notification.id, $event)"
                  matTooltip="Отметить как прочитанное"
                >
                  <mat-icon>check</mat-icon>
                </button>
              }
              <div 
                class="priority-indicator"
                [style.background-color]="getPriorityColor(notification.priority)"
              ></div>
            </div>
          </div>
        }
      </div>

      @if (hasMoreNotifications()) {
        <div class="show-more-container">
          <button 
            mat-button 
            color="primary" 
            (click)="showAllNotifications()"
            class="show-more-btn"
          >
            Показать все ({{ totalNotifications() }})
          </button>
        </div>
      }
    }
  </div>
</mat-menu>
