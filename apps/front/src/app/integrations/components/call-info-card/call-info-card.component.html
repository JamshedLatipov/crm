<div class="call-info-container">
  <div *ngIf="loading()" class="loading-shade">
    <mat-spinner diameter="40"></mat-spinner>
  </div>

  <div *ngIf="error()" class="error-message">
    {{ error() }}
  </div>

  <div *ngIf="callInfo() as info" class="info-content">
    <!-- Header Card -->
    <mat-card class="header-card mb-4">
      <mat-card-header>
        <div mat-card-avatar class="avatar-placeholder">
          <mat-icon>person</mat-icon>
        </div>
        <mat-card-title>{{ info.name || 'Unknown Client' }}</mat-card-title>
        <mat-card-subtitle>{{ info.phone }}</mat-card-subtitle>
        <div class="header-actions">
            <button mat-icon-button *ngIf="info.externalUrl" (click)="openExternalUrl()" matTooltip="Open in external system">
                <mat-icon>open_in_new</mat-icon>
            </button>
        </div>
      </mat-card-header>
      <mat-card-content>
        <div class="stats-grid">
          <div class="stat-item" *ngIf="info.balance !== undefined">
            <span class="label">Balance</span>
            <span class="value" [class.negative]="info.balance < 0">
              {{ info.balance | number:'1.2-2' }} {{ info.currency }}
            </span>
          </div>
          <div class="stat-item" *ngIf="info.status">
            <span class="label">Status</span>
            <span class="value status-badge">{{ info.status }}</span>
          </div>
        </div>
      </mat-card-content>
    </mat-card>

    <!-- Dynamic Sections -->
    <mat-tab-group *ngIf="info.sections?.length" dynamicHeight>
      <mat-tab *ngFor="let section of info.sections" [label]="section.ui.title">
        <div class="section-content p-4">
          
          <!-- Details View -->
          <div *ngIf="section.ui.type === 'details'" class="details-grid">
            <div *ngFor="let field of section.ui.fields" class="detail-item">
              <span class="detail-label">{{ field.label }}</span>
              <span class="detail-value">{{ section.data[field.key] }}</span>
            </div>
          </div>

          <!-- Table View -->
          <div *ngIf="section.ui.type === 'table'" class="table-container">
            <table mat-table [dataSource]="section.data" class="w-full">
              <ng-container *ngFor="let col of section.ui.columns" [matColumnDef]="col.key">
                <th mat-header-cell *matHeaderCellDef> {{ col.label }} </th>
                <td mat-cell *matCellDef="let element"> {{ element[col.key] }} </td>
              </ng-container>

              <tr mat-header-row *matHeaderRowDef="getColumns(section)"></tr>
              <tr mat-row *matRowDef="let row; columns: getColumns(section);"></tr>
            </table>
            
            <div *ngIf="!section.data?.length" class="p-4 text-center text-gray-500">
              No data available
            </div>
          </div>

        </div>
      </mat-tab>
    </mat-tab-group>
  </div>
</div>
