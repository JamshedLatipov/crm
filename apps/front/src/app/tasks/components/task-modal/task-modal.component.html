<div class="task-modal-overlay" *ngIf="isOpen()" (click)="close()">
  <div class="task-modal" (click)="$event.stopPropagation()">
    <!-- Header -->
    <div class="modal-header">
      <h2>{{ config().mode === 'edit' ? 'Редактировать задачу' : 'Новая задача' }}</h2>
      <button mat-icon-button (click)="close()" class="close-btn">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Loading State -->
    <div *ngIf="isLoading()" class="loading-state">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Загрузка...</p>
    </div>

    <!-- Form -->
    <form *ngIf="!isLoading()" [formGroup]="form" (ngSubmit)="save()" class="modal-body">
      <!-- Title -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Название задачи</mat-label>
        <input 
          matInput 
          formControlName="title" 
          placeholder="Введите название задачи"
          required />
        <mat-icon matPrefix>title</mat-icon>
        <mat-error *ngIf="form.get('title')?.hasError('required')">
          Название обязательно
        </mat-error>
        <mat-error *ngIf="form.get('title')?.hasError('minlength')">
          Минимум 3 символа
        </mat-error>
      </mat-form-field>

      <!-- Description -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Описание</mat-label>
        <textarea 
          matInput 
          formControlName="description" 
          rows="3"
          placeholder="Опишите задачу"></textarea>
        <mat-icon matPrefix>description</mat-icon>
      </mat-form-field>

      <!-- Status and Assignee Row -->
      <div class="form-row">
        <mat-form-field appearance="outline" class="half-width">
          <mat-label>Статус</mat-label>
          <mat-select formControlName="status" required>
            <mat-option *ngFor="let status of statusOptions" [value]="status.value">
              {{ status.label }}
            </mat-option>
          </mat-select>
          <mat-icon matPrefix>flag</mat-icon>
        </mat-form-field>

        <app-user-selector
          formControlName="assignedToId"
          label="Исполнитель"
          placeholder="Не назначено"
          typeFor="task"
          [required]="false"
          icon="person"
          class="half-width">
        </app-user-selector>
      </div>

      <!-- Task Type -->
      <app-task-type-select
        formControlName="taskTypeId"
        [taskTypes]="taskTypes"
        (selectionChange)="onTaskTypeChange($event)"
        class="full-width">
      </app-task-type-select>

      <!-- Auto Calculate Toggle -->
      <div class="auto-calculate-section" *ngIf="form.get('taskTypeId')?.value">
        <mat-slide-toggle 
          formControlName="autoCalculateDueDate"
          color="primary"
          (change)="onAutoCalculateToggle($event.checked)">
          Автоматический расчет дедлайна
        </mat-slide-toggle>
        
        <div class="calculated-deadline" *ngIf="form.get('autoCalculateDueDate')?.value && calculatedDueDate">
          <mat-icon>event</mat-icon>
          <span>{{ formatDate(calculatedDueDate) }}</span>
        </div>
      </div>

      <!-- Date Picker (only if auto calculate is off) -->
      <mat-form-field 
        appearance="outline" 
        class="full-width"
        *ngIf="!form.get('autoCalculateDueDate')?.value || !form.get('taskTypeId')?.value">
        <mat-label>Срок выполнения</mat-label>
        <input 
          matInput 
          [matDatepicker]="picker" 
          formControlName="dueDate"
          placeholder="Выберите дату" />
        <mat-datepicker-toggle matSuffix [for]="picker"></mat-datepicker-toggle>
        <mat-datepicker #picker></mat-datepicker>
        <mat-icon matPrefix>event</mat-icon>
      </mat-form-field>

      <!-- Actions -->
      <div class="modal-actions">
        <button 
          mat-button 
          type="button" 
          (click)="close()"
          [disabled]="isSaving()">
          Отмена
        </button>
        <button 
          mat-raised-button 
          color="primary" 
          type="submit"
          [disabled]="form.invalid || isSaving()">
          <mat-spinner *ngIf="isSaving()" diameter="20" class="button-spinner"></mat-spinner>
          <span *ngIf="!isSaving()">{{ config().mode === 'edit' ? 'Обновить' : 'Создать' }}</span>
        </button>
      </div>
    </form>
  </div>
</div>
