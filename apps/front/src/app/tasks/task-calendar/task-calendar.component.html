<div class="calendar">
  <div class="calendar-header">
    <div class="nav-left">
      <button class="btn" (click)="prevMonth()">‹</button>
      <div class="month">
        <ng-container *ngIf="viewMode === 'month'">{{ monthNames[active.getMonth()] }} {{ active.getFullYear() }}</ng-container>
        <ng-container *ngIf="viewMode === 'week'">Неделя {{ active | date:'d MMM' }}</ng-container>
        <ng-container *ngIf="viewMode === 'work-week'">Рабочая неделя {{ active | date:'d MMM' }}</ng-container>
        <ng-container *ngIf="viewMode === 'year'">{{ active.getFullYear() }}</ng-container>
      </div>
      <button class="btn" (click)="nextMonth()">›</button>
    </div>

    <div class="view-modes">
      <button class="mode-btn" [class.active]="viewMode==='month'" (click)="setView('month')">Месяц</button>
      <button class="mode-btn" [class.active]="viewMode==='week'" (click)="setView('week')">Неделя</button>
      <button class="mode-btn" [class.active]="viewMode==='work-week'" (click)="setView('work-week')">Рабочая неделя</button>
      <button class="mode-btn" [class.active]="viewMode==='year'" (click)="setView('year')">Год</button>
    </div>
  </div>

  <!-- Month view -->
  <div *ngIf="viewMode==='month'" class="calendar-grid">
    <div class="weekday" *ngFor="let w of ['Пн','Вт','Ср','Чт','Пт','Сб','Вс']">{{ w }}</div>

    <ng-container *ngFor="let week of weeks">
      <ng-container *ngFor="let cell of week; trackBy: trackByDate">
        <div class="day" [class.empty]="!cell?.date" [class.today]="cell?.isToday">
          <div class="day-number" *ngIf="cell?.date">{{ cell.date.getDate() }}</div>
          <div class="tasks">
            <div
              class="task"
              *ngFor="let t of (cell?.tasks || []) | slice:0:maxTasksPerCell"
              [attr.title]="t.title"
              [style.border-left]="t.color ? '4px solid ' + t.color : '4px solid rgba(59,130,246,0.16)'"
            >
              <span class="task-title">{{ t.title }}</span>
            </div>
            <div class="more" *ngIf="(cell?.tasks?.length || 0) > maxTasksPerCell">+{{ (cell?.tasks.length || 0) - maxTasksPerCell }}</div>
          </div>
        </div>
      </ng-container>
    </ng-container>
  </div>

  <!-- Week / Work-week view -->
  <div *ngIf="viewMode==='week' || viewMode==='work-week'" class="week-grid" [style.--week-days]="weekDays.length">
    <div class="weekday" *ngFor="let wd of weekDays">{{ wd.date | date:'EEE' }}</div>
    <ng-container *ngFor="let wd of weekDays; trackBy: trackByDate">
      <div class="day" [class.today]="wd.isToday">
        <div class="day-number">{{ wd.date | date:'d' }}</div>
        <div class="tasks">
          <div class="task" *ngFor="let t of (wd.tasks || []) | slice:0:maxTasksPerCell" [attr.title]="t.title" [style.border-left]="t.color ? '4px solid ' + t.color : '4px solid rgba(59,130,246,0.16)'">
            <span class="task-title">{{ t.title }}</span>
          </div>
          <div class="more" *ngIf="(wd.tasks?.length || 0) > maxTasksPerCell">+{{ (wd.tasks.length || 0) - maxTasksPerCell }}</div>
        </div>
      </div>
    </ng-container>
  </div>

  <!-- Year view -->
  <div *ngIf="viewMode==='year'" class="year-grid">
    <div class="month-card" *ngFor="let m of months" (click)="goToMonth(m.index)">
      <div class="month-name">{{ m.name }}</div>
      <div class="month-count">{{ m.tasksCount }} задач</div>
    </div>
  </div>
</div>
