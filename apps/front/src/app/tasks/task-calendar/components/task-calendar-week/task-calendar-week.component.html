<div class="week-grid"
  #grid
  [style.--day-count]="weekDays.length"
  [style.--hour-rows]="weekHours.length"
  [style.--hour-row-height.px]="hourRowHeight"
  [style.--header-height.px]="headerHeight"
  [style.--row-gap.px]="rowGap">
  <!-- top-left corner -->
  <div class="corner"></div>

  <!-- day headers -->
  <ng-container *ngFor="let wd of weekDays">
    <div class="day-header">{{ wd.date | date:'EEE d' }}</div>
  </ng-container>

  <!-- overlay container per day to render spanning tasks (absolute positioning) -->
  <!-- Spans layer: absolutely positioned overlays so they don't affect grid layout -->
  <div class="spans-layer" *ngIf="weekDays?.length">
      <ng-container *ngFor="let wd of weekDays; let di = index">
      <ng-container *ngFor="let s of (wd.tasksWithSpan || [])">
        <div class="span-task"
          [style.left.px]="computeSpanLayoutLeft(di, s)"
          [style.width.px]="computeSpanLayoutWidth(di, s)"
          [style.top.px]="computeTop(s.startIdx)"
          [style.height.px]="computeHeight(s.span)"
          [attr.title]="s.task.title"
          [style.border-left]="s.task.color ? '4px solid ' + s.task.color : '4px solid rgba(59,130,246,0.16)'">
          <div class="span-title">{{ s.task.title }}</div>
        </div>
      </ng-container>
      <!-- multi-day spans that cover several day columns (may also have hour ranges) -->
      <ng-container *ngFor="let m of (wd.multiDaySpans || [])">
        <div class="span-task multi-day"
          [style.left.px]="computeSpanLeft(m.startDay)"
          [style.width.px]="computeSpanWidth(m.startDay, m.daySpan)"
          [style.top.px]="computeTop(m.startIdx)"
          [style.height.px]="computeHeight(m.spanHours)"
          [attr.title]="m.task.title"
          [style.border-left]="m.task.color ? '4px solid ' + m.task.color : '4px solid rgba(59,130,246,0.16)'">
          <div class="span-title">{{ m.task.title }}</div>
        </div>
      </ng-container>
    </ng-container>
  </div>

  <!-- rows: for each hour, render label + day cells -->
  <ng-container *ngFor="let h of weekHours; let hi = index">
    <div class="hour-label">{{ h }}:00</div>
    <ng-container *ngFor="let wd of weekDays; trackBy: trackByDate; let di = index">
      <div class="hour-cell" [class.today]="wd.isToday && weekHours[hi] === currentHour">
        <button class="small-add" (click)="openCreate.emit({ date: wd.date, hour: weekHours[hi] }); $event.stopPropagation()">+</button>
        <div class="hour-tasks">
          <div class="task" *ngFor="let t of (wd.tasksByHour?.[hi] || []) | slice:0:maxTasksPerCell" [attr.title]="t.title" [style.border-left]="t.color ? '4px solid ' + t.color : '4px solid rgba(59,130,246,0.16)'"><span class="task-title">{{ t.title }}</span></div>
          <div class="more" *ngIf="(wd.tasksByHour?.[hi]?.length || 0) > maxTasksPerCell">+{{ (wd.tasksByHour?.[hi].length || 0) - maxTasksPerCell }}</div>
        </div>
      </div>
    </ng-container>
  </ng-container>
</div>
