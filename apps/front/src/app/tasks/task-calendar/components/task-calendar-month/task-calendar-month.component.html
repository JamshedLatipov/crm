<div class="calendar-grid" #grid>
  <div class="weekday" *ngFor="let w of ['Пн','Вт','Ср','Чт','Пт','Сб','Вс']">{{ w }}</div>

  <ng-container *ngFor="let week of weeks">
    <ng-container *ngFor="let cell of week; trackBy: trackByDate">
      <div class="day" [class.empty]="!cell?.date" [class.today]="cell?.isToday">
        <div class="day-number" *ngIf="cell?.date">{{ cell.date.getDate() }}</div>
        <button class="add-btn" *ngIf="cell?.date" (click)="openCreate.emit(cell.date); $event.stopPropagation()">+</button>
        <div class="tasks">
          <div
            class="task"
            *ngFor="let t of (cell?.tasks || []) | slice:0:maxTasksPerCell"
            [attr.title]="t.title"
            [style.border-left]="t.color ? '4px solid ' + t.color : '4px solid rgba(59,130,246,0.16)'"
          >
            <span class="task-title">{{ t.title }}</span>
          </div>
          <div class="more" *ngIf="(cell?.tasks?.length || 0) > maxTasksPerCell">+{{ (cell?.tasks.length || 0) - maxTasksPerCell }}</div>
        </div>
      </div>
    </ng-container>
  </ng-container>
  
  <!-- absolute overlays for multi-day spans (optional: render when cell.tasksWithSpan exists) -->
  <div class="spans-layer" *ngIf="weeks?.length">
    <ng-container *ngFor="let week of weeks; let wi = index">
      <ng-container *ngFor="let cell of week; let di = index">
        <ng-container *ngFor="let s of (cell?.tasksWithSpan || [])">
          <div class="span-task"
              [class.continues-from-prev]="s.continuesFromPrev"
              [class.continues-to-next]="s.continuesToNext"
              [style.left.px]="computeSpanLeft(wi, di)"
              [style.top.px]="computeSpanTop(wi, di, s.continuesFromPrev)"
              [style.width.px]="computeSpanWidth(wi, di, s.spanDays || 1)"
              [style.height.px]="computeSpanHeight(s.continuesFromPrev, s.continuesToNext)"
              [attr.title]="s.task.title"
              [style.border-left]="s.task.color ? '4px solid ' + s.task.color : '4px solid rgba(59,130,246,0.16)'">
              <div class="span-title">{{ s.task.title }}</div>
            </div>
        </ng-container>
      </ng-container>
    </ng-container>
  </div>
</div>
