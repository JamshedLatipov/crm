<div class="calendar-grid" #grid>
  <div class="weekday" *ngFor="let w of ['Пн','Вт','Ср','Чт','Пт','Сб','Вс']">{{ w }}</div>

  <ng-container *ngFor="let week of weeks">
    <ng-container *ngFor="let cell of week; trackBy: trackByDate">
      <div class="day" [class.empty]="!cell?.date" [class.today]="cell?.isToday">
        <div class="day-number" *ngIf="cell?.date">{{ cell.date.getDate() }}</div>
        <button class="add-btn" *ngIf="cell?.date" (click)="openCreate.emit(cell.date); $event.stopPropagation()">+</button>
      </div>
    </ng-container>
  </ng-container>
  
  <!-- absolute overlays for multi-day spans -->
  <div class="spans-layer" *ngIf="weeks?.length">
    <ng-container *ngFor="let week of weeks; let wi = index">
      <ng-container *ngFor="let cell of week; let di = index">
        <ng-container *ngFor="let s of (cell?.tasksWithSpan || [])">
          <div class="span-task"
              [class.single-day]="s.spanDays === 1"
              [class.continues-from-prev]="s.continuesFromPrev"
              [class.continues-to-next]="s.continuesToNext"
              [style.left.px]="computeSpanLeft(wi, di)"
              [style.top.px]="computeSpanTop(wi, di, s.continuesFromPrev, s.spanIndex || 0)"
              [style.width.px]="computeSpanWidth(wi, di, s.spanDays || 1)"
              [attr.title]="getTaskTooltip(s.task)"
              [style.border-left]="s.task.color ? '3px solid ' + s.task.color : '3px solid rgba(59,130,246,0.16)'"
              (click)="taskClick.emit(s.task); $event.stopPropagation()">
              <span class="priority-indicator" [class]="'priority-' + (s.task.priority || 'medium')"></span>
              <span class="span-title">{{ s.task.title }}</span>
            </div>
        </ng-container>
      </ng-container>
    </ng-container>
  </div>
</div>

<!-- Menu для показа всех задач -->
<mat-menu #taskMenu="matMenu" class="task-list-menu">
  <ng-template matMenuContent let-tasks="tasks" let-date="date">
    <div class="task-menu-header" (click)="$event.stopPropagation()">
      <strong>Задачи на {{ date | date:'d MMMM':'':'ru' }}</strong>
      <span class="task-menu-count">({{ tasks?.length || 0 }})</span>
    </div>
    <button 
      mat-menu-item 
      *ngFor="let task of tasks"
      (click)="taskClick.emit(task)">
      <span class="priority-indicator" [class]="'priority-' + (task.priority || 'medium')"></span>
      <span class="task-menu-title">{{ task.title }}</span>
      <span class="task-menu-status" [class]="'status-' + task.status">{{ getStatusLabel(task.status) }}</span>
    </button>
  </ng-template>
</mat-menu>
