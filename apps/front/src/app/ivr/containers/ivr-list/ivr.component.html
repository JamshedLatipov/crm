<!-- Page Header -->
<div class="page-header">
  <div class="header-content">
    <div class="header-icon">
      <mat-icon>dialpad</mat-icon>
    </div>
    <div class="header-text">
      <h1>Управление IVR</h1>
      <p class="subtitle">Интерактивное голосовое меню и автоматизация звонков</p>
    </div>
  </div>
  <div class="header-actions">
    <button mat-stroked-button (click)="reload()">
      <mat-icon>refresh</mat-icon>
      Обновить
    </button>
    <button mat-raised-button color="primary" (click)="newRoot()">
      <mat-icon>add</mat-icon>
      Добавить корень
    </button>
  </div>
</div>

<div class="container">
  <!-- Roots Panel -->
  <div class="panel roots-panel">
    <div class="panel-header">
      <div class="panel-title">
        <mat-icon>account_tree</mat-icon>
        <h3>Корневые элементы</h3>
      </div>
      <span class="panel-badge">{{ rootNodes.length }}</span>
    </div>
    
    <div class="panel-content" *ngIf="rootNodes.length > 0; else emptyRoots">
      <div 
        cdkDropList 
        (cdkDropListDropped)="dropRoot($event)"
        class="ivr-list"
      >
        <div
          *ngFor="let r of rootNodes; let i = index"
          cdkDrag
          (click)="select(r)"
          [class.selected]="selected?.id === r.id"
          class="ivr-item"
          tabindex="0"
        >
          <div class="drag-handle" cdkDragHandle>
            <mat-icon>drag_indicator</mat-icon>
          </div>
          <div class="item-icon">
            <mat-icon>device_hub</mat-icon>
          </div>
          <div class="item-content">
            <div class="item-title">{{ r.name || '(без названия)' }}</div>
            <div class="item-meta">
              <span class="action-badge">{{ actionLabels[r.action] || r.action }}</span>
              <span *ngIf="r.digit" class="digit-badge">Клавиша: {{ r.digit }}</span>
            </div>
          </div>
          <div class="item-actions">
            <button
              mat-icon-button
              color="primary"
              (click)="$event.stopPropagation(); onNodeEdit(r)"
              matTooltip="Редактировать"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <button
              mat-icon-button
              color="warn"
              (click)="$event.stopPropagation(); onNodeDelete(r)"
              matTooltip="Удалить"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        </div>
      </div>
    </div>

    <ng-template #emptyRoots>
      <div class="empty-state">
        <mat-icon>account_tree</mat-icon>
        <p>Нет корневых элементов</p>
        <button mat-stroked-button (click)="newRoot()">
          <mat-icon>add</mat-icon>
          Создать первый элемент
        </button>
      </div>
    </ng-template>
  </div>

  <!-- Tree Panel -->
  <div class="panel children-panel">
    <div class="panel-header">
      <div class="panel-title">
        <mat-icon>account_tree</mat-icon>
        <h3>Структура дерева</h3>
      </div>
      <button 
        mat-mini-fab 
        color="primary" 
        (click)="newChild()"
        matTooltip="Добавить дочерний элемент"
        class="add-child-btn"
        [disabled]="!treeRoot?.id"
      >
        <mat-icon>add</mat-icon>
      </button>
    </div>
    
    <div class="panel-content">
      <!-- Show tree when tree root is selected -->
      <ng-container *ngIf="treeRoot?.id">
        <div class="tree-container" *ngIf="childrenOfTreeRoot().length > 0; else emptyChildren">
          <app-ivr-tree-node
            *ngFor="let child of childrenOfTreeRoot()"
            [node]="child"
            [children]="getNodeChildren(child.id)"
            [selectedId]="selected?.id"
            [level]="0"
            [actionLabels]="actionLabels"
            [allNodes]="allNodes"
            [lazyLoad]="true"
            [expandOnSelect]="false"
            (onSelect)="onNodeSelect($event)"
            (onAddChild)="onNodeAddChild($event)"
            (onEdit)="onNodeEdit($event)"
            (onDelete)="onNodeDelete($event)"
            (onLoadChildren)="handleLoadChildren($event)"
          ></app-ivr-tree-node>
        </div>

        <ng-template #emptyChildren>
          <div class="empty-state small">
            <mat-icon>inbox</mat-icon>
            <p>Нет дочерних элементов</p>
          </div>
        </ng-template>
      </ng-container>

      <!-- Show prompt when no parent is selected -->
      <div class="empty-state" *ngIf="!selected?.id">
        <mat-icon>touch_app</mat-icon>
        <p>Выберите корневой элемент</p>
        <small>Выберите элемент слева для просмотра его дочерних элементов</small>
      </div>
    </div>
  </div>

  <!-- Editor Panel -->
  <!-- Editor removed: editing is now performed in modal dialog -->
</div>
