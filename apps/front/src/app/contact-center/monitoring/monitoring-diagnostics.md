# Диагностика онлайн-мониторинга

## Проблемы, которые были обнаружены и исправлены:

### 1. **Утечка памяти** ❌ → ✅ ИСПРАВЛЕНО
**Проблема:** Компонент подписывался на 4 observable (operators$, queues$, activeCalls$, stats$), но не отписывался при уничтожении.

**Исправление:**
- Добавлен `OnDestroy` интерфейс
- Добавлен `destroy$` Subject для управления отписками
- Все подписки теперь используют `.pipe(takeUntil(this.destroy$))`
- В `ngOnDestroy()` вызывается `destroy$.next()` и `destroy$.complete()`

### 2. **Недостаточная валидация данных** ❌ → ✅ ИСПРАВЛЕНО
**Проблема:** Данные от сервера не валидировались, что могло приводить к ошибкам отображения.

**Исправление:**
- Добавлена проверка `Array.isArray()` для всех массивов
- Добавлены проверки на отрицательные значения
- Добавлены предупреждения для несогласованных данных (оператор на звонке без currentCall)

### 3. **Недостаточное логирование** ❌ → ✅ ИСПРАВЛЕНО
**Проблема:** Было сложно отследить проблемы с данными.

**Исправление:**
- Добавлено детальное логирование для каждого обновления данных
- Логируются все операторы с их статусами и длительностью
- Логируются все очереди с ожидающими и активными звонками
- Логируются computed values для отслеживания расчетов

### 4. **Проблемы с подсчетом метрик** ⚠️ ТРЕБУЕТ ПРОВЕРКИ
**Возможная проблема:** 
- `totalActiveCalls()` = сумма `callsInService` из очередей
- `operatorsOnCall()` = количество операторов со статусом `on_call`
- Эти значения могут не совпадать!

**Что проверить:**
- Правильно ли backend подсчитывает `callsInService` для каждой очереди?
- Не дублируются ли операторы в разных очередях при подсчете?
- Правильно ли определяется статус оператора (`on_call`)?

### 5. **Проблемы с AMI данными** ⚠️ ИСПРАВЛЕНО В BACKEND
**Проблема в backend:** Обработчики событий AMI не удалялись корректно, что могло приводить к утечкам памяти и дублированию событий.

**Исправление в contact-center.service.ts:**
- Добавлена функция `cleanup()` для корректного удаления обработчиков
- Добавлен флаг `resolved` для предотвращения повторной обработки событий
- Улучшен поиск активных каналов операторов (проверка `ConnectedLineNum` и состояния канала)
- Улучшено извлечение длительности звонка (проверка полей `Duration`, `Seconds`, `duration`)

## Как проверить работу мониторинга:

### 1. Откройте консоль браузера (F12)

### 2. Проверьте WebSocket подключение:
```
[ContactCenter] WebSocket connected!
```

### 3. Проверьте обновления данных (каждые 3 секунды):
```
[OnlineMonitoring] ===== OPERATORS UPDATE =====
[OnlineMonitoring] Operators received: N
  [0] Operator1: status=idle, statusDuration=XXs, currentCall=null, currentCallDuration=null
  ...

[OnlineMonitoring] ===== QUEUES UPDATE =====
  [0] Queue1:
      waiting: X
      callsInService: Y
      ...

[OnlineMonitoring] ===== STATS UPDATE =====
  totalUniqueWaiting: X

[Computed] totalActiveCalls (callsInService sum): X
[Computed] totalWaiting (from stats): X
[Computed] operatorsOnCall: X
```

### 4. Проверьте согласованность данных:

**Должно быть TRUE:**
- `totalWaiting` (из stats) ≤ сумма `waiting` по всем очередям (могут быть дубликаты)
- `totalActiveCalls` ≈ `operatorsOnCall` (могут немного отличаться из-за timing)
- Если оператор `status=on_call`, то должен быть `currentCall` и `currentCallDuration > 0`

**Предупреждения в консоли:**
- `WARNING: Operator X is on_call but has no currentCall` - оператор помечен как на звонке, но нет данных о звонке
- `WARNING: Operator X has currentCall but no duration` - есть звонок, но нет длительности
- `ERROR: Queue X has negative values!` - очередь имеет отрицательные значения (критическая ошибка)

### 5. Проверьте обновление UI:

Счетчики должны обновляться каждые 3 секунды:
- "Операторы онлайн: X/Y"
- "Активные звонки: X" (в работе · Y ожидают)
- Таблицы операторов и очередей
- График статусов операторов

### 6. Проверьте отсутствие утечек памяти:

1. Откройте Chrome DevTools -> Performance -> Memory
2. Сделайте heap snapshot
3. Переключитесь между страницами несколько раз
4. Сделайте еще один heap snapshot
5. Проверьте, что количество `OnlineMonitoringComponent` = 0 (если компонент не открыт)

## Известные особенности:

1. **Delay в обновлении:** Данные обновляются каждые 3 секунды, поэтому может быть задержка до 3 секунд между реальным событием и отображением.

2. **totalActiveCalls vs operatorsOnCall:** Эти метрики могут отличаться:
   - `totalActiveCalls` - сколько звонков обрабатывается в очередях (по данным AMI)
   - `operatorsOnCall` - сколько операторов имеют статус "на звонке"
   - Разница может быть из-за звонков вне очередей или timing issues

3. **totalWaiting (unique) vs sum(waiting):** 
   - `totalWaiting` из stats - уникальные каналы в ожидании
   - Сумма `waiting` по очередям - может быть больше, если есть дубликаты
   - Backend отслеживает `assignedChannels` для предотвращения дублирования

## Что делать, если мониторинг работает неправильно:

### Проблема: Данные не обновляются

**Решение:**
1. Проверьте WebSocket подключение в консоли
2. Проверьте, что backend запущен: `yarn start:back`
3. Проверьте gateway логи: должны быть сообщения `Broadcasting: operators = ...`
4. Проверьте network tab: должны быть ws:// соединения

### Проблема: Неправильные значения счетчиков

**Решение:**
1. Проверьте логи в консоли - там выводятся детальные данные
2. Сравните значения из разных источников:
   - Операторы в таблице vs `activeOperators()`
   - Очереди waiting vs `totalWaiting()`
3. Проверьте backend логи: `apps/back/src/app/modules/contact-center/contact-center.service.ts`
4. Используйте debug endpoints:
   - `/api/contact-center/debug/cdr-sample`
   - `/api/contact-center/debug/members`

### Проблема: Утечки памяти

**Решение:**
1. Проверьте, что в консоли появляется:
   ```
   [OnlineMonitoring] Component destroyed, cleaning up subscriptions
   ```
2. Проверьте heap snapshots (см. выше)
3. Если утечка все еще есть - проверьте другие подписки в приложении

## Чеклист перед развертыванием:

- [ ] WebSocket подключается успешно
- [ ] Данные обновляются каждые 3 секунды
- [ ] Нет ошибок в консоли браузера
- [ ] Нет предупреждений о некорректных данных
- [ ] `totalActiveCalls` ≈ `operatorsOnCall` (±1-2)
- [ ] `totalWaiting` ≤ sum(queue.waiting)
- [ ] Нет утечек памяти при переключении страниц
- [ ] Операторы на звонке отображаются корректно
- [ ] Длительность звонков обновляется в реальном времени
- [ ] График статусов операторов обновляется
