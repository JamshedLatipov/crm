<div class="contacts-upload-container">
  <div class="header">
    <button mat-icon-button (click)="back()">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>Загрузка контактов</h1>
  </div>

  <mat-card>
    <mat-card-header>
      <mat-card-title>Загрузить CSV файл с контактами</mat-card-title>
      <mat-card-subtitle>
        Формат: phone, name, customData (JSON)
      </mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <!-- Template download -->
      <div class="template-section">
        <p>
          <mat-icon>info</mat-icon>
          Скачайте шаблон CSV файла для правильного формата данных
        </p>
        <button mat-stroked-button color="primary" (click)="downloadTemplate()">
          <mat-icon>download</mat-icon>
          Скачать шаблон
        </button>
      </div>

      <!-- Upload area -->
      <div
        class="upload-area"
        [class.drag-over]="dragOver()"
        (dragover)="onDragOver($event)"
        (dragleave)="onDragLeave($event)"
        (drop)="onDrop($event)"
      >
        @if (selectedFile()) {
          <div class="file-selected">
            <mat-icon>description</mat-icon>
            <div class="file-info">
              <span class="file-name">{{ selectedFile()!.name }}</span>
              <span class="file-size">{{ (selectedFile()!.size / 1024).toFixed(2) }} KB</span>
            </div>
            <button mat-icon-button (click)="clearFile()" [disabled]="uploading()">
              <mat-icon>close</mat-icon>
            </button>
          </div>
        } @else {
          <div class="upload-prompt">
            <mat-icon>cloud_upload</mat-icon>
            <p>Перетащите CSV файл сюда или нажмите кнопку ниже</p>
            <input
              type="file"
              #fileInput
              accept=".csv"
              (change)="onFileSelected($event)"
              style="display: none"
            />
            <button mat-raised-button color="primary" (click)="fileInput.click()">
              <mat-icon>attach_file</mat-icon>
              Выбрать файл
            </button>
          </div>
        }
      </div>

      <!-- Progress bar -->
      @if (uploading()) {
        <div class="progress-section">
          <mat-progress-bar mode="determinate" [value]="uploadProgress()"></mat-progress-bar>
          <p>Загрузка... {{ uploadProgress() }}%</p>
        </div>
      }

      <!-- Upload result -->
      @if (uploadResult()) {
        <div class="result-section">
          <h3>Результат загрузки</h3>
          <div class="result-stats">
            <div class="stat success">
              <mat-icon>check_circle</mat-icon>
              <div>
                <span class="label">Добавлено</span>
                <span class="value">{{ uploadResult()!.added }}</span>
              </div>
            </div>
            <div class="stat warning">
              <mat-icon>warning</mat-icon>
              <div>
                <span class="label">Пропущено</span>
                <span class="value">{{ uploadResult()!.skipped }}</span>
              </div>
            </div>
          </div>

          @if (uploadResult()!.errors && uploadResult()!.errors!.length > 0) {
            <div class="errors-section">
              <h4>Ошибки:</h4>
              <ul>
                @for (error of uploadResult()!.errors; track $index) {
                  <li>{{ error }}</li>
                }
              </ul>
            </div>
          }
        </div>
      }
    </mat-card-content>
    <mat-card-actions>
      <button
        mat-raised-button
        color="primary"
        (click)="uploadFile()"
        [disabled]="!selectedFile() || uploading()"
      >
        <mat-icon>upload</mat-icon>
        Загрузить контакты
      </button>
      <button mat-button (click)="back()">Отмена</button>
    </mat-card-actions>
  </mat-card>
</div>
