<div class="dialog-container">
  <div class="dialog-header">
    <h2 class="dialog-title">
      {{ isEditMode ? 'Редактирование скрипта' : 'Создание скрипта' }}
    </h2>
    <p class="dialog-subtitle">
      {{
        isEditMode
          ? 'Обновите информацию о скрипте звонка'
          : 'Создайте новый скрипт для операторов контакт-центра'
      }}
    </p>
  </div>

  <mat-dialog-content class="dialog-content">
    <form class="script-form" #form="ngForm">
      <!-- Parent Script Info Banner (when creating child) -->
      <div class="parent-info-banner" *ngIf="parentScript && !isEditMode">
        <mat-icon class="banner-icon">account_tree</mat-icon>
        <div class="banner-content">
          <span class="banner-label">Дочерний для:</span>
          <strong class="parent-name">{{ parentScript.title }}</strong>
          <span class="category-badge" *ngIf="parentScript.category">
            <mat-icon>label</mat-icon>
            {{ parentScript.category.name }}
          </span>
        </div>
      </div>

      <!-- Basic Information Section -->
      <div class="form-section">
        <h3 class="section-title">
          <mat-icon>info</mat-icon>
          Основная информация
        </h3>

        <div class="form-grid">
          <mat-form-field appearance="outline" class="modern-field">
            <mat-label
              >Название скрипта
              <span class="required-indicator">*</span></mat-label
            >
            <input
              matInput
              [(ngModel)]="script.title"
              name="title"
              required
              placeholder="Введите название скрипта"
            />
          </mat-form-field>

          <mat-form-field appearance="outline" class="modern-field">
            <mat-label
              >Категория <span class="required-indicator">*</span></mat-label
            >
            <mat-select
              [(ngModel)]="script.categoryId"
              name="categoryId"
              required
            >
              <mat-option
                *ngFor="let category of categories()"
                [value]="category.id"
              >
                {{ category.name }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="modern-field">
            <mat-label>Родительский скрипт</mat-label>
            <mat-select
              [(ngModel)]="script.parentId"
              name="parentId"
              [disabled]="parentScript && !isEditMode"
            >
              <mat-option value="">Нет родителя (корневой скрипт)</mat-option>
              <mat-option
                *ngFor="let availableScript of hierarchicalScripts()"
                [value]="availableScript.id"
                [disabled]="isEditMode && availableScript.id === script.id"
                [class.nested-option]="availableScript.depth && availableScript.depth > 0"
              >
                <span class="hierarchy-indent" [style.padding-left.px]="(availableScript.depth || 0) * 20">
                  {{ getScriptIndent(availableScript) }}{{ availableScript.title }}
                </span>
                <span class="parent-indicator" *ngIf="availableScript.parentId"> (дочерний)</span>
              </mat-option>
            </mat-select>
            <mat-hint *ngIf="parentScript && !isEditMode" class="parent-hint">
              <mat-icon class="hint-icon">lock</mat-icon>
              Родитель установлен автоматически и не может быть изменен
            </mat-hint>
            <mat-hint *ngIf="!parentScript" class="default-hint">
              <mat-icon class="hint-icon">info</mat-icon>
              Оставьте пустым для создания корневого скрипта
            </mat-hint>
          </mat-form-field>
        </div>

        <mat-form-field appearance="outline" class="modern-field">
          <mat-label>Описание</mat-label>
          <textarea
            matInput
            [(ngModel)]="script.description"
            name="description"
            rows="3"
            placeholder="Краткое описание скрипта"
          ></textarea>
        </mat-form-field>

        <mat-checkbox
          [(ngModel)]="script.isActive"
          name="isActive"
          class="modern-checkbox"
        >
          Активный скрипт
        </mat-checkbox>
      </div>

      <!-- Steps Section -->
      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">
            <mat-icon>list_alt</mat-icon>
            Шаги скрипта
          </h3>
          <button
            mat-stroked-button
            color="primary"
            type="button"
            (click)="addStep()"
            class="add-button"
          >
            <mat-icon>add</mat-icon>
            Добавить шаг
          </button>
        </div>

        <div class="items-container">
          <div
            class="item-card"
            *ngFor="
              let step of script.steps;
              let i = index;
              trackBy: trackByIndex
            "
          >
            <mat-form-field
              appearance="outline"
              class="modern-field item-field"
            >
              <mat-label>Шаг {{ i + 1 }}</mat-label>
              <input
                matInput
                [(ngModel)]="script.steps[i]"
                [name]="'step-' + i"
                placeholder="Описание шага разговора"
              />
            </mat-form-field>
            <button
              mat-icon-button
              color="warn"
              type="button"
              (click)="removeStep(i)"
              class="remove-button"
              matTooltip="Удалить шаг"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div *ngIf="script.steps.length === 0" class="empty-state">
            <mat-icon>description</mat-icon>
            <p>Добавьте шаги для скрипта разговора</p>
          </div>
        </div>
      </div>

      <!-- Questions Section -->
      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">
            <mat-icon>help</mat-icon>
            Вопросы
          </h3>
          <button
            mat-stroked-button
            color="primary"
            type="button"
            (click)="addQuestion()"
            class="add-button"
          >
            <mat-icon>add</mat-icon>
            Добавить вопрос
          </button>
        </div>

        <div class="items-container">
          <div
            class="item-card"
            *ngFor="
              let question of script.questions;
              let i = index;
              trackBy: trackByIndex
            "
          >
            <mat-form-field
              appearance="outline"
              class="modern-field item-field"
            >
              <mat-label>Вопрос {{ i + 1 }}</mat-label>
              <input
                matInput
                [(ngModel)]="script.questions[i]"
                [name]="'question-' + i"
                placeholder="Текст вопроса для уточнения"
              />
            </mat-form-field>
            <button
              mat-icon-button
              color="warn"
              type="button"
              (click)="removeQuestion(i)"
              class="remove-button"
              matTooltip="Удалить вопрос"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div *ngIf="script.questions.length === 0" class="empty-state">
            <mat-icon>help_outline</mat-icon>
            <p>Добавьте вопросы для уточнения деталей</p>
          </div>
        </div>
      </div>

      <!-- Tips Section -->
      <div class="form-section">
        <div class="section-header">
          <h3 class="section-title">
            <mat-icon>lightbulb</mat-icon>
            Полезные советы
          </h3>
          <button
            mat-stroked-button
            color="primary"
            type="button"
            (click)="addTip()"
            class="add-button"
          >
            <mat-icon>add</mat-icon>
            Добавить совет
          </button>
        </div>

        <div class="items-container">
          <div
            class="item-card"
            *ngFor="
              let tip of script.tips;
              let i = index;
              trackBy: trackByIndex
            "
          >
            <mat-form-field
              appearance="outline"
              class="modern-field item-field"
            >
              <mat-label>Совет {{ i + 1 }}</mat-label>
              <input
                matInput
                [(ngModel)]="script.tips[i]"
                [name]="'tip-' + i"
                placeholder="Текст полезного совета"
              />
            </mat-form-field>
            <button
              mat-icon-button
              color="warn"
              type="button"
              (click)="removeTip(i)"
              class="remove-button"
              matTooltip="Удалить совет"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>

          <div *ngIf="script.tips.length === 0" class="empty-state">
            <mat-icon>lightbulb_outline</mat-icon>
            <p>Добавьте полезные советы для операторов</p>
          </div>
        </div>
      </div>
    </form>
  </mat-dialog-content>

  <mat-dialog-actions class="dialog-actions">
    <button mat-stroked-button (click)="onCancel()" class="cancel-btn">
      <mat-icon>close</mat-icon>
      Отмена
    </button>
    <button
      mat-raised-button
      color="primary"
      (click)="onSave()"
      [disabled]="!form.valid || !script.title?.trim() || !script.categoryId"
      class="save-btn"
    >
      <mat-icon>{{ isEditMode ? 'save' : 'add' }}</mat-icon>
      {{ isEditMode ? 'Сохранить изменения' : 'Создать скрипт' }}
    </button>
  </mat-dialog-actions>
</div>
