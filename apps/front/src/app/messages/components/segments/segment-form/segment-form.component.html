<div class="segment-form-container">
  <div class="header">
    <button mat-icon-button (click)="cancel()" class="back-button">
      <mat-icon>arrow_back</mat-icon>
    </button>
    <h1>{{ title }}</h1>
  </div>

  @if (isLoading()) {
    <div class="loading-spinner">
      <mat-spinner></mat-spinner>
      <p>Загрузка...</p>
    </div>
  } @else {
    <mat-card>
      <mat-card-content>
        <form [formGroup]="segmentForm" (ngSubmit)="onSubmit()">
          <!-- Name Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Название сегмента</mat-label>
            <input
              matInput
              formControlName="name"
              placeholder="Введите название сегмента"
              required
            />
            <mat-icon matPrefix>label</mat-icon>
            @if (segmentForm.get('name')?.hasError('required') && segmentForm.get('name')?.touched) {
              <mat-error>Название обязательно</mat-error>
            }
            @if (segmentForm.get('name')?.hasError('minlength')) {
              <mat-error>Минимум 2 символа</mat-error>
            }
          </mat-form-field>

          <!-- Description Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Описание</mat-label>
            <textarea
              matInput
              formControlName="description"
              placeholder="Введите описание сегмента"
              rows="3"
            ></textarea>
            <mat-icon matPrefix>description</mat-icon>
          </mat-form-field>

          <!-- Usage Type Field -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Тип использования</mat-label>
            <mat-select formControlName="usageType" required>
              @for (type of usageTypes; track type.value) {
                <mat-option [value]="type.value">
                  {{ type.label }}
                </mat-option>
              }
            </mat-select>
            <mat-icon matPrefix>category</mat-icon>
            @if (segmentForm.get('usageType')?.hasError('required') && segmentForm.get('usageType')?.touched) {
              <mat-error>Тип обязателен</mat-error>
            }
          </mat-form-field>

          <!-- Active Checkbox -->
          <div class="checkbox-field">
            <mat-checkbox formControlName="isActive">
              Активен
            </mat-checkbox>
            <p class="hint">Неактивные сегменты не отображаются в списке выбора</p>
          </div>

          <mat-divider></mat-divider>

          <!-- Filters Section -->
          <div class="filters-section">
            <div class="filters-header">
              <h3>Фильтры контактов</h3>
              <p class="filters-description">
                Настройте условия для выборки контактов с поддержкой группировки и вложенных условий
              </p>
            </div>

            <!-- Filter Group Component -->
            <app-segment-filter-group
              [group]="filterGroup()"
              [depth]="0"
              (groupChange)="onFilterGroupChange($event)"
            />

            <div class="filters-info">
              <mat-icon>info</mat-icon>
              <div>
                <p><strong>Возможности системы фильтров:</strong></p>
                <ul>
                  <li><strong>AND/OR логика</strong> — переключайте между "все условия" или "любое условие"</li>
                  <li><strong>Группировка</strong> — создавайте вложенные группы для сложных условий</li>
                  <li><strong>Индивидуальные операторы</strong> — каждая группа имеет свою логику</li>
                  <li><strong>Гибкость</strong> — комбинируйте условия и группы для точной выборки</li>
                </ul>
                <p class="example">
                  <strong>Пример:</strong> (Имя содержит "Иван" <strong>AND</strong> Email существует) <strong>OR</strong> (Компания = "ABC" <strong>AND</strong> Сделка > 10000)
                </p>
              </div>
            </div>
          </div>

          <!-- Actions -->
          <div class="form-actions">
            <button
              mat-button
              type="button"
              (click)="cancel()"
              [disabled]="isLoading()"
            >
              Отмена
            </button>
            <button
              mat-raised-button
              color="primary"
              type="submit"
              [disabled]="segmentForm.invalid || isLoading()"
            >
              @if (isLoading()) {
                <mat-spinner diameter="20"></mat-spinner>
              }
              {{ submitButtonText }}
            </button>
          </div>
        </form>
      </mat-card-content>
    </mat-card>
  }
</div>
