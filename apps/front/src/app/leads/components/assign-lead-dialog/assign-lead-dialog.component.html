<div class="dialog-header">
  <h2 mat-dialog-title>
    <mat-icon>person_add</mat-icon>
    Назначить ответственного
  </h2>
  <button mat-icon-button (click)="close()" class="close-button">
    <mat-icon>close</mat-icon>
  </button>
</div>

<mat-dialog-content class="dialog-content">
  <mat-card class="lead-info">
    <mat-card-content>
      <div class="lead-summary">
        <div class="lead-name">{{ data.lead.name }}</div>
        <div class="lead-details">
          <span *ngIf="data.lead.company">{{ data.lead.company }}</span>
          <span *ngIf="data.lead.email">{{ data.lead.email }}</span>
        </div>
        <div class="current-assignee" *ngIf="data.currentAssignee">
          Текущий ответственный:
          <mat-chip class="assignee-chip" selected>
            {{ getCurrentAssigneeName() }}
          </mat-chip>
        </div>
+
        <div class="no-assignee" *ngIf="!data.currentAssignee">
          <mat-icon>person_off</mat-icon>
          Ответственный не назначен
        </div>
      </div>
    </mat-card-content>
  </mat-card>

  <form [formGroup]="assignForm" class="assign-form">
    <mat-form-field class="full-width" appearance="outline">
      <mat-label>Тип назначения</mat-label>
      <mat-select formControlName="assignmentType">
        <mat-option value="single">Один ответственный</mat-option>
        <mat-option value="team">Команда</mat-option>
        <mat-option value="auto">Автоматическое распределение</mat-option>
      </mat-select>
      <mat-icon matSuffix>assignment_ind</mat-icon>
    </mat-form-field>

    <div *ngIf="assignForm.get('assignmentType')?.value === 'single'" class="manager-selection">
      <h3>Выберите менеджера</h3>
      <div class="managers-grid">
        <div *ngFor="let manager of availableManagers" class="manager-card"
             [class.selected]="selectedManager?.id === manager.id"
             [class.overloaded]="manager.isOverloaded"
             (click)="selectManager(manager)" tabindex="0" role="button">
          <div class="manager-avatar"><mat-icon>person</mat-icon></div>
          <div class="manager-info">
            <div class="manager-name">{{ manager.fullName }}</div>
            <div class="manager-role">{{ getRoleLabel(manager.roles) }}</div>
            <div class="manager-department">{{ manager.department }}</div>
            <div class="manager-workload" [class.high]="manager.isOverloaded">
              Активных лидов: {{ manager.currentLeadsCount }} / {{ manager.maxLeadsCapacity }}
            </div>
+          </div>
          <div class="manager-status">
            <mat-icon *ngIf="manager.isOverloaded" class="warning-icon">warning</mat-icon>
            <mat-icon *ngIf="!manager.isOverloaded && manager.isAvailableForAssignment" class="available-icon">check_circle</mat-icon>
          </div>
        </div>
      </div>
    </div>

    <div *ngIf="assignForm.get('assignmentType')?.value === 'team'" class="team-selection">
      <h3>Выберите команду</h3>
      <mat-selection-list [(ngModel)]="selectedTeamMembers" [multiple]="true">
        <mat-list-option *ngFor="let manager of availableManagers" [value]="manager.id" [disabled]="!manager.isAvailableForAssignment">
          <div class="team-member-item">
            <div class="member-avatar"><mat-icon>person</mat-icon></div>
            <div class="member-info">
              <div class="member-name">{{ manager.fullName }}</div>
              <div class="member-role">{{ getRoleLabel(manager.roles) }}</div>
+            </div>
            <mat-icon *ngIf="!manager.isAvailableForAssignment" class="warning-icon">block</mat-icon>
          </div>
        </mat-list-option>
      </mat-selection-list>
    </div>

    <div *ngIf="assignForm.get('assignmentType')?.value === 'auto'" class="auto-assignment">
      <mat-card class="auto-card">
        <mat-card-content>
          <div class="auto-info">
            <mat-icon class="auto-icon">auto_awesome</mat-icon>
            <div>
              <h4>Автоматическое назначение</h4>
              <p>Система автоматически назначит наиболее подходящего менеджера с подходящими навыками</p>
            </div>
          </div>

          <mat-form-field class="full-width" appearance="outline">
            <mat-label>Критерии назначения</mat-label>
            <mat-select formControlName="autoAssignCriteria" multiple>
              <mat-option value="workload">Наименьшая загрузка</mat-option>
              <mat-option value="expertise">Экспертиза в отрасле</mat-option>
              <mat-option value="performance">Лучшие показатели</mat-option>
              <mat-option value="geography">Географическое соотвествие</mat-option>
            </mat-select>
          </mat-form-field>
        </mat-card-content>
      </mat-card>
    </div>

    <mat-form-field class="full-width" appearance="outline">
      <mat-label>Комментарий к назначению</mat-label>
      <textarea matInput formControlName="notes" rows="3"></textarea>
      <mat-icon matSuffix>comment</mat-icon>
    </mat-form-field>

    <div class="priority-section">
      <mat-checkbox formControlName="highPriority">Приоритетное назначение</mat-checkbox>
      <mat-checkbox formControlName="notifyAssignee">Уведомить ответственного</mat-checkbox>
      <mat-checkbox formControlName="scheduleFollowUp">Запланировать follow-up</mat-checkbox>
    </div>
+
  </form>

  <div class="assignment-preview" *ngIf="getAssignmentPreview()">
    <h4>Предварительный просмотр назначения:</h4>
    <div class="preview-content">{{ getAssignmentPreview() }}</div>
  </div>
</mat-dialog-content>

<mat-dialog-actions class="dialog-actions">
  <button mat-button (click)="close()">Отмена</button>
  <button mat-raised-button color="primary" (click)="assignLead()" [disabled]="!isAssignmentValid() || loading">
    <mat-icon *ngIf="loading">hourglass_empty</mat-icon>
    <span *ngIf="!loading">Назначить</span>
    <span *ngIf="loading">Назначение...</span>
  </button>
</mat-dialog-actions>
+
