<div class="lead-detail-page">
  <!-- Загрузка -->
  <div *ngIf="loadingLead" class="loading-container">
    <mat-spinner diameter="40"></mat-spinner>
    <p>Загрузка лида...</p>
  </div>

  <!-- Ошибка -->
  <div *ngIf="error && !loadingLead" class="error-container">
    <div class="error-card">
      <mat-icon class="error-icon">sentiment_dissatisfied</mat-icon>
      <h3>Лид не найден</h3>
      <p>{{ error }}</p>
      <button mat-raised-button color="primary" (click)="goBack()">
        <mat-icon>arrow_back</mat-icon>
        Вернуться к списку
      </button>
    </div>
  </div>

  <!-- Детали лида -->
  <div *ngIf="lead && !loadingLead" class="lead-content">
    <!-- Заголовок с градиентом -->
    <div class="page-header">
      <div class="header-background">
        <div class="header-content">
          <div class="breadcrumb">
            <button mat-button (click)="goBack()" class="breadcrumb-link">
              <mat-icon>arrow_back</mat-icon>
              Лиды
            </button>
            <mat-icon class="separator">chevron_right</mat-icon>
            <span class="current">{{ lead.name }}</span>
          </div>

          <div class="lead-header-info">
            <div class="lead-main-info">
              <h1>{{ lead.name }}</h1>
              <div class="lead-meta">
                <div class="lead-score">
                  <span class="score-value">{{ lead.score }} очков</span>
                  <span class="score-probability"
                    >{{ lead.conversionProbability }}% конверсия</span
                  >
                </div>
                <div class="lead-source" *ngIf="lead.source">
                  <mat-icon>source</mat-icon>
                  <span>{{ getSourceLabel(lead.source) }}</span>
                </div>
              </div>
            </div>

            <div class="header-actions">
              <app-lead-actions
                [lead]="lead"
                layout="horizontal"
                size="medium"
                context="header"
                (editLead)="editLead()"
                (convertToDeal)="convertToDeal()"
                (contactLead)="contactLead()"
                (assignLead)="assignLead()"
                (changeStatus)="quickChangeStatus()"
                (createPromo)="createPromo()"
                (assignPromo)="assignPromoCompany()"
                (deleteLead)="deleteLead()"
                *ngIf="!isConverted"
              >
              </app-lead-actions>
            </div>
          </div>
        </div>

        <div class="header-actions">
          <app-lead-status
            [status]="lead.status"
            size="medium"
            [showIcon]="true"
          >
          </app-lead-status>
          
          <!-- Уведомление о конвертированном лиде -->
          <div class="converted-notice" *ngIf="isConverted">
            <mat-icon class="converted-icon">check_circle</mat-icon>
            <span class="converted-text">Лид конвертирован в сделку</span>
          </div>
        </div>
      </div>
    </div>

    <!-- Основная информация -->
    <div class="main-content">
      <div class="content-grid">
        <!-- Левая колонка -->
        <div class="left-column">
          <!-- Ключевые показатели -->
          <mat-card class="info-card highlight-card">
            <mat-card-header>
              <div mat-card-avatar class="card-avatar metrics">
                <mat-icon>analytics</mat-icon>
              </div>
              <mat-card-title>Ключевые показатели</mat-card-title>
              <mat-card-subtitle>Метрики эффективности лида</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="metrics-grid">
                <div class="metric-item primary">
                  <div class="metric-icon">
                    <mat-icon>star_rate</mat-icon>
                  </div>
                  <div class="metric-info">
                    <span class="label">Скор лида</span>
                    <div class="value primary-value">
                      {{ lead.score }} очков
                    </div>
                  </div>
                </div>

                <div class="metric-item">
                  <div class="metric-icon">
                    <mat-icon>trending_up</mat-icon>
                  </div>
                  <div class="metric-info">
                    <span class="label">Вероятность конверсии</span>
                    <div class="value">
                      <div class="probability-display">
                        <span class="probability-value"
                          >{{ lead.conversionProbability }}%</span
                        >
                        <div class="probability-bar">
                          <div
                            class="probability-fill"
                            [style.width.%]="lead.conversionProbability"
                          ></div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="metric-item" *ngIf="lead.estimatedValue">
                  <div class="metric-icon">
                    <mat-icon>attach_money</mat-icon>
                  </div>
                  <div class="metric-info">
                    <span class="label">Потенциальная ценность</span>
                    <div class="value estimated-value">
                      {{
                        lead.estimatedValue
                          | currency : 'RUB' : 'symbol' : '1.0-0'
                      }}
                    </div>
                  </div>
                </div>

                <div class="metric-item">
                  <div class="metric-icon">
                    <mat-icon>flag</mat-icon>
                  </div>
                  <div class="metric-info">
                    <span class="label">Приоритет</span>
                    <div class="value priority-value light-context">
                      <app-lead-priority
                        [priority]="lead.priority"
                        size="medium"
                        [showIcon]="true"
                      >
                      </app-lead-priority>
                    </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Контактная информация -->
          <mat-card
            class="info-card"
            *ngIf="lead.email || lead.phone || lead.company || lead.position"
          >
            <mat-card-header>
              <div mat-card-avatar class="card-avatar contact">
                <mat-icon>contacts</mat-icon>
              </div>
              <mat-card-title>Контактная информация</mat-card-title>
              <mat-card-subtitle>Данные для связи с лидом</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="contact-grid">
                <div class="contact-item" *ngIf="lead.email">
                  <div class="contact-icon email">
                    <mat-icon>email</mat-icon>
                  </div>
                  <div class="contact-details">
                    <span class="contact-label">Email</span>
                    <a
                      [href]="'mailto:' + lead.email"
                      class="contact-value email-link"
                    >
                      {{ lead.email }}
                    </a>
                  </div>
                </div>

                <div class="contact-item" *ngIf="lead.phone">
                  <div class="contact-icon phone">
                    <mat-icon>phone</mat-icon>
                  </div>
                  <div class="contact-details">
                    <span class="contact-label">Телефон</span>
                    <a
                      [href]="'tel:' + lead.phone"
                      class="contact-value phone-link"
                    >
                      {{ lead.phone }}
                    </a>
                  </div>
                </div>

                <div class="contact-item" *ngIf="lead.company">
                  <div class="contact-icon company">
                    <mat-icon>business</mat-icon>
                  </div>
                  <div class="contact-details">
                    <span class="contact-label">Компания</span>
                    <div class="contact-value">{{ lead.company.name }}</div>
                  </div>
                </div>

                <div class="contact-item" *ngIf="lead.position">
                  <div class="contact-icon position">
                    <mat-icon>work</mat-icon>
                  </div>
                  <div class="contact-details">
                    <span class="contact-label">Должность</span>
                    <div class="contact-value">{{ lead.position }}</div>
                  </div>
                </div>
              </div>
              
              <!-- Кнопка перехода к контакту -->
              <div class="contact-actions" *ngIf="lead.email || lead.phone">
                <button 
                  mat-raised-button 
                  color="primary" 
                  (click)="goToContact()"
                  class="contact-button"
                >
                  <mat-icon>person_add</mat-icon>
                  Перейти к контакту
                </button>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Заметки -->
          <mat-card class="info-card notes-card" *ngIf="lead.notes">
            <mat-card-header>
              <div mat-card-avatar class="card-avatar notes">
                <mat-icon>sticky_note_2</mat-icon>
              </div>
              <mat-card-title>Заметки</mat-card-title>
              <mat-card-subtitle>Дополнительная информация</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="notes-content">{{ lead.notes }}</div>
            </mat-card-content>
          </mat-card>
        </div>

        <!-- Правая колонка -->
        <div class="right-column">
          <!-- Процесс продажи -->
          <mat-card class="info-card process-card">
            <mat-card-header>
              <div mat-card-avatar class="card-avatar process">
                <mat-icon>timeline</mat-icon>
              </div>
              <mat-card-title>Процесс продажи</mat-card-title>
              <mat-card-subtitle
                >Информация о ходе работы с лидом</mat-card-subtitle
              >
            </mat-card-header>
            <mat-card-content>
              <div class="process-timeline">
                <div class="timeline-item">
                  <div class="timeline-icon source">
                    <mat-icon>source</mat-icon>
                  </div>
                  <div class="timeline-content">
                    <span class="label">Источник</span>
                    <div class="value highlight">
                      {{ getSourceLabel(lead.source) }}
                    </div>
                  </div>
                </div>

                <div class="timeline-item" *ngIf="currentAssignments.length > 0">
                  <div class="timeline-icon user">
                    <mat-icon>person_pin</mat-icon>
                  </div>
                  <div class="timeline-content">
                    <span class="label">Ответственный</span>
                    <div class="value">
                      {{ getAssigneeName }}
                    </div>
                  </div>
                </div>

                <div class="timeline-item" *ngIf="lead.promoCompanyId">
                  <div class="timeline-icon promo">
                    <mat-icon>campaign</mat-icon>
                  </div>
                  <div class="timeline-content">
                    <span class="label">Промо-компания</span>
                    <div class="value promo-company-value">
                      <div class="promo-company-badge">
                        <mat-icon class="promo-icon">campaign</mat-icon>
                        <span>{{ getPromoCompanyName(lead.promoCompanyId) }}</span>
                        <button mat-icon-button class="remove-promo-btn" (click)="removePromoCompany()" 
                                matTooltip="Отвязать от промо-компании" *ngIf="!isConverted">
                          <mat-icon>close</mat-icon>
                        </button>
                      </div>
                    </div>
                  </div>
                </div>

                <div class="timeline-item" *ngIf="!lead.promoCompanyId && !isConverted">
                  <div class="timeline-icon promo">
                    <mat-icon>campaign</mat-icon>
                  </div>
                  <div class="timeline-content">
                    <span class="label">Промо-компания</span>
                    <div class="value">
                      <button mat-stroked-button color="primary" (click)="assignPromoCompany()" class="assign-promo-btn">
                        <mat-icon>add</mat-icon>
                        Присвоить промо-компанию
                      </button>
                    </div>
                  </div>
                </div>

                <div class="timeline-item">
                  <div class="timeline-icon date">
                    <mat-icon>event</mat-icon>
                  </div>
                  <div class="timeline-content">
                    <span class="label">Дата создания</span>
                    <div class="value">
                      {{ lead.createdAt | date : 'dd.MM.yyyy HH:mm' }}
                    </div>
                  </div>
                </div>

                <div class="timeline-item">
                  <div class="timeline-icon date">
                    <mat-icon>update</mat-icon>
                  </div>
                  <div class="timeline-content">
                    <span class="label">Последнее обновление</span>
                    <div class="value">
                      {{ lead.updatedAt | date : 'dd.MM.yyyy HH:mm' }}
                    </div>
                  </div>
                </div>

                <div class="timeline-item" *ngIf="lead.lastContactedAt">
                  <div class="timeline-icon contact">
                    <mat-icon>contact_phone</mat-icon>
                  </div>
                  <div class="timeline-content">
                    <span class="label">Последний контакт</span>
                    <div class="value">
                      {{ lead.lastContactedAt | date : 'dd.MM.yyyy HH:mm' }}
                    </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Дополнительные данные -->
          <mat-card
            class="info-card metadata-card"
            *ngIf="lead.industry || lead.website || lead.country || lead.city"
          >
            <mat-card-header>
              <div mat-card-avatar class="card-avatar metadata">
                <mat-icon>info</mat-icon>
              </div>
              <mat-card-title>Дополнительные данные</mat-card-title>
              <mat-card-subtitle
                >Дополнительная информация о лиде</mat-card-subtitle
              >
            </mat-card-header>
            <mat-card-content>
              <div class="metadata-list">
                <div class="metadata-item" *ngIf="lead.industry">
                  <div class="metadata-key">
                    <mat-icon>category</mat-icon>
                    <span>Отрасль</span>
                  </div>
                  <div class="metadata-value">{{ lead.industry }}</div>
                </div>

                <div class="metadata-item" *ngIf="lead.website">
                  <div class="metadata-key">
                    <mat-icon>language</mat-icon>
                    <span>Веб-сайт</span>
                  </div>
                  <div class="metadata-value">
                    <a [href]="lead.website" target="_blank">{{
                      lead.website
                    }}</a>
                  </div>
                </div>

                <div class="metadata-item" *ngIf="lead.country">
                  <div class="metadata-key">
                    <mat-icon>public</mat-icon>
                    <span>Страна</span>
                  </div>
                  <div class="metadata-value">{{ lead.country }}</div>
                </div>

                <div class="metadata-item" *ngIf="lead.city">
                  <div class="metadata-key">
                    <mat-icon>location_city</mat-icon>
                    <span>Город</span>
                  </div>
                  <div class="metadata-value">{{ lead.city }}</div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>

          <!-- Виджет задач -->
          <app-task-list-widget [leadId]="lead.id"></app-task-list-widget>
        </div>
      </div>

      <!-- История и активность лида -->
      <div class="history-section">
        <!-- Уведомление для конвертированного лида -->
        <div class="readonly-notice" *ngIf="isConverted">
          <mat-icon>info</mat-icon>
          <span>Этот лид конвертирован в сделку. Доступен только просмотр и добавление комментариев.</span>
        </div>

        <mat-tab-group mat-stretch-tabs="true" class="history-tabs">
          <!-- Комментарии -->
          <mat-tab label="Комментарии" *ngIf="lead.id">
            <div class="tab-content">
              <app-comments
                [entityType]="CommentEntityType.LEAD"
                [entityId]="lead.id.toString()"
              >
              </app-comments>
            </div>
          </mat-tab>

          <!-- Активность -->
          <mat-tab label="Активность">
            <div class="tab-content">
              <div
                class="activities-list"
                *ngIf="activities.length > 0; else noActivities"
              >
                <div *ngFor="let activity of activities" class="activity-item">
                  <div class="activity-icon">
                    <mat-icon>{{ getActivityIcon(activity.type) }}</mat-icon>
                  </div>
                  <div class="activity-content">
                    <div class="activity-header">
                      <span class="activity-type">{{
                        getActivityLabel(activity.type)
                      }}</span>
                      <span class="activity-date">{{
                        activity.createdAt | date : 'dd.MM.yyyy HH:mm'
                      }}</span>
                    </div>
                    <div class="activity-description">
                      {{ activity.description }}
                    </div>
                  </div>
                </div>
              </div>

              <ng-template #noActivities>
                <div class="empty-state">
                  <mat-icon>history</mat-icon>
                  <h3>Нет активности</h3>
                  <p>Активность по этому лиду пока не зафиксирована</p>
                </div>
              </ng-template>
            </div>
          </mat-tab>

          <!-- История изменений -->
          <mat-tab label="История изменений">
            <div class="tab-content">
              <div
                class="history-list"
                *ngIf="history.length > 0; else noHistory"
              >
                <div *ngFor="let historyItem of history" class="history-item">
                  <div class="history-icon">
                    <mat-icon>edit</mat-icon>
                  </div>
                  <div class="history-content">
                    <div class="history-header">
                      <span class="history-field">{{
                        historyItem.fieldName
                      }}</span>
                      <span class="history-date">{{
                        historyItem.timestamp | date : 'dd.MM.yyyy HH:mm'
                      }}</span>
                    </div>
                    <div class="history-changes">
                      <span class="old-value" *ngIf="historyItem.oldValue">{{
                        historyItem.oldValue
                      }}</span>
                      <mat-icon class="arrow" *ngIf="historyItem.oldValue"
                        >arrow_forward</mat-icon
                      >
                      <span class="new-value">{{ historyItem.newValue }}</span>
                    </div>
                    <div class="history-user" *ngIf="historyItem.userName">
                      Изменил: {{ historyItem.userName }}
                    </div>
                  </div>
                </div>
              </div>

              <ng-template #noHistory>
                <div class="empty-state">
                  <mat-icon>history</mat-icon>
                  <h3>Нет истории</h3>
                  <p>История изменений для этого лида пока пуста</p>
                </div>
              </ng-template>
            </div>
          </mat-tab>
        </mat-tab-group>
      </div>
    </div>
  </div>
</div>
