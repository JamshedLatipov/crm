<div class="dialog-header">
  <h2 mat-dialog-title>
    <mat-icon>swap_horiz</mat-icon>
    Изменить статус лида
  </h2>
  <button mat-icon-button (click)="close()" class="close-button">
    <mat-icon>close</mat-icon>
  </button>
</div>

<mat-dialog-content class="dialog-content">
  <!-- Lead Info Header -->
  <div class="lead-info-header">
    <div class="lead-avatar">
      <mat-icon>person</mat-icon>
    </div>
    <div class="lead-details">
      <h3 class="lead-name">{{ data.lead.name }}</h3>
      <div class="lead-meta">
        @if (data.lead.company) {
          <span class="meta-item">
            <mat-icon>business</mat-icon>
              {{ data.lead.company?.name || data.lead.company?.legalName || '-' }}
          </span>
        }
        @if (data.lead.email) {
          <span class="meta-item">
            <mat-icon>email</mat-icon>
            {{ data.lead.email }}
          </span>
        }
      </div>
      <div class="current-status-display">
        <span class="status-label">Текущий статус:</span>
        <app-lead-status 
          [status]="data.currentStatus" 
          [size]="'medium'"
          [showIcon]="true">
        </app-lead-status>
      </div>
    </div>
  </div>

  <!-- Final Status Warning -->
  @if (isFinalStatus) {
    <div class="final-status-warning">
      <div class="warning-content">
        <mat-icon class="warning-icon">lock</mat-icon>
        <div class="warning-text">
          <h3>Статус заблокирован</h3>
          <p>{{ finalStatusMessage }}</p>
        </div>
      </div>
    </div>
  }

  <!-- Status Selection (only if not final status) -->
  @if (!isFinalStatus) {
    <div class="status-section">
      <div class="section-header">
        <mat-icon class="section-icon">low_priority</mat-icon>
        <h3>Выберите новый статус</h3>
      </div>

      <!-- Status Progress Overview -->
      @if (selectedStatus) {
        <div class="status-progress-overview">
          <div class="progress-header">
            <span class="progress-label">Прогресс лида:</span>
            <span class="progress-percentage">{{ getStatusProgress(selectedStatus) }}%</span>
          </div>
          <div class="progress-bar">
            <div 
              class="progress-fill" 
              [style.width.%]="getStatusProgress(selectedStatus)"
              [style.background]="getStatusColor(selectedStatus)">
            </div>
          </div>
        </div>
      }
      
      <div class="status-grid">
        @for (status of displayStatuses; track status.value) {
          <div
            class="status-option"
            [class.selected]="selectedStatus === status.value"
            [class.disabled]="status.value === data.currentStatus"
            [class.current]="status.value === data.currentStatus"
            [class.invalid-transition]="!isValidTransition(data.currentStatus, status.value) && status.value !== data.currentStatus"
            (click)="status.value !== data.currentStatus && selectStatus(status.value)"
            role="button"
            tabindex="0"
            (keydown.enter)="status.value !== data.currentStatus && selectStatus(status.value)"
            [attr.aria-pressed]="selectedStatus === status.value"
          >
            <div class="status-option-content">
              <div class="status-icon-wrapper" [style.border-color]="getStatusColor(status.value)">
                <mat-icon class="status-icon" [style.color]="getStatusColor(status.value)">{{ status.icon }}</mat-icon>
              </div>
              <div class="status-text">
                <div class="status-name">{{ status.label }}</div>
                <div class="status-description">{{ status.description }}</div>
                <div class="status-progress-mini">
                  <div class="mini-progress-bar">
                    <div 
                      class="mini-progress-fill" 
                      [style.width.%]="getStatusProgress(status.value)"
                      [style.background]="getStatusColor(status.value)">
                    </div>
                  </div>
                  <span class="mini-progress-text">{{ getStatusProgress(status.value) }}%</span>
                </div>
              </div>
              @if (selectedStatus === status.value) {
                <div class="status-indicator">
                  <mat-icon>check_circle</mat-icon>
                </div>
              }
            </div>
          </div>
        }
      </div>
    </div>

    <!-- Comments Section (only if not final status) -->
    <div class="comments-section">
      <mat-form-field class="full-width" appearance="outline">
        <mat-label>Добавить комментарий (необязательно)</mat-label>
        <textarea 
          matInput 
          [(ngModel)]="notes" 
          rows="3"
          placeholder="Опишите причину изменения статуса или добавьте заметки..."></textarea>
        <mat-icon matSuffix>edit_note</mat-icon>
      </mat-form-field>
    </div>

    <!-- Next Steps (only if not final status) -->
    @if (selectedStatus) {
      <div class="next-steps-section">
        <div class="section-header">
          <mat-icon class="section-icon">trending_flat</mat-icon>
          <h3>Следующие шаги</h3>
        </div>
        
        <div class="next-steps-grid">
          @for (step of getNextSteps(selectedStatus); track step.description) {
            <div class="step-card">
              <div class="step-icon-wrapper">
                <mat-icon class="step-icon">{{ step.icon }}</mat-icon>
              </div>
              <span class="step-description">{{ step.description }}</span>
            </div>
          }
        </div>
      </div>
    }
  }
</mat-dialog-content>

<mat-dialog-actions class="dialog-actions">
  <button mat-button (click)="close()" class="action-button cancel-button">
    <mat-icon>close</mat-icon>
    {{ isFinalStatus ? 'Закрыть' : 'Отмена' }}
  </button>
  @if (!isFinalStatus) {
    <button
      mat-raised-button
      color="primary"
      (click)="changeStatus()"
      [disabled]="!selectedStatus || selectedStatus === data.currentStatus || loading"
      class="action-button primary-button"
    >
      @if (loading) {
        <ng-container>
          <mat-icon class="loading-icon">hourglass_empty</mat-icon>
          <span>Сохранение...</span>
        </ng-container>
      } @else {
        <ng-container>
          <mat-icon>check</mat-icon>
          <span>Изменить статус</span>
        </ng-container>
      }
    </button>
  }
</mat-dialog-actions>
