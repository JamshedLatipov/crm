<div class="leads-container">
  <!-- Header -->
  <div class="header">
    <div class="title-section">
      <h1>Leads</h1>
    </div>
    <div class="actions">
      <button mat-raised-button color="primary" (click)="openCreateDialog()">
        <mat-icon>add</mat-icon>
        New Lead
      </button>
    </div>
  </div>

  <!-- Tabs -->
  <div class="tabs-section">
    <div class="tabs">
      <button
        class="tab"
        [class.active]="activeTab === 'all'"
        (click)="setActiveTab('all')"
      >
        All Leads
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'open'"
        (click)="setActiveTab('open')"
      >
        Open
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'qualified'"
        (click)="setActiveTab('qualified')"
      >
        Qualified
      </button>
      <button
        class="tab"
        [class.active]="activeTab === 'closed'"
        (click)="setActiveTab('closed')"
      >
        Closed
      </button>
    </div>
    <div class="search-section">
      <mat-form-field appearance="outline" class="search-field">
        <input
          matInput
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearch()"
          placeholder="Search leads"
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    <div *ngIf="loading()" class="loading-spinner">
      <mat-spinner diameter="40"></mat-spinner>
      <p>Loading leads...</p>
    </div>

    <table
      mat-table
      [dataSource]="leads()"
      *ngIf="!loading()"
      class="leads-table"
    >
      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox (click)="$event.stopPropagation()"></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let lead">
          <mat-checkbox (click)="$event.stopPropagation()"></mat-checkbox>
        </td>
      </ng-container>

      <!-- Lead Name Column -->
      <ng-container matColumnDef="leadName">
        <th mat-header-cell *matHeaderCellDef>
          Lead Name
        </th>
        <td mat-cell *matCellDef="let lead" class="lead-name-cell">
          {{ lead.name }}
        </td>
      </ng-container>

      <!-- Company Column -->
      <ng-container matColumnDef="company">
        <th mat-header-cell *matHeaderCellDef>Company</th>
        <td mat-cell *matCellDef="let lead" class="company-cell">
          {{ lead.company?.name || '-' }}
        </td>
      </ng-container>

      <!-- Lead Score Column -->
      <ng-container matColumnDef="leadScore">
        <th mat-header-cell *matHeaderCellDef>Lead Score</th>
        <td mat-cell *matCellDef="let lead" class="score-cell">
          <div class="score-badge" [ngClass]="getScoreBadgeClass(lead.score)">
            {{ lead.score }}
          </div>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Status</th>
        <td mat-cell *matCellDef="let lead" class="status-cell">
          <div class="status-container">
            <span class="status-badge" [ngClass]="'status-' + lead.status">
              {{ getStatusLabel(lead.status) }}
            </span>
            <button
              *ngIf="canChangeStatus(lead)"
              mat-icon-button
              class="status-change-btn"
              (click)="changeStatus(lead); $event.stopPropagation()"
              matTooltip="Изменить статус"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <mat-icon
              *ngIf="!canChangeStatus(lead)"
              class="status-locked-icon"
              matTooltip="Статус заблокирован"
            >
              lock
            </mat-icon>
          </div>
        </td>
      </ng-container>

      <!-- Assigned Manager Column -->
      <ng-container matColumnDef="assignedManager">
        <th mat-header-cell *matHeaderCellDef>Assigned Manager</th>
        <td mat-cell *matCellDef="let lead" class="manager-cell">
          <div class="manager-container">
            <span class="manager-name" *ngIf="lead.assignedTo; else unassigned">
              {{ getManagerName(lead.assignedTo) }}
            </span>
            <ng-template #unassigned>
              <span class="unassigned-text">Unassigned</span>
            </ng-template>
            <button
              mat-icon-button
              class="assign-btn"
              (click)="quickAssign(lead); $event.stopPropagation()"
              [matTooltip]="
                lead.assignedTo ? 'Переназначить' : 'Назначить ответственного'
              "
            >
              <mat-icon>{{
                lead.assignedTo ? 'person_add' : 'person_add_alt_1'
              }}</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Last Activity Column -->
      <ng-container matColumnDef="lastActivity">
        <th mat-header-cell *matHeaderCellDef>Last Activity</th>
        <td mat-cell *matCellDef="let lead" class="activity-cell">
          {{ getLastActivity(lead) }}
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let lead" class="actions-cell">
          <button
            mat-icon-button
            [matMenuTriggerFor]="actionsMenu"
            (click)="$event.stopPropagation()"
          >
            <mat-icon>more_horiz</mat-icon>
          </button>

          <mat-menu #actionsMenu="matMenu">
            <button
              mat-menu-item
              (click)="viewLead(lead); $event.stopPropagation()"
            >
              <mat-icon>visibility</mat-icon>
              <span>View</span>
            </button>
            <button
              mat-menu-item
              (click)="editLead(lead); $event.stopPropagation()"
            >
              <mat-icon>edit</mat-icon>
              <span>Edit</span>
            </button>
            <button
              mat-menu-item
              (click)="changeStatus(lead); $event.stopPropagation()"
            >
              <mat-icon>swap_horiz</mat-icon>
              <span>Change Status</span>
            </button>
            <mat-menu #quickStatusMenu="matMenu">
              <button
                mat-menu-item
                (click)="
                  $event.stopPropagation();
                  lead.status !== LeadStatus.CONTACTED &&
                    quickUpdateStatus(lead, 'contacted')
                "
                [disabled]="lead.status === LeadStatus.CONTACTED"
                [attr.aria-disabled]="lead.status === LeadStatus.CONTACTED"
              >
                <mat-icon>contact_phone</mat-icon>
                <span>Mark as Contacted</span>
              </button>
              <button
                mat-menu-item
                (click)="
                  $event.stopPropagation();
                  lead.status !== LeadStatus.QUALIFIED &&
                    quickUpdateStatus(lead, 'qualified')
                "
                [disabled]="lead.status === LeadStatus.QUALIFIED"
                [attr.aria-disabled]="lead.status === LeadStatus.QUALIFIED"
              >
                <mat-icon>verified</mat-icon>
                <span>Mark as Qualified</span>
              </button>
              <button
                mat-menu-item
                (click)="
                  $event.stopPropagation();
                  lead.status !== LeadStatus.CONVERTED &&
                    quickUpdateStatus(lead, 'converted')
                "
                [disabled]="lead.status === LeadStatus.CONVERTED"
                [attr.aria-disabled]="lead.status === LeadStatus.CONVERTED"
              >
                <mat-icon>check_circle</mat-icon>
                <span>Mark as Converted</span>
              </button>
              <button
                mat-menu-item
                (click)="
                  $event.stopPropagation();
                  lead.status !== LeadStatus.LOST &&
                    quickUpdateStatus(lead, 'lost')
                "
                [disabled]="lead.status === LeadStatus.LOST"
                [attr.aria-disabled]="lead.status === LeadStatus.LOST"
                class="danger-action"
              >
                <mat-icon>cancel</mat-icon>
                <span>Mark as Lost</span>
              </button>
            </mat-menu>
            <button
              mat-menu-item
              [matMenuTriggerFor]="quickStatusMenu"
              (click)="$event.stopPropagation()"
            >
              <mat-icon>speed</mat-icon>
              <span>Quick Status</span>
              <mat-icon class="submenu-arrow">chevron_right</mat-icon>
            </button>
            <button
              mat-menu-item
              (click)="assignLead(lead); $event.stopPropagation()"
            >
              <mat-icon>person_add</mat-icon>
              <span>Assign</span>
            </button>
            <button
              mat-menu-item
              (click)="contactLead(lead); $event.stopPropagation()"
            >
              <mat-icon>phone</mat-icon>
              <span>Contact</span>
            </button>
            <button
              mat-menu-item
              (click)="convertToDeal(lead); $event.stopPropagation()"
              [disabled]="lead.status === LeadStatus.CONVERTED"
            >
              <mat-icon>trending_up</mat-icon>
              <span>Convert to Deal</span>
            </button>
            <mat-divider></mat-divider>
            <button
              mat-menu-item
              (click)="deleteLead(lead); $event.stopPropagation()"
              class="delete-action"
            >
              <mat-icon>delete</mat-icon>
              <span>Delete</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
      <tr
        mat-row
        *matRowDef="let row; columns: displayedColumns"
        class="table-row"
        (click)="viewLead(row)"
      ></tr>
    </table>

    <!-- No results message -->
    <div *ngIf="!loading() && leads().length === 0" class="no-results">
      <mat-icon class="no-results-icon">search_off</mat-icon>
      <h3>No leads found</h3>
      <p>Try adjusting your search or create a new lead</p>
      <button mat-raised-button color="primary" (click)="openCreateDialog()">
        <mat-icon>add</mat-icon>
        Create Lead
      </button>
    </div>
  </div>
</div>
