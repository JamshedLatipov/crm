<app-page-layout title="Лиды">
  <div page-actions>
    <button mat-raised-button color="primary" (click)="openCreateDialog()">
      <mat-icon>add</mat-icon>
      Новый лид
    </button>
    <button mat-stroked-button color="primary" (click)="bulkQuickAssign()" [disabled]="selectedLeads().length === 0" class="ml-2">
      <mat-icon>flash_on</mat-icon>
      Быстрое назначение ({{ selectedLeads().length }})
    </button>
  </div>

  <!-- Tabs -->
  <div class="tabs-section">
    <div class="tabs">
      <app-status-tabs
        [tabs]="leadTabs"
        [selected]="activeTab"
        (selectedChange)="setActiveTab($event)">
      </app-status-tabs>
    </div>
    <div class="search-section">
      <mat-form-field appearance="outline" class="search-field">
        <input
          matInput
          [(ngModel)]="searchQuery"
          (ngModelChange)="onSearch()"
          placeholder="Поиск лидов"
        />
        <mat-icon matSuffix>search</mat-icon>
      </mat-form-field>
    </div>
  </div>

  <!-- Table -->
  <div class="table-container">
    @if (loading()) {
      <div class="loading-spinner">
        <mat-spinner diameter="40"></mat-spinner>
        <p>Загрузка лидов...</p>
      </div>
    }

    @if (!loading()) {
      <table
        mat-table
        [dataSource]="leads()"
        class="leads-table"
      >
      <!-- Checkbox Column -->
      <ng-container matColumnDef="select">
        <th mat-header-cell *matHeaderCellDef>
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="toggleAllSelection()"
            [checked]="isAllSelected()"
            [indeterminate]="isPartiallySelected()"
            aria-label="Select all leads"
          ></mat-checkbox>
        </th>
        <td mat-cell *matCellDef="let lead">
          <mat-checkbox
            (click)="$event.stopPropagation()"
            (change)="toggleLeadSelection(lead)"
            [checked]="isLeadSelected(lead)"
            aria-label="Select lead"
          ></mat-checkbox>
        </td>
      </ng-container>

      <!-- Lead Name Column -->
      <ng-container matColumnDef="leadName">
        <th mat-header-cell *matHeaderCellDef>
          Имя лида
        </th>
        <td mat-cell *matCellDef="let lead" class="lead-name-cell">
          {{ lead.name }}
        </td>
      </ng-container>

      <!-- Company Column -->
      <ng-container matColumnDef="company">
        <th mat-header-cell *matHeaderCellDef>Компания</th>
        <td mat-cell *matCellDef="let lead" class="company-cell">
          {{ lead.company?.name || '-' }}
        </td>
      </ng-container>

      <!-- Promo Company Column -->
      <ng-container matColumnDef="promoCompany">
        <th mat-header-cell *matHeaderCellDef>Промо-компания</th>
        <td mat-cell *matCellDef="let lead" class="promo-company-cell">
          @if (lead.promoCompanyId) {
            <div class="promo-company-badge">
              <mat-icon class="promo-icon">campaign</mat-icon>
              <span>{{ getPromoCompanyName(lead.promoCompanyId) }}</span>
            </div>
          } @else {
            <span class="no-promo-company">-</span>
          }
        </td>
      </ng-container>

      <!-- Lead Score Column -->
      <ng-container matColumnDef="leadScore">
        <th mat-header-cell *matHeaderCellDef>Скор лида</th>
        <td mat-cell *matCellDef="let lead" class="score-cell">
          <div class="score-badge" [ngClass]="getScoreBadgeClass(lead.score)">
            {{ lead.score }}
          </div>
        </td>
      </ng-container>

      <!-- Status Column -->
      <ng-container matColumnDef="status">
        <th mat-header-cell *matHeaderCellDef>Статус</th>
        <td mat-cell *matCellDef="let lead" class="status-cell">
          <div class="status-container">
            <span class="status-badge" [ngClass]="'status-' + lead.status">
              {{ getStatusLabel(lead.status) }}
            </span>
            <button
              *ngIf="canChangeStatus(lead)"
              mat-icon-button
              class="status-change-btn"
              (click)="changeStatus(lead); $event.stopPropagation()"
              matTooltip="Изменить статус"
            >
              <mat-icon>edit</mat-icon>
            </button>
            <mat-icon
              *ngIf="!canChangeStatus(lead)"
              class="status-locked-icon"
              matTooltip="Статус заблокирован"
            >
              lock
            </mat-icon>
          </div>
        </td>
      </ng-container>

      <!-- Assigned Manager Column -->
      <ng-container matColumnDef="assignedManager">
        <th mat-header-cell *matHeaderCellDef>Ответственный менеджер</th>
        <td mat-cell *matCellDef="let lead" class="manager-cell">
          <div class="manager-container">
            @if (getAssignedManagerName(lead)) {
              <span class="manager-name">{{ getAssignedManagerName(lead) }}</span>
            } @else {
              <span class="unassigned-text">Не назначен</span>
            }
            <button
              mat-icon-button
              class="assign-btn"
              (click)="quickAssign(lead); $event.stopPropagation()"
              [matTooltip]="
                lead.assignedTo ? 'Переназначить' : 'Назначить ответственного'
              "
            >
              <mat-icon>{{
                lead.assignedTo ? 'person_add' : 'person_add_alt_1'
              }}</mat-icon>
            </button>
          </div>
        </td>
      </ng-container>

      <!-- Last Activity Column -->
      <ng-container matColumnDef="lastActivity">
        <th mat-header-cell *matHeaderCellDef>Последняя активность</th>
        <td mat-cell *matCellDef="let lead" class="activity-cell">
          {{ getLastActivity(lead) }}
        </td>
      </ng-container>

      <!-- Actions Column -->
      <ng-container matColumnDef="actions">
        <th mat-header-cell *matHeaderCellDef></th>
        <td mat-cell *matCellDef="let lead" class="actions-cell">
          <button
            mat-icon-button
            [matMenuTriggerFor]="actionsMenu"
            (click)="$event.stopPropagation()"
          >
            <mat-icon>more_horiz</mat-icon>
          </button>

          <mat-menu #actionsMenu="matMenu">
            <button
              mat-menu-item
              (click)="viewLead(lead); $event.stopPropagation()"
            >
              <mat-icon>visibility</mat-icon>
              <span>Просмотр</span>
            </button>
            <button
              mat-menu-item
              (click)="editLead(lead); $event.stopPropagation()"
            >
              <mat-icon>edit</mat-icon>
              <span>Редактировать</span>
            </button>
            <button
              mat-menu-item
              (click)="changeStatus(lead); $event.stopPropagation()"
            >
              <mat-icon>swap_horiz</mat-icon>
              <span>Изменить статус</span>
            </button>
            <mat-menu #quickStatusMenu="matMenu">
              <button
                mat-menu-item
                (click)="
                  $event.stopPropagation();
                  lead.status !== LeadStatus.CONTACTED &&
                    quickUpdateStatus(lead, 'contacted')
                "
                [disabled]="lead.status === LeadStatus.CONTACTED"
                [attr.aria-disabled]="lead.status === LeadStatus.CONTACTED"
              >
                <mat-icon>contact_phone</mat-icon>
                <span>Отметить как контактирован</span>
              </button>
              <button
                mat-menu-item
                (click)="
                  $event.stopPropagation();
                  lead.status !== LeadStatus.QUALIFIED &&
                    quickUpdateStatus(lead, 'qualified')
                "
                [disabled]="lead.status === LeadStatus.QUALIFIED"
                [attr.aria-disabled]="lead.status === LeadStatus.QUALIFIED"
              >
                <mat-icon>verified</mat-icon>
                <span>Отметить как квалифицирован</span>
              </button>
              <button
                mat-menu-item
                (click)="
                  $event.stopPropagation();
                  lead.status !== LeadStatus.CONVERTED &&
                    quickUpdateStatus(lead, 'converted')
                "
                [disabled]="lead.status === LeadStatus.CONVERTED"
                [attr.aria-disabled]="lead.status === LeadStatus.CONVERTED"
              >
                <mat-icon>check_circle</mat-icon>
                <span>Отметить как конвертирован</span>
              </button>
              <button
                mat-menu-item
                (click)="
                  $event.stopPropagation();
                  lead.status !== LeadStatus.LOST &&
                    quickUpdateStatus(lead, 'lost')
                "
                [disabled]="lead.status === LeadStatus.LOST"
                [attr.aria-disabled]="lead.status === LeadStatus.LOST"
                class="danger-action"
              >
                <mat-icon>cancel</mat-icon>
                <span>Отметить как потерян</span>
              </button>
            </mat-menu>
            <button
              mat-menu-item
              [matMenuTriggerFor]="quickStatusMenu"
              (click)="$event.stopPropagation()"
            >
              <mat-icon>speed</mat-icon>
              <span>Быстрый статус</span>
              <mat-icon class="submenu-arrow">chevron_right</mat-icon>
            </button>
            <button
              mat-menu-item
              (click)="assignLead(lead); $event.stopPropagation()"
            >
              <mat-icon>person_add</mat-icon>
              <span>Назначить</span>
            </button>
            <button
              mat-menu-item
              (click)="contactLead(lead); $event.stopPropagation()"
            >
              <mat-icon>phone</mat-icon>
              <span>Связаться</span>
            </button>
            <button
              mat-menu-item
              (click)="convertToDeal(lead); $event.stopPropagation()"
              [disabled]="lead.status === LeadStatus.CONVERTED"
            >
              <mat-icon>trending_up</mat-icon>
              <span>Конвертировать в сделку</span>
            </button>
            <mat-divider></mat-divider>
            <button
              mat-menu-item
              (click)="deleteLead(lead); $event.stopPropagation()"
              class="delete-action"
            >
              <mat-icon>delete</mat-icon>
              <span>Удалить</span>
            </button>
          </mat-menu>
        </td>
      </ng-container>

      <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
        <tr
          mat-row
          *matRowDef="let row; columns: displayedColumns"
          class="table-row"
          (click)="viewLead(row)"
        ></tr>
      </table>
      <!-- Paginator -->
      <div class="table-footer">
        <mat-paginator
          [length]="totalResults"
          [pageSize]="pageSize"
          [pageIndex]="currentPage - 1"
          [pageSizeOptions]="[10, 20, 50]"
          (page)="onPageChange($event)"
        >
        </mat-paginator>
      </div>
    }

    <!-- No results message -->
    @if (!loading() && leads().length === 0) {
      <div class="no-results">
        <mat-icon class="no-results-icon">search_off</mat-icon>
        <h3>Лиды не найдены</h3>
        <p>Попробуйте изменить поиск или создать новый лид</p>
        <button mat-raised-button color="primary" (click)="openCreateDialog()">
          <mat-icon>add</mat-icon>
          Создать лид
        </button>
      </div>
    }
  </div>
</app-page-layout>
