# Рефакторинг SoftphoneControllerFacade

## Проблема
Файл `softphone-controller.facade.ts` был слишком большим (~700 строк) и содержал множество различных ответственностей, что затрудняло поддержку и тестирование.

## Решение
Применен паттерн разделения ответственностей (Separation of Concerns) и Single Responsibility Principle - создано 5 специализированных сервисов:

### 1. **CallStatusService** (`services/call-status.service.ts`)
**Ответственность:** Управление состоянием звонка
- Статус звонка (status)
- Флаги: callActive, incoming, muted, onHold, holdInProgress
- Таймер длительности звонка
- Управление набираемым номером (callee) и DTMF
- Управление transferTarget

**Методы:**
- `startCallTimer()`, `stopCallTimer()` - управление таймером
- `resetCallState()` - сброс состояния после завершения звонка
- `setIncoming()`, `activateCall()` - установка статуса звонка
- `appendDtmf()`, `clearDtmf()` - работа с DTMF
- `appendToCallee()`, `clearCallee()`, `removeLastFromCallee()` - работа с номером

### 2. **CallScriptsManagerService** (`services/call-scripts-manager.service.ts`)
**Ответственность:** Управление скриптами звонков
- Загрузка скриптов с сервера
- Управление видимостью панели скриптов
- Хранение выбранной ветки скрипта и заметок

**Методы:**
- `loadScripts()` - загрузка активных скриптов
- `toggleScriptsPanel()`, `openScriptsPanel()` - управление панелью
- `findScriptTitle()` - поиск названия скрипта по ID
- `resetState()` - сброс состояния скриптов

### 3. **QueueStateService** (`services/queue-state.service.ts`)
**Ответственность:** Управление состоянием оператора в очереди
- Состояние паузы (memberPaused)
- Причина паузы (memberReason)

**Методы:**
- `loadMemberState()` - загрузка текущего состояния
- `updateMemberPause()` - обновление состояния паузы с откатом в случае ошибки

### 4. **RingtoneManagerService** (`services/ringtone-manager.service.ts`)
**Ответственность:** Централизованное управление звуковыми уведомлениями
- Входящие рингтоны
- Исходящие рингтоны
- Сигнал "занято"

**Методы:**
- `startIncomingRingtone()` - запуск рингтона для входящего
- `startOutgoingRingtone()` - запуск рингтона для исходящего
- `stopRingtone()` - остановка воспроизведения
- `playBusyTone()` - воспроизведение сигнала "занято"

### 5. **SoftphoneEventHandlerService** (`services/softphone-event-handler.service.ts`)
**Ответственность:** Обработка событий от JsSIP
- Подписка на события софтфона
- Обработка всех типов событий (регистрация, звонки, hold/unhold)
- Управление текущей сессией
- Отправка браузерных уведомлений

**Методы:**
- `setupEventSubscription()` - подписка на события
- `getCurrentSession()` - получение текущей сессии
- `destroy()` - очистка подписок
- Множество приватных методов обработки конкретных событий

## Результаты

### До рефакторинга
- **1 файл:** `softphone-controller.facade.ts` (~700 строк)
- Множество смешанных ответственностей
- Сложно тестировать
- Сложно поддерживать

### После рефакторинга
- **6 файлов:**
  - `softphone-controller.facade.ts` (314 строк, -55%)
  - 5 специализированных сервисов (~50-200 строк каждый)
- Четкое разделение ответственностей
- Легко тестировать каждый сервис отдельно
- Легко поддерживать и расширять
- Улучшенная читаемость кода

### Facade теперь выполняет только роль координатора
```typescript
// Прокси к сигналам из специализированных сервисов
readonly status = this.callStatus.status;
readonly scripts = this.scriptsManager.scripts;
readonly memberPaused = this.queueState.memberPaused;

// Методы делегируют работу специализированным сервисам
toggleScriptsPanel() {
  this.scriptsManager.toggleScriptsPanel();
}
```

## Преимущества
✅ **Лучшая структура:** Каждый сервис отвечает за одну область
✅ **Тестируемость:** Каждый сервис можно тестировать независимо
✅ **Переиспользование:** Сервисы можно использовать в других компонентах
✅ **Читаемость:** Легче понять, что делает каждый файл
✅ **Поддержка:** Изменения локализованы в соответствующих сервисах
✅ **Масштабируемость:** Легко добавлять новую функциональность

## Обратная совместимость
Публичный API `SoftphoneControllerFacade` остался без изменений - все существующие компоненты продолжат работать без модификаций.
