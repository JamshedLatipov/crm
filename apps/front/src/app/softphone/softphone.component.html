<!-- Softphone container: expandable -->
<!-- Hide softphone entirely when user has no operator credentials -->
<div *ngIf="hasOperator()" class="fixed bottom-4 right-4 z-50">
    <!-- Minimized floating button -->
    <button
      *ngIf="!expanded"
      (click)="toggleExpand()"
      title="Open softphone"
      class="floating-button"
    >
      <span class="material-icons">call</span>
      <!-- Active call indicator -->
      <span *ngIf="callActive()" class="active-call-indicator"></span>
      <!-- Missed call badge -->
      <span *ngIf="missedCallCount()" class="missed-call-badge">{{
        missedCallCount() > 99 ? '99+' : missedCallCount()
      }}</span>
    </button>

  <!-- Expanded panel -->
  <div *ngIf="expanded" class="expanded-panel">
    <div class="panel-header">
      <div class="header-content">
        <div class="status-bar">
          <app-softphone-status-bar
            [status]="status()"
            [callActive]="callActive()"
            [paused]="memberPaused()"
            [reason]="memberReason()"
            (pauseChange)="onMemberPauseChange($event)"
          ></app-softphone-status-bar>
        </div>
        <button
          (click)="toggleExpand()"
          title="Minimize"
          class="minimize-button"
        >
          <span class="material-icons">remove</span>
        </button>
      </div>
    </div>

    <div class="panel-content">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <div class="tab-buttons">
          <button
            (click)="selectTab('dial')"
            [class.active]="activeTab() === 'dial'"
            class="tab-button"
          >
            <span class="material-icons">call</span>
            <span>Звонок</span>
          </button>
          <button
            (click)="selectTab('history')"
            [class.active]="activeTab() === 'history'"
            class="tab-button"
          >
            <span class="material-icons">history</span>
            <span>История</span>
          </button>
          <button
            (click)="selectTab('scenarios')"
            [class.active]="activeTab() === 'scenarios'"
            class="tab-button"
          >
            <span class="material-icons">menu_book</span>
            <span>Сценарии</span>
          </button>
          <button
            (click)="selectTab('info')"
            [class.active]="activeTab() === 'info'"
            class="tab-button"
          >
            <span class="material-icons">info</span>
            <span>Инфо</span>
          </button>
        </div>
      </div>

      <!-- Incoming call alert -->
      <div *ngIf="incoming()" class="incoming-call-alert">
        <div class="incoming-call-header">
          <div class="incoming-call-info">
            <span class="material-icons call-type-icon">call</span>
            <div>
              <div class="caller-name">Входящий звонок</div>
              <div class="caller-number">
                {{ incomingFrom() || 'Неизвестный абонент' }}
              </div>
            </div>
          </div>
        </div>
        <div class="incoming-call-actions">
          <button (click)="answerIncoming()" class="answer-button">
            <span class="material-icons">call</span>
            Принять
          </button>
          <button (click)="rejectIncoming()" class="reject-button">
            <span class="material-icons">call_end</span>
            Отклонить
          </button>
        </div>
      </div>
      <!-- Call Actions -->
      <app-softphone-call-actions
        [status]="status()"
        [callActive]="callActive()"
        [muted]="muted()"
        [onHold]="onHold()"
        [holdInProgress]="holdInProgress()"
        (connect)="connect()"
        (call)="call()"
        (hangup)="hangup()"
        (muteToggle)="toggleMute()"
        (holdToggle)="toggleHold()"
        [(transferTarget)]="transferTarget"
        (transfer)="transfer($event)"
        [dtmfSequence]="dtmfSequence"
        (pressKey)="pressKey($event)"
        (clearDtmf)="clearDtmf()"
      ></app-softphone-call-actions>

      <!-- Dial Tab Content (extracted to component) -->
      <app-softphone-dial-tab
        *ngIf="activeTab() === 'dial' && !callActive()"
        [callee]="callee"
        (calleeChange)="callee = $event"
        (pressKey)="pressKey($event)"
        (call)="call()"
        (removeLast)="removeLast()"
        (clearNumber)="clearNumber()"
      ></app-softphone-dial-tab>

      <!-- Call Info (when active call) -->
      <app-softphone-call-info
        *ngIf="callActive() && activeTab() === 'dial'"
        [callee]="callee"
        [callDuration]="callDuration()"
      ></app-softphone-call-info>

      <!-- DTMF moved into call actions component -->

      <!-- Call History Tab -->
      <app-softphone-call-history
        *ngIf="activeTab() === 'history'"
        [operatorId]="sipUser"
      />

      <!-- Info Tab (extracted to component) -->
      <app-softphone-info-tab
        *ngIf="activeTab() === 'info'"
        [phone]="incoming() ? incomingFrom() : callee"
      ></app-softphone-info-tab>

      <!-- Scripts Panel -->
      <ng-container *ngIf="activeTab() === 'scenarios'">
        <app-softphone-scripts-panel
          [callActive]="callActive()"
          [showScripts]="showScripts()"
          [scripts]="scripts()"
          [selectedBranch]="selectedScriptBranch()"
          (selectBranch)="onSelectedBranch($event)"
          (registerCdr)="manualRegisterCall($event)"
          (toggleScripts)="toggleScripts()"
        />
      </ng-container>
    </div>
  </div>
</div>

<!-- Audio elements -->
<audio id="remoteAudio" autoplay class="audio-element"></audio>
<audio id="ringtoneAudio" loop class="audio-element"></audio>
