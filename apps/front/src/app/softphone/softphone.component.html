<!-- Softphone container: expandable -->
<div class="fixed bottom-4 right-4 z-50">
  <!-- Minimized floating button -->
  <button
    *ngIf="!panelSvc.expanded()"
    (click)="toggleExpand()"
    title="Open softphone"
    class="floating-button"
  >
    <span class="material-icons">call</span>
    <!-- Active call indicator -->
    <span *ngIf="callState.callActive()" class="active-call-indicator"></span>
    <!-- Missed call badge -->
    <span *ngIf="missedCallCount" class="missed-call-badge">{{
      missedCallCount > 99 ? '99+' : missedCallCount
    }}</span>
  </button>

  <!-- Expanded panel -->
  <div
    *ngIf="panelSvc.expanded()"
    #expandedPanel
    class="expanded-panel"
    [class.docked]="panelSvc.pinned()"
    [class.scripts-expanded]="activeTab === 'scenarios' && viewMode() === 'fullscreen'"
    [class.scripts-with-details]="activeTab === 'scenarios' && viewedScript()"
    [class.resizing]="panelSvc.panelResizing()"
    [style.width.px]="panelSvc.panelWidth()"
    [style.height]="panelSvc.pinned() ? '100vh' : (panelSvc.panelHeight() ? (panelSvc.panelHeight() + 'px') : null)"
    (mousemove)="onPanelMouseMove($event)"
    (mouseleave)="onPanelMouseLeave()"
    (mousedown)="onPanelMouseDown($event)"
  >
    <div class="panel-header">
      <div class="header-content">
        <div class="status-bar">
          <app-softphone-status-bar
            [status]="status()"
            [callActive]="callState.callActive()"
            [paused]="memberPaused()"
            [reason]="memberReason()"
            (pauseChange)="onMemberPauseChange($event)"
          ></app-softphone-status-bar>
        </div>
        <div class="header-actions">
          <button
            (click)="togglePinned()"
            [title]="panelSvc.pinned() ? 'Открепить' : 'Закрепить справа'"
            class="pin-button"
            [class.active]="panelSvc.pinned()"
          >
            <span class="material-icons">push_pin</span>
          </button>
          <button
            (click)="toggleExpand()"
            title="Minimize"
            class="minimize-button"
          >
            <span class="material-icons">remove</span>
          </button>
        </div>
      </div>
      
      <!-- Active Call Info Bar (always visible) -->
      <div class="active-call-bar" *ngIf="callState.callActive()">
        <div class="call-bar-content">
          <div class="call-bar-left">
            <span class="pulse-indicator"></span>
            <div class="call-info-compact">
              <div class="caller-number">{{ callState.incomingFrom() || callee || 'Неизвестный' }}</div>
              <div class="call-badges" *ngIf="callState.muted() || callState.onHold()">
                <span class="badge badge-mute" *ngIf="callState.muted()" title="Микрофон выключен">
                  <span class="material-icons">mic_off</span>
                </span>
                <span class="badge badge-hold" *ngIf="callState.onHold()" title="На удержании">
                  <span class="material-icons">pause</span>
                </span>
              </div>
            </div>
          </div>
          <div class="call-timer">{{ callState.callDuration() }}</div>
        </div>
      </div>
    </div>

    <div class="panel-content">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <div class="tab-buttons">
          <button
            (click)="selectTab('dial')"
            [class.active]="activeTab === 'dial'"
            class="tab-button"
          >
            <span class="material-icons">call</span>
            <span>Звонок</span>
          </button>
          <button
            (click)="selectTab('history')"
            [class.active]="activeTab === 'history'"
            class="tab-button"
          >
            <span class="material-icons">history</span>
            <span>История</span>
          </button>
          <button
            (click)="selectTab('scenarios')"
            [class.active]="activeTab === 'scenarios'"
            class="tab-button"
          >
            <span class="material-icons">menu_book</span>
            <span>Сценарии</span>
          </button>
          <button
            (click)="selectTab('info')"
            [class.active]="activeTab === 'info'"
            class="tab-button"
          >
            <span class="material-icons">info</span>
            <span>Инфо</span>
          </button>
        </div>
      </div>


      <!-- Call Actions -->
      <app-softphone-call-actions
        [status]="status()"
        [callActive]="callState.callActive()"
        [muted]="callState.muted()"
        [onHold]="callState.onHold()"
        [holdInProgress]="callState.holdInProgress()"
        (connect)="connect()"
        (call)="call()"
        (hangup)="hangup()"
        (muteToggle)="toggleMute()"
        (holdToggle)="toggleHold()"
        [(transferTarget)]="transferTarget"
        (transfer)="transfer($event)"
        [dtmfSequence]="dtmfSequence"
        (pressKey)="pressKey($event)"
        (clearDtmf)="clearDtmf()"
      ></app-softphone-call-actions>

      <!-- Dial Tab Content (extracted to component) -->
      <app-softphone-dial-tab
        *ngIf="activeTab === 'dial' && !callState.callActive()"
        [callee]="callee"
        (calleeChange)="callee = $event"
        (pressKey)="pressKey($event)"
        (call)="call()"
        (removeLast)="removeLast()"
        (clearNumber)="clearNumber()"
      ></app-softphone-dial-tab>

      <!-- DTMF moved into call actions component -->

      <!-- Call History Tab -->
      <app-softphone-call-history
        *ngIf="activeTab === 'history'"
        [operatorId]="sipUser"
      />

      <!-- Info Tab (extracted to component) -->
      <app-softphone-info-tab
        *ngIf="activeTab === 'info'"
        [phone]="callState.incoming() ? callState.incomingFrom() : callee"
      ></app-softphone-info-tab>

      <!-- Scripts Panel -->
      <ng-container *ngIf="activeTab === 'scenarios'">
        <app-softphone-scripts-panel
          [callActive]="callState.callActive()"
          [showScripts]="showScripts()"
          [scripts]="scripts()"
          [selectedBranch]="callState.selectedScriptBranch()"
          (selectBranch)="onSelectedBranch($event)"
          (registerCdr)="manualRegisterCall($event)"
          (toggleScripts)="toggleScripts()"
          (viewModeChange)="onScriptViewModeChange($event)"
          (viewedScriptChange)="onScriptDetailsChange($event)"
        />
      </ng-container>

      <!-- Incoming Call Modal (inside panel-content) -->
      <div class="incoming-call-modal" *ngIf="callState.incoming()" @fadeIn>
        <div class="incoming-call-overlay" (click)="rejectIncoming()"></div>
        <div class="incoming-call-content" @slideUp>
          <!-- Avatar/Icon -->
          <div class="caller-avatar">
            <div class="avatar-ring"></div>
            <div class="avatar-icon">
              <span class="material-icons">person</span>
            </div>
          </div>

          <!-- Caller Info -->
          <div class="caller-details">
            <h2 class="caller-title">Входящий звонок</h2>
            <div class="caller-name">{{ callState.incomingFrom() || 'Неизвестный абонент' }}</div>
            <div class="caller-meta">Softphone</div>
          </div>

          <!-- Action Buttons -->
          <div class="incoming-call-actions">
            <button class="call-action-btn decline-btn" (click)="rejectIncoming()" title="Отклонить">
              <div class="btn-icon-wrapper decline">
                <span class="material-icons">call_end</span>
              </div>
              <span class="btn-label">Отклонить</span>
            </button>

            <button class="call-action-btn accept-btn" (click)="answerIncoming()" title="Принять">
              <div class="btn-icon-wrapper accept">
                <span class="material-icons">call</span>
              </div>
              <span class="btn-label">Принять</span>
            </button>
          </div>

          <!-- Quick Actions -->
          <div class="quick-actions">
            <button class="quick-action-btn" title="Отправить SMS">
              <span class="material-icons">message</span>
            </button>
            <button class="quick-action-btn" title="Напомнить позже">
              <span class="material-icons">schedule</span>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

<audio id="ringtoneAudio" loop class="audio-element"></audio>
