<!-- Softphone container: expandable -->
<div class="fixed bottom-4 right-4 z-50">
  <!-- Minimized floating button -->
  <button
    *ngIf="!expanded"
    (click)="toggleExpand()"
    title="Open softphone"
    class="floating-button"
  >
    <span class="material-icons">call</span>
    <!-- Active call indicator -->
    <span
      *ngIf="callActive()"
      class="active-call-indicator"
    ></span>
    <!-- Missed call badge -->
    <span
      *ngIf="missedCallCount"
      class="missed-call-badge"
    >{{ missedCallCount > 99 ? '99+' : missedCallCount }}</span>
  </button>

  <!-- Expanded panel -->
  <div
    *ngIf="expanded"
    class="expanded-panel"
  >
    <div class="panel-header">
      <div class="header-content">
        <div class="status-bar">
          <app-softphone-status-bar
            [status]="status()"
            [callActive]="callActive()"
          ></app-softphone-status-bar>
        </div>
        <button
          (click)="toggleExpand()"
          title="Minimize"
          class="minimize-button"
        >
          <span class="material-icons">remove</span>
        </button>
      </div>
    </div>

    <div class="panel-content">
      <!-- Tab Navigation -->
      <div class="tab-navigation">
        <div class="tab-buttons">
          <button
            (click)="activeTab = 'dial'"
            [class.active]="activeTab === 'dial'"
            class="tab-button"
          >
            <span class="material-icons">call</span>
            <span>Звонок</span>
          </button>
          <button
            (click)="activeTab = 'history'"
            [class.active]="activeTab === 'history'"
            class="tab-button"
          >
            <span class="material-icons">history</span>
            <span>История</span>
          </button>
        </div>
      </div>

      <!-- Incoming call alert -->
      <div
        *ngIf="incoming()"
        class="incoming-call-alert"
      >
        <div class="incoming-call-header">
          <div class="incoming-call-info">
            <span class="material-icons call-type-icon">call</span>
            <div>
              <div class="caller-name">Входящий звонок</div>
              <div class="caller-number">{{ incomingFrom() || 'Неизвестный абонент' }}</div>
            </div>
          </div>
        </div>
        <div class="incoming-call-actions">
          <button
            (click)="answerIncoming()"
            class="answer-button"
          >
            <span class="material-icons">call</span>
            Принять
          </button>
          <button
            (click)="rejectIncoming()"
            class="reject-button"
          >
            <span class="material-icons">call_end</span>
            Отклонить
          </button>
        </div>
      </div>

      <!-- Dial Tab Content -->
      <div *ngIf="activeTab === 'dial' && !callActive()" class="dialer-section">
        <div class="number-input">
          <input
            [(ngModel)]="callee"
            [title]="callee"
            placeholder="Введите номер"
            class="number-display"
          />
          <div class="input-actions">
            <button
              *ngIf="callee"
              (click)="removeLast()"
              class="action-button"
              title="Удалить последний символ"
            >
              <span class="material-icons">backspace</span>
            </button>
            <button
              *ngIf="callee"
              (click)="clearNumber()"
              class="action-button"
              title="Очистить номер"
            >
              <span class="material-icons">close</span>
            </button>
          </div>
        </div>

        <div class="dialpad">
          <button
            *ngFor="let key of ['1', '2', '3', '4', '5', '6', '7', '8', '9', '*', '0', '#']"
            (click)="pressKey(key)"
            class="dial-button"
          >
            {{ key }}
          </button>
        </div>

        <button
          (click)="call()"
          [disabled]="!callee"
          class="call-button"
        >
          <span class="material-icons">call</span>
          Позвонить
        </button>
      </div>

      <!-- Call Info (when active call) -->
      <app-softphone-call-info
        *ngIf="callActive() && activeTab === 'dial'"
        [callee]="callee"
        [callDuration]="callDuration()"
      ></app-softphone-call-info>

      <!-- DTMF Section (during active call) -->
      <div *ngIf="callActive() && activeTab === 'dial'" class="dtmf-section">
        <div class="dtmf-header">
          <span class="dtmf-label">Отправить DTMF</span>
          <span *ngIf="dtmfSequence" class="dtmf-sequence">
            {{ dtmfSequence }}
            <button
              (click)="clearDtmf()"
              class="action-button"
              style="margin-left: 0.5rem; width: 1.5rem; height: 1.5rem;"
              title="Очистить"
            >
              <span class="material-icons" style="font-size: 1rem;">close</span>
            </button>
          </span>
        </div>
        <div class="dtmf-pad">
          <button
            *ngFor="let key of ['1', '2', '3', '4', '5', '6', '7', '8', '9', '*', '0', '#']"
            (click)="pressKey(key)"
            class="dtmf-button"
          >
            {{ key }}
          </button>
        </div>
      </div>

      <!-- Call History Tab -->
                  <app-softphone-call-history
              *ngIf="activeTab === 'history'"
              [operatorId]="sipUser"
            />

      <!-- Call Actions -->
      <app-softphone-call-actions
        [status]="status()"
        [callActive]="callActive()"
        [muted]="muted()"
        [onHold]="onHold()"
        [holdInProgress]="holdInProgress()"
        (connect)="connect()"
        (call)="call()"
        (hangup)="hangup()"
        (muteToggle)="toggleMute()"
        (holdToggle)="toggleHold()"
      ></app-softphone-call-actions>

      <!-- Call Notes (during active call) -->
      <div *ngIf="callActive()" class="call-notes-section">
        <label class="notes-label" for="call-note">Добавить заметку</label>
        <textarea
          id="call-note"
          rows="4"
          class="notes-textarea"
          placeholder="Добавьте заметку о звонке..."
        ></textarea>
      </div>

      <!-- Transfer Section (during active call) -->
      <div *ngIf="callActive()" class="transfer-section">
        <label class="transfer-label" for="transfer-target">Перевод звонка</label>
        <div class="transfer-controls">
          <input
            id="transfer-target"
            [(ngModel)]="transferTarget"
            placeholder="SIP/1000 или 1000"
            class="transfer-input"
          />
          <div class="transfer-buttons">
            <button
              (click)="transfer('blind')"
              class="transfer-button blind"
            >
              Слепой
            </button>
            <button
              (click)="transfer('attended')"
              class="transfer-button attended"
            >
              Консультационный
            </button>
          </div>
        </div>
      </div>

      <!-- Scripts Panel -->
      <app-softphone-scripts-panel
        [callActive]="callActive()"
      />
    </div>
  </div>
</div>

<!-- Audio elements -->
<audio id="remoteAudio" autoplay class="audio-element"></audio>
<audio id="ringtoneAudio" loop class="audio-element"></audio>
