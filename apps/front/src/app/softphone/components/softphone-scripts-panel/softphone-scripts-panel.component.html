<div class="scripts-panel">
  <div class="header">
    <div class="search-wrap">
      <input
        placeholder="Search scenarios..."
        [ngModel]="search()"
        (ngModelChange)="search.set($event)"
        class="search-input"
      />
    </div>
  </div>

  <div class="tabs">
    <button
      [class.active]="activeTab() === 'all'"
      (click)="activeTab.set('all')"
    >
      All
    </button>
    <button
      [class.active]="activeTab() === 'recent'"
      (click)="activeTab.set('recent')"
    >
      Recent
    </button>
    <button
      [class.active]="activeTab() === 'bookmarked'"
      (click)="activeTab.set('bookmarked')"
    >
      Bookmarked
    </button>
  </div>

  <div class="content">
    <div class="debug-info" *ngIf="(scriptsForTemplate() || []).length === 0">
      <div class="no-scripts">
        No scripts loaded (debug): {{ (scriptsForTemplate() || []).length }}
      </div>
    </div>
    <div class="recently-used" *ngIf="activeTab() === 'recent'">
      <div class="section-title">Recently Used</div>
      <ul>
        <li
          *ngFor="let s of scriptsForTemplate() || [] | slice : 0 : 3"
          class="recent-item"
        >
          <span class="title">{{ s.title }}</span>
          <button class="bookmark" (click)="toggleBookmark(s)">
            <span class="material-icons">bookmark_border</span>
          </button>
        </li>
      </ul>
    </div>

    <div class="folders">
      <ng-container *ngFor="let cat of categoriesKeys()">
        <div class="folder">
          <div class="folder-header" (click)="toggleCategory(cat)">
            <span class="material-icons">folder</span>
            <span class="folder-title">{{ cat }}</span>
            <div class="spacer"></div>
            <button class="bookmark-all" (click)="$event.stopPropagation()">
              <span class="material-icons">bookmark_border</span>
            </button>
          </div>

          <div class="folder-items" *ngIf="expandedCategories()[cat]">
            <ng-container
              *ngFor="let script of categories()[cat]; trackBy: trackByScriptId"
            >
              <ng-template
                #scriptNode
                let-s
                let-level="level"
                let-isLast="isLast"
              >
                <div
                  class="script-item"
                  [class.has-children]="s.children?.length"
                  [style.--level]="level || 0"
                >
                  <div
                    class="script-row"
                    (click)="
                      s.children?.length ? toggleNode(s.id) : selectLeaf(s)
                    "
                    [class.clickable]="s.children?.length"
                    [class.selected]="
                      !s.children?.length &&
                      (localSelected() === s.id || selectedBranch() === s.id)
                    "
                  >
                    <div class="script-left">
                      <span class="tree-icon" *ngIf="s.children?.length">
                        <span class="material-icons">{{
                          isNodeExpanded(s.id) ? 'expand_more' : 'chevron_right'
                        }}</span>
                      </span>
                      <span
                        class="tree-icon placeholder"
                        *ngIf="!s.children?.length"
                      ></span>
                      <span class="script-icon material-icons">{{
                        s.children?.length ? 'folder_open' : 'description'
                      }}</span>
                      <div class="script-info">
                        <div class="script-title">{{ s.title }}</div>
                        <div class="script-sub" *ngIf="s.description">
                          {{ s.description }}
                        </div>
                      </div>
                    </div>
                    <div class="script-right">
                      <button
                        mat-icon-button
                        (click)="toggleBookmark(s); $event.stopPropagation()"
                      >
                        <mat-icon>{{
                          s.bookmarked ? 'bookmark' : 'bookmark_border'
                        }}</mat-icon>
                      </button>
                    </div>
                  </div>
                  <!-- If this is a leaf and selected, show optional note + create task toggle -->
                  <div
                    *ngIf="!s.children?.length && localSelected() === s.id"
                    style="
                      padding: 8px 4px 0 4px;
                      display: flex;
                      flex-direction: column;
                      gap: 8px;
                    "
                  >
                    <textarea
                      placeholder="Добавить заметку (необязательно)"
                      class="search-input"
                      [ngModel]="branchNote()"
                      (ngModelChange)="branchNote.set($event)"
                      rows="3"
                    ></textarea>
                    <label
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-size: 13px;
                        color: var(--text-secondary);
                      "
                    >
                      <mat-slide-toggle
                        [checked]="createTaskToggle()"
                        (change)="createTaskToggle.set($event.checked)"
                        >Создать задачу сразу</mat-slide-toggle
                      >
                    </label>
                    <div
                      style="display: flex; gap: 8px; justify-content: flex-end"
                    >
                      <button
                        mat-stroked-button
                        color="warn"
                        (click)="cancelSelection(); $event.stopPropagation()"
                        title="Отмена"
                      >
                        Отмена
                      </button>
                      <button
                        mat-raised-button
                        color="primary"
                        (click)="saveForSelected(); $event.stopPropagation()"
                        [disabled]="!callActive()"
                        title="Сохранить"
                      >
                        Сохранить
                      </button>
                    </div>
                  </div>
                  <div
                    class="children"
                    *ngIf="s.children?.length && isNodeExpanded(s.id)"
                  >
                    <ng-container
                      *ngFor="
                        let child of s.children;
                        let childLast = last;
                        trackBy: trackByScriptId
                      "
                    >
                      <ng-container
                        *ngTemplateOutlet="
                          scriptNode;
                          context: {
                            $implicit: child,
                            level: (level || 0) + 1,
                            isLast: childLast
                          }
                        "
                      ></ng-container>
                    </ng-container>
                  </div>
                </div>
              </ng-template>

              <ng-container
                *ngTemplateOutlet="
                  scriptNode;
                  context: { $implicit: script, level: 0, isLast: false }
                "
              ></ng-container>
            </ng-container>
          </div>
        </div>
      </ng-container>
    </div>
  </div>
</div>
