<div class="scripts-panel" [class.fullscreen]="viewMode() === 'fullscreen'">
  <div class="header">
    <div class="search-wrap">
      <input
        placeholder="Search scenarios..."
        [ngModel]="search()"
        (ngModelChange)="search.set($event)"
        class="search-input"
      />
    </div>
    <button
      mat-icon-button
      (click)="toggleViewMode()"
      [title]="viewMode() === 'compact' ? '–†–∞–∑–≤–µ—Ä–Ω—É—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω' : '–°–≤–µ—Ä–Ω—É—Ç—å'"
      class="view-toggle"
    >
      <mat-icon>{{ viewMode() === 'compact' ? 'fullscreen' : 'fullscreen_exit' }}</mat-icon>
    </button>
  </div>

  <div class="tabs">
    <button
      [class.active]="activeTab() === 'all'"
      (click)="activeTab.set('all')"
    >
      All
    </button>
    <button
      [class.active]="activeTab() === 'recent'"
      (click)="activeTab.set('recent')"
    >
      Recent
    </button>
    <button
      [class.active]="activeTab() === 'bookmarked'"
      (click)="activeTab.set('bookmarked')"
    >
      Bookmarked
    </button>
    <div class="keyboard-hint" *ngIf="viewMode() === 'fullscreen'">
      <mat-icon>keyboard</mat-icon>
      <span>Esc - –≤—ã—Ö–æ–¥ | Ctrl+F - –ø–æ–ª–Ω—ã–π —ç–∫—Ä–∞–Ω</span>
    </div>
  </div>

  <div class="content">
    <div class="debug-info" *ngIf="(scriptsForTemplate() || []).length === 0">
      <div class="no-scripts">
        No scripts loaded (debug): {{ (scriptsForTemplate() || []).length }}
      </div>
    </div>
    <div class="recently-used" *ngIf="activeTab() === 'recent'">
      <div class="section-title">Recently Used</div>
      <ul>
        <li
          *ngFor="let s of scriptsForTemplate() || [] | slice : 0 : 3"
          class="recent-item"
        >
          <span class="title">{{ s.title }}</span>
          <button class="bookmark" (click)="toggleBookmark(s)">
            <span class="material-icons">bookmark_border</span>
          </button>
        </li>
      </ul>
    </div>

    <div class="folders">
      <ng-container *ngFor="let cat of categoriesKeys()">
        <div class="folder">
          <div class="folder-header" (click)="toggleCategory(cat)">
            <span class="material-icons">folder</span>
            <span class="folder-title">{{ cat }}</span>
            <div class="spacer"></div>
            <button class="bookmark-all" (click)="$event.stopPropagation()">
              <span class="material-icons">bookmark_border</span>
            </button>
          </div>

          <div class="folder-items" *ngIf="expandedCategories()[cat]">
            <ng-container
              *ngFor="let script of categories()[cat]; trackBy: trackByScriptId"
            >
              <ng-template
                #scriptNode
                let-s
                let-level="level"
                let-isLast="isLast"
              >
                <div
                  class="script-item"
                  [class.has-children]="s.children?.length"
                  [style.--level]="level || 0"
                >
                  <div
                    class="script-row"
                    (click)="
                      s.children?.length ? toggleNode(s.id) : selectLeaf(s)
                    "
                    [class.clickable]="s.children?.length"
                    [class.selected]="
                      !s.children?.length &&
                      (localSelected() === s.id || selectedBranch() === s.id)
                    "
                  >
                    <div class="script-left">
                      <span class="tree-icon" *ngIf="s.children?.length">
                        <span class="material-icons">{{
                          isNodeExpanded(s.id) ? 'expand_more' : 'chevron_right'
                        }}</span>
                      </span>
                      <span
                        class="tree-icon placeholder"
                        *ngIf="!s.children?.length"
                      ></span>
                      <span class="script-icon material-icons">{{
                        s.children?.length ? 'folder_open' : 'description'
                      }}</span>
                      <div class="script-info">
                        <div class="script-title">{{ s.title }}</div>
                        <div class="script-sub" *ngIf="s.description">
                          {{ s.description }}
                        </div>
                      </div>
                    </div>
                    <div class="script-right">
                      <button
                        mat-icon-button                        *ngIf="hasScriptContent(s)"
                        (click)="viewScriptDetails(s); $event.stopPropagation()"
                        title="–ü—Ä–æ—Å–º–æ—Ç—Ä–µ—Ç—å –¥–µ—Ç–∞–ª–∏ —Å–∫—Ä–∏–ø—Ç–∞"
                      >
                        <mat-icon>visibility</mat-icon>
                      </button>
                      <button
                        mat-icon-button                        (click)="toggleBookmark(s); $event.stopPropagation()"
                      >
                        <mat-icon>{{
                          s.bookmarked ? 'bookmark' : 'bookmark_border'
                        }}</mat-icon>
                      </button>
                    </div>
                  </div>
                  <!-- If this is a leaf and selected, show optional note + create task toggle -->
                  <div
                    *ngIf="!s.children?.length && localSelected() === s.id"
                    style="
                      padding: 8px 4px 0 4px;
                      display: flex;
                      flex-direction: column;
                      gap: 8px;
                    "
                  >
                    <textarea
                      placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
                      class="search-input"
                      [ngModel]="branchNote()"
                      (ngModelChange)="branchNote.set($event)"
                      rows="3"
                    ></textarea>
                    <label
                      style="
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-size: 13px;
                        color: var(--text-secondary);
                      "
                    >
                      <mat-slide-toggle
                        [checked]="createTaskToggle()"
                        (change)="createTaskToggle.set($event.checked)"
                        >–°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É —Å—Ä–∞–∑—É</mat-slide-toggle
                      >
                    </label>
                    <div
                      style="display: flex; gap: 8px; justify-content: flex-end"
                    >
                      <button
                        mat-stroked-button
                        color="warn"
                        (click)="cancelSelection(); $event.stopPropagation()"
                        title="–û—Ç–º–µ–Ω–∞"
                      >
                        –û—Ç–º–µ–Ω–∞
                      </button>
                      <button
                        mat-raised-button
                        color="primary"
                        (click)="saveForSelected(); $event.stopPropagation()"
                        [disabled]="!callActive()"
                        title="–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
                      >
                        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å
                      </button>
                    </div>
                  </div>
                  <div
                    class="children"
                    *ngIf="s.children?.length && isNodeExpanded(s.id)"
                  >
                    <ng-container
                      *ngFor="
                        let child of s.children;
                        let childLast = last;
                        trackBy: trackByScriptId
                      "
                    >
                      <ng-container
                        *ngTemplateOutlet="
                          scriptNode;
                          context: {
                            $implicit: child,
                            level: (level || 0) + 1,
                            isLast: childLast
                          }
                        "
                      ></ng-container>
                    </ng-container>
                  </div>
                </div>
              </ng-template>

              <ng-container
                *ngTemplateOutlet="
                  scriptNode;
                  context: { $implicit: script, level: 0, isLast: false }
                "
              ></ng-container>
            </ng-container>
          </div>
        </div>
      </ng-container>
    </div>
  </div>

  <!-- Script details panel -->
  <div class="script-details-panel" *ngIf="viewedScript()" [@slideIn]>
    <div class="details-header">
      <h3>{{ viewedScript()?.title }}</h3>
      <button mat-icon-button (click)="closeScriptDetails()" title="–ó–∞–∫—Ä—ã—Ç—å">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <div class="details-content">
      <div class="detail-section description-section" *ngIf="viewedScript()?.description">
        <h4><mat-icon class="icon-info">info</mat-icon> –û–ø–∏—Å–∞–Ω–∏–µ</h4>
        <p>{{ viewedScript()?.description }}</p>
      </div>
      
      <div class="detail-section steps-section" *ngIf="viewedScript()?.steps?.length">
        <h4><mat-icon class="icon-steps">format_list_numbered</mat-icon> –®–∞–≥–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è</h4>
        <ol class="steps-list">
          <li *ngFor="let step of viewedScript()?.steps; let i = index">
            <span class="step-number">{{i + 1}}</span>
            <span class="step-text">{{ step }}</span>
          </li>
        </ol>
      </div>
      
      <div class="detail-section questions-section" *ngIf="viewedScript()?.questions?.length">
        <h4><mat-icon class="icon-questions">help_outline</mat-icon> –í–æ–ø—Ä–æ—Å—ã –∫–ª–∏–µ–Ω—Ç—É</h4>
        <ul class="questions-list">
          <li *ngFor="let q of viewedScript()?.questions">{{ q }}</li>
        </ul>
      </div>
      
      <div class="detail-section tips-section" *ngIf="viewedScript()?.tips?.length">
        <h4><mat-icon class="icon-tips">lightbulb_outline</mat-icon> –ü–æ–ª–µ–∑–Ω—ã–µ —Å–æ–≤–µ—Ç—ã</h4>
        <ul class="tips-list">
          <li *ngFor="let tip of viewedScript()?.tips">
            <mat-icon class="tip-icon">tips_and_updates</mat-icon>
            {{ tip }}
          </li>
        </ul>
      </div>

      <!-- Empty state when no content -->
      <div class="empty-content" *ngIf="!hasScriptContent(viewedScript()!)">
        <mat-icon class="empty-icon">description</mat-icon>
        <p class="empty-text">–£ —ç—Ç–æ–≥–æ —Å–∫—Ä–∏–ø—Ç–∞ –ø–æ–∫–∞ –Ω–µ—Ç –¥–µ—Ç–∞–ª—å–Ω–æ–≥–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–≥–æ</p>
        <p class="empty-hint">–í—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —à–∞–≥–∏, –≤–æ–ø—Ä–æ—Å—ã –∏ —Å–æ–≤–µ—Ç—ã –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö —Å–∫—Ä–∏–ø—Ç–∞</p>
      </div>

      <!-- Inline logging form when script is selected -->
      <div class="inline-logging-form" *ngIf="localSelected() === viewedScript()?.id">
        <div class="form-section">
          <h4>üìù –õ–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –∑–≤–æ–Ω–∫–∞</h4>
          <textarea
            placeholder="–î–æ–±–∞–≤–∏—Ç—å –∑–∞–º–µ—Ç–∫—É (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)"
            class="log-textarea"
            [ngModel]="branchNote()"
            (ngModelChange)="branchNote.set($event)"
            rows="4"
          ></textarea>
          <label class="task-toggle-label">
            <mat-slide-toggle
              [checked]="createTaskToggle()"
              (change)="createTaskToggle.set($event.checked)"
            >
              –°–æ–∑–¥–∞—Ç—å –∑–∞–¥–∞—á—É —Å—Ä–∞–∑—É
            </mat-slide-toggle>
          </label>
        </div>
      </div>
    </div>
    
    <!-- Actions outside of scrollable content -->
    <div class="detail-actions" *ngIf="!viewedScript()?.children?.length">
      <button
        *ngIf="localSelected() !== viewedScript()?.id"
        mat-raised-button
        color="primary"
        (click)="selectLeaf(viewedScript()!)"
      >
        <mat-icon>check_circle</mat-icon>
        –ò—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —ç—Ç–æ—Ç —Å–∫—Ä–∏–ø—Ç
      </button>
      <button
        *ngIf="localSelected() === viewedScript()?.id"
        mat-raised-button
        color="accent"
        (click)="saveForSelected(); closeScriptDetails()"
        [disabled]="!callActive()"
      >
        <mat-icon>save</mat-icon>
        –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏ –∑–∞–∫—Ä—ã—Ç—å
      </button>
      <button
        *ngIf="localSelected() === viewedScript()?.id"
        mat-stroked-button
        (click)="cancelSelection()"
      >
        –û—Ç–º–µ–Ω–∞
      </button>
    </div>
  </div>
</div>
