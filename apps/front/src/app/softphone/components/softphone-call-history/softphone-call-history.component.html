<div class="call-history-container">
  <!-- Header with search -->
  <div class="header">
    <div class="search-wrapper">
      <mat-icon class="search-icon">search</mat-icon>
      <input 
        type="text" 
        class="search-input"
        [(ngModel)]="searchQuery" 
        (ngModelChange)="onSearchChange($event)" 
        placeholder="Поиск по номеру телефона..."
        [disabled]="isLoading()">
      <button 
        *ngIf="searchQuery()" 
        mat-icon-button 
        class="clear-search-btn"
        (click)="clearSearch()">
        <mat-icon>close</mat-icon>
      </button>
    </div>
    <button 
      mat-icon-button 
      (click)="refreshHistory()" 
      [disabled]="isLoading()" 
      class="refresh-btn"
      matTooltip="Обновить">
      <mat-icon [class.spinning]="isLoading()">refresh</mat-icon>
    </button>
  </div>

  <!-- Content -->
  <div class="content">
    <!-- Error State -->
    <div class="state-message error-state" *ngIf="error()">
      <div class="state-icon error">
        <mat-icon>error_outline</mat-icon>
      </div>
      <h4>Ошибка загрузки</h4>
      <p>{{ error() }}</p>
      <button mat-raised-button color="primary" (click)="refreshHistory()">
        <mat-icon>refresh</mat-icon>
        Повторить
      </button>
    </div>

    <!-- Empty State -->
    <div class="state-message empty-state" *ngIf="!isLoading() && !error() && (!calls() || calls().length === 0)">
      <div class="state-icon empty">
        <mat-icon>phone_disabled</mat-icon>
      </div>
      <h4>Звонки не найдены</h4>
      <p>История звонков пуста. Попробуйте изменить параметры поиска.</p>
      <button mat-stroked-button (click)="clearAllFilters()">
        <mat-icon>clear_all</mat-icon>
        Очистить фильтры
      </button>
    </div>

    <!-- Loading -->
    <div class="state-message loading" *ngIf="isLoading()">
      <mat-spinner diameter="48" strokeWidth="3"></mat-spinner>
      <p>Загрузка истории звонков...</p>
    </div>

    <!-- Calls List -->
    <div class="calls-list" *ngIf="!isLoading() && !error() && calls() && calls().length > 0">
      <div 
        *ngFor="let call of calls(); trackBy: trackByCallId" 
        class="call-item"
        [class.recent]="isRecentCall(call)"
        [class.missed]="call.disposition !== 'ANSWERED'">
        
        <!-- Call Icon & Direction -->
        <div class="call-icon" [class.incoming]="getDirectionLabel(call) === 'Входящий'">
          <mat-icon>{{ getDirectionIcon(call) }}</mat-icon>
        </div>

        <!-- Call Info -->
        <div class="call-info">
          <div class="call-header">
            <span class="number">{{ call.src || call.dst }}</span>
            <mat-icon 
              *ngIf="getCallNotes(call)" 
              class="notes-badge"
              [matTooltip]="getCallNotes(call)">
              chat_bubble
            </mat-icon>
          </div>
          <div class="call-meta">
            <span class="time">{{ formatCallTime(call.calldate) }}</span>
            <span class="separator">•</span>
            <span class="date">{{ formatCallDate(call.calldate) }}</span>
            <span class="separator">•</span>
            <span class="duration">{{ formatDuration(call.duration) }}</span>
          </div>
        </div>

        <!-- Call Status Badge -->
        <div class="call-status" [attr.data-status]="call.disposition">
          <span class="status-text">{{ getDispositionLabel(call) }}</span>
        </div>

        <!-- Actions -->
        <div class="call-actions">
          <button
            mat-icon-button
            (click)="callNumber(call.src || call.dst)"
            matTooltip="Позвонить"
            class="action-call">
            <mat-icon>phone</mat-icon>
          </button>
          <button
            mat-icon-button
            (click)="showCallDetails(call)"
            matTooltip="Детали"
            class="action-info">
            <mat-icon>info</mat-icon>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <mat-paginator
    *ngIf="!isLoading() && !error() && calls() && calls().length > 0"
    [length]="totalRecords()"
    [pageSize]="pageSize()"
    [pageSizeOptions]="[10, 20, 50, 100]"
    (page)="onPageChange($event)"
    showFirstLastButtons
    class="custom-paginator">
  </mat-paginator>
</div>