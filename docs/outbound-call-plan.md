# План разработки исходящего обзвона

Документ описывает поэтапную реализацию исходящего обзвона в монорепо `crm_mono` (Nx). Учитывает текущую архитектуру: `apps/back` (NestJS), `apps/front` (Angular 20 + Vite), `apps/telephony-service` (звонки), `apps/api-gateway` (BFF), общие контракты в `libs/contracts`.

## 1. Цели и сценарии
- Индивидуальные исходящие звонки из карточки лида/таска.
- Серийный обзвон (кампании) по спискам лидов с автоматическим распределением между операторами.
- Логирование попыток, статусы (init, ringing, in-progress, failed, completed, canceled), результаты (no-answer, busy, success, callback-needed).
- Контроль SLA: лимиты попыток, таймауты дозвона, отложенные перезвоны.
- Отчётность: метрики по исходящим (answer rate, duration, retries, conversion).

## 2. Функциональные блоки
- **Телефония**: инициирование звонка, хендлинг статусов/ивентов, обновление UA/softphone.
- **Данные**: сущности кампаний, заданий на звонок, попыток; связи с `Lead`.
- **Оркестрация**: планировщик попыток, стратегия распределения (round-robin/skills), дедупликация.
- **UI**: рабочее место оператора (очередь, карточка звонка), кампании (создание/старт/пауза), отчёты.
- **Интеграции**: webhooks/notifications, аудит, аналитика.

## 3. Бэкенд (NestJS) — шаги
1) **Контракты** (`libs/contracts`):
   - DTO/Events для исходящего звонка: `CreateOutboundCallDto`, `OutboundCallInitiated/Failed/Answered/Ended`.
   - Обновить `telephony.dto.ts` и `events/call.events.ts` новыми статусами/полями (campaignId, attemptId, leadId).
2) **Telephony Service** (`apps/telephony-service`):
   - Endpoint/handler для инициирования исходящего: POST `/calls/outbound` → создаёт запись попытки, пушит задачу в очередь.
   - Интеграция с Asterisk: originate через AMI/ARI (выбрать доступный канал), передача callerId/outbound trunk.
   - Поддержка call-flow: преддобавить `direction: 'outbound'`, прокидывать `campaignId/leadId` в CDR/события.
   - Обработка событий (ringing/answered/failed/completed) → публиковать в брокер и обновлять состояние попыток.
3) **Calls/Back API** (`apps/back`):
   - Сущности: `OutboundCampaign`, `OutboundCallAttempt`, связь с `Lead`, оператором, расписанием.
   - Use-cases: создание/редактирование кампании, загрузка списка лидов, старт/пауза/стоп, выбор стратегии распределения.
   - Планировщик: периодически ищет ожидающие попытки, отправляет на `telephony-service` (через очередь/HTTP).
   - SLA/лимиты: макс. попыток на лид, интервал между ретраями, рабочие окна по часам/таймзонам.
   - Аудит/аналитика: писаться в `call-summary`/analytics сервис (direction=outbound, campaignId).
4) **API Gateway** (`apps/api-gateway`):
   - Маршруты для фронта: управление кампаниями, очередь задач оператора, инициирование единичного звонка, фидбек по исходу.
   - Авторизация/SCOPES: права на обзвон, на кампании, на просмотр аналитики.
5) **Очереди/сообщения**:
   - RabbitMQ каналы: `outbound.call.request`, `outbound.call.events`.
   - Корреляция: `attemptId` в headers для маппинга событий к попыткам.

## 4. Frontend (Angular) — шаги
1) **Контракты/модели**: обновить модели в `libs/contracts`/front shared для новых DTO/статусов.
2) **UI оператора**:
   - Очередь исходящих задач: список ближайших попыток, кнопка «Позвонить», авто-подгрузка следующей.
   - Карточка звонка: данные лида, статус, кнопки «успешно», «нет ответа», «перезвонить позже», заметки.
   - Softphone: ensure UA остаётся зарегистрирован, инициирование через новый endpoint.
3) **UI кампаний**:
   - Создание/редактирование кампании: фильтр лидов, расписание, лимиты, стратегия распределения.
   - Мониторинг: прогресс, текущие звонки, метрики (answer rate, avg duration, retries).
4) **Отчёты**:
   - Раздел аналитики: outbound-only фильтры, графики конверсии/ответов, экспорт CSV.
5) **UX/валидаторы**:
   - Ограничения по времени обзвона, предупреждения о лимитах попыток, обязательные поля (trunk, callerId).

## 5. Инфраструктура и данные
- **Asterisk**: убедиться в наличии outbound trunk, прокси, callerId политики; при необходимости обновить `asterisk-config`.
- **Migrations**: новые таблицы для кампаний/попыток; индексы по `leadId`, `campaignId`, `status`, `scheduledAt`.
- **Feature flags**: включение обзвона по тэгу/флагу для постепенного rollout.
- **Нагрузка**: планировать лимиты параллельных originate, защиту от всплесков.

## 6. Тестирование и контроль качества
- Unit/Integration для сервисов кампаний и планировщика (Nest).
- Контрактные тесты событий/DTO (libs/contracts ↔ telephony/back/front).
- E2E happy-path: создание кампании → несколько звонков → статусы → отчёт.
- Негативные кейсы: нет свободных операторов, превышен лимит попыток, сбой originate, повторная отправка событий.
- Мониторинг: логирование исходящих попыток, алерты по росту `failed/no-answer`, метрики длительности originate.

## 7. Итерационный план поставки
1) Контракты + сущности попыток/кампаний.
2) Originate API в `telephony-service` + события.
3) Планировщик попыток и управление кампаниями в back.
4) UI оператора (очередь + карточка вызова).
5) UI кампаний + аналитика.
6) Нагрузочные/интеграционные тесты, rollout behind feature flag.
