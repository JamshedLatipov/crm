# Автоматический Расчет Дедлайна

## Обзор

Добавлен **тоггл-переключатель** для автоматического расчета дедлайна задачи на основе настроек выбранного типа задачи.

---

## 🎯 Как Работает

### 1. Выбор Типа Задачи

Когда пользователь выбирает **тип задачи** с настроенными временными рамками (`defaultDuration`):

- ✅ Тоггл "Автоматический расчет дедлайна" **автоматически включается**
- ✅ Дедлайн **сразу рассчитывается** на основе настроек типа
- ✅ Показывается уведомление: "Дедлайн рассчитан автоматически"

### 2. Автоматический Режим (Тоггл Включен)

Когда тоггл **включен**:

- 📅 Поле выбора даты **скрывается**
- 🎨 Показывается **красивая карточка** с рассчитанным дедлайном
- 💾 При сохранении используется **рассчитанный дедлайн**

**Внешний вид:**
```
┌─────────────────────────────────────────────────────────────┐
│ 🔵 Автоматический расчет               На основе типа задачи │
└─────────────────────────────────────────────────────────────┘
```

**Когда включен:**
```
┌─────────────────────────────────────────────────────────────┐
│ ✓ � Автоматический расчет                                   │
│ ─────────────────────────────────────────────────────────── │
│ 📅 ДЕДЛАЙН: 22.10.2025 15:45                                │
└─────────────────────────────────────────────────────────────┘
```

**Характеристики:**

### 3. Ручной Режим (Тоггл Выключен)

Когда тоггл **выключен**:

- 📅 Показывается **стандартный datepicker**
- ✏️ Пользователь может **вручную выбрать** дату и время
- 💾 При сохранении используется **введенная дата**

---

## 🎨 Визуальные Элементы

### Компактная Плашка (Выключен тоггл)

**Размер:** 12px padding, 8px border-radius  
**Цвет:** Синий градиент (#f0f9ff → #e0f2fe)  
**Иконка:** `schedule` (18px)  
**Текст:** "Автоматический расчет" (14px)  
**Подсказка справа:** "На основе типа задачи" (12px, italic)

**Внешний вид:**
```
┌──────────────────────────────────────────────────┐
│ 🔵 Автоматический расчет    На основе типа задачи │
└──────────────────────────────────────────────────┘
```

### Расширенная Плашка (Включен тоггл)

**Размер:** Автоматически растягивается вниз  
**Цвет:** Синий градиент (#f0f9ff → #dbeafe), более насыщенный  
**Структура:** Тоггл + встроенная карточка дедлайна

**Внешний вид:**
```
┌──────────────────────────────────────────────────┐
│ ✓ 🔵 Автоматический расчет                       │
│ ────────────────────────────────────────────────│
│ ┌────────────────────────────────────────────┐  │
│ │ 📅 ДЕДЛАЙН: 22.10.2025 15:45              │  │
│ └────────────────────────────────────────────┘  │
└──────────────────────────────────────────────────┘
```

### Карточка Дедлайна (Встроенная)

**Фон:** Белый с прозрачностью (rgba(255, 255, 255, 0.7))  
**Граница:** 1px solid #bae6fd  
**Padding:** 8px 12px  
**Border-radius:** 6px  
**Иконка:** `event` (18px, синяя #0369a1)  
**Текст метки:** "ДЕДЛАЙН:" (11px, uppercase, жирный, #0369a1)  
**Текст значения:** 14px, жирный, #0c4a6e

---

## 💻 Технические Детали

### Frontend

#### HTML Структура
```html
<!-- Компактная плашка с тогглом и встроенным дедлайном -->
<div class="auto-calculate-toggle" 
     [class.with-deadline]="form.get('autoCalculateDueDate')?.value && calculatedDueDate"
     *ngIf="form.get('taskTypeId')?.value">
  
  <!-- Верхняя часть: тоггл + подсказка -->
  <div class="toggle-wrapper">
    <mat-slide-toggle 
      formControlName="autoCalculateDueDate"
      color="primary"
      (change)="onAutoCalculateToggle($event.checked)">
      <div class="toggle-content">
        <mat-icon class="toggle-icon">schedule</mat-icon>
        <span class="toggle-label">Автоматический расчет</span>
      </div>
    </mat-slide-toggle>
    <p class="toggle-hint" *ngIf="!form.get('autoCalculateDueDate')?.value">
      На основе типа задачи
    </p>
  </div>
  
  <!-- Нижняя часть: рассчитанный дедлайн (показывается при включенном тоггле) -->
  <div class="deadline-display" *ngIf="form.get('autoCalculateDueDate')?.value && calculatedDueDate">
    <mat-icon class="deadline-icon">event</mat-icon>
    <div class="deadline-content">
      <span class="deadline-label">Дедлайн:</span>
      <span class="deadline-value">{{ calculatedDueDate | date:'dd.MM.yyyy HH:mm' }}</span>
    </div>
  </div>
</div>

<!-- Datepicker (условный) -->
<mat-form-field 
  *ngIf="!form.get('autoCalculateDueDate')?.value || !form.get('taskTypeId')?.value">
  <!-- ... -->
</mat-form-field>
```

#### TypeScript Логика

**Поля:**
```typescript
calculatedDueDate: Date | null = null;
```

**Форма:**
```typescript
this.form = this.fb.group({
  // ...
  autoCalculateDueDate: [false],
  // ...
});
```

**Методы:**
```typescript
onTaskTypeChange(taskTypeId: number | null) {
  if (!taskTypeId) {
    this.form.patchValue({ autoCalculateDueDate: false });
    this.calculatedDueDate = null;
    return;
  }
  
  // Автоматически включаем тоггл
  const selectedType = this.taskTypes.find(t => t.id === taskTypeId);
  if (selectedType?.timeFrameSettings?.defaultDuration) {
    this.form.patchValue({ autoCalculateDueDate: true });
    this.calculateDueDate(taskTypeId);
  }
}

onAutoCalculateToggle(checked: boolean) {
  if (checked) {
    const taskTypeId = this.form.get('taskTypeId')?.value;
    if (taskTypeId) {
      this.calculateDueDate(taskTypeId);
    }
  } else {
    this.calculatedDueDate = null;
    this.form.patchValue({ dueDate: null });
  }
}

private calculateDueDate(taskTypeId: number) {
  this.taskTypeService.calculateDueDate(taskTypeId).subscribe({
    next: (result) => {
      if (result.dueDate) {
        this.calculatedDueDate = new Date(result.dueDate);
        this.snackBar.open('Дедлайн рассчитан автоматически', 'ОК', { duration: 2000 });
      }
    },
    error: (err) => {
      console.error('Error calculating due date:', err);
      this.snackBar.open('Ошибка расчета дедлайна', 'Закрыть', { duration: 3000 });
    }
  });
}
```

**Сохранение:**
```typescript
save() {
  // ...
  
  // Используем рассчитанный дедлайн или введенный вручную
  if (formValue.autoCalculateDueDate && this.calculatedDueDate) {
    dto.dueDate = this.calculatedDueDate.toISOString();
  } else if (formValue.dueDate) {
    dto.dueDate = new Date(formValue.dueDate).toISOString();
  }
  
  // ...
}
```

---

## 🎬 Сценарии Использования

### Сценарий 1: Создание Новой Задачи

1. Пользователь открывает форму создания задачи
2. Выбирает тип "Срочная заявка" (SLA: 60 минут)
3. ✅ Тоггл автоматически включается
4. ✅ Дедлайн рассчитывается: текущее время + 60 минут
5. ✅ Показывается карточка с рассчитанным временем
6. Пользователь заполняет остальные поля и сохраняет

**Результат:** Задача создана с дедлайном через 60 минут

---

### Сценарий 2: Ручной Ввод Дедлайна

1. Пользователь открывает форму создания задачи
2. Выбирает тип "Email рассылка" (8 часов)
3. ✅ Тоггл включается, дедлайн рассчитывается
4. Пользователь **выключает тоггл** ⬇️
5. ✅ Появляется datepicker
6. Пользователь вручную выбирает дату: 25.10.2025 10:00
7. Сохраняет задачу

**Результат:** Задача создана с дедлайном 25.10.2025 10:00

---

### Сценарий 3: Без Типа Задачи

1. Пользователь открывает форму
2. Не выбирает тип задачи (или выбирает "Без типа")
3. ✅ Тоггл **не показывается**
4. ✅ Показывается обычный datepicker
5. Пользователь выбирает дату вручную

**Результат:** Стандартное поведение

---

### Сценарий 4: Редактирование Существующей Задачи

1. Пользователь открывает задачу на редактирование
2. Задача имеет тип и дедлайн
3. ✅ Тоггл **выключен** по умолчанию (сохраняется текущий дедлайн)
4. ✅ Показывается datepicker с текущим дедлайном
5. Пользователь может:
   - Оставить как есть
   - Включить тоггл для пересчета
   - Изменить дату вручную

---

## 📊 Преимущества

### ✅ Для Пользователя:

- 🚀 **Быстрее** - не нужно вручную считать время
- 🎯 **Точнее** - учитываются рабочие часы, выходные, SLA
- 💡 **Понятнее** - видно рассчитанный дедлайн до сохранения
- 🔄 **Гибкость** - можно переключиться на ручной ввод

### ✅ Для Системы:

- ⚙️ **Консистентность** - одинаковая логика расчета
- 📈 **SLA контроль** - автоматическое соблюдение временных рамок
- 🔧 **Настраиваемость** - изменения в типе влияют на все задачи
- 📊 **Аналитика** - можно отслеживать соблюдение SLA

---

## 🎨 CSS Стили

```scss
// Компактная объединенная плашка
.auto-calculate-toggle {
  margin: 12px 0;
  padding: 12px 16px;
  background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
  border-radius: 8px;
  border: 1px solid #bae6fd;
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 16px;

  // Верхняя обертка: тоггл + подсказка справа
  .toggle-wrapper {
    display: flex;
    align-items: center;
    justify-content: space-between;
    width: 100%;
  }

  .toggle-hint {
    margin: 0;
    font-size: 12px;
    color: #0369a1;
    font-style: italic;
    text-align: right;
  }

  // Когда включен - расширяется вертикально
  &.with-deadline {
    flex-direction: column;
    align-items: flex-start;
    gap: 10px;
    background: linear-gradient(135deg, #f0f9ff 0%, #dbeafe 100%);
    border-color: #93c5fd;

    // Встроенная карточка дедлайна
    .deadline-display {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 6px;
      border: 1px solid #bae6fd;
      width: 100%;

      .deadline-value {
        font-size: 14px;
        font-weight: 600;
        color: #0c4a6e;
      }
    }
  }
}
```

**Ключевые изменения:**
- ✅ Padding уменьшен: 16px → 12px
- ✅ Border-radius уменьшен: 12px → 8px
- ✅ Иконки меньше: 20px → 18px
- ✅ Шрифты компактнее: 14px вместо 16px
- ✅ Дедлайн встроен в ту же плашку (не отдельная карточка)
- ✅ Подсказка справа от тоггла (не снизу)
- ✅ Flexbox layout для оптимального расположения

---

## 🧪 Тестирование

### Чеклист:

- [ ] Тоггл показывается только при выбранном типе
- [ ] Тоггл автоматически включается при выборе типа с defaultDuration
- [ ] Дедлайн рассчитывается корректно (учитывает рабочие часы)
- [ ] Для коротких интервалов (<60 мин) не применяется логика рабочих часов
- [ ] Карточка дедлайна показывается при включенном тоггле
- [ ] Datepicker скрывается при включенном тоггле
- [ ] Datepicker показывается при выключенном тоггле
- [ ] При сохранении используется правильный дедлайн (авто или ручной)
- [ ] При редактировании тоггл выключен по умолчанию
- [ ] Можно переключаться между режимами без потери данных
- [ ] Уведомления показываются корректно
- [ ] Стили отображаются правильно

---

**Версия:** 1.0  
**Дата:** 22 октября 2025  
**Статус:** ✅ Готово
