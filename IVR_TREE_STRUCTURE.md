# IVR Tree Structure - Древовидная структура

## Обзор изменений

Модуль IVR теперь поддерживает **неограниченную вложенность** дочерних элементов. Каждый элемент может иметь свои дочерние элементы, которые в свою очередь также могут иметь детей, создавая многоуровневую иерархию.

## Новые возможности

### 1. **Рекурсивное дерево**
- Любой дочерний элемент может иметь свои дочерние элементы
- Неограниченная глубина вложенности
- Визуальная индикация уровня вложенности (отступы)

### 2. **Компонент IvrTreeNodeComponent**
Новый standalone компонент для отображения узла дерева с рекурсией:
- Автоматическое отображение вложенных элементов
- Сворачивание/разворачивание веток
- Визуальная индикация наличия детей
- Счетчик дочерних элементов

### 3. **Улучшенная загрузка данных**
- Рекурсивная загрузка всех дочерних элементов
- Кэширование в `allNodes` для быстрого доступа
- Оптимизация запросов к API

## Структура файлов

```
apps/front/src/app/ivr/
├── components/
│   └── ivr-tree-node/
│       └── ivr-tree-node.component.ts  (НОВЫЙ)
├── containers/
│   └── ivr-list/
│       ├── ivr.component.ts            (ОБНОВЛЕН)
│       ├── ivr.component.html          (ОБНОВЛЕН)
│       └── ivr.component.scss          (ОБНОВЛЕН)
└── ivr.service.ts
```

## Архитектура компонентов

### IvrTreeNodeComponent

**Входные параметры:**
- `node` - текущий узел дерева
- `children` - массив дочерних узлов
- `selectedId` - ID выбранного узла
- `level` - уровень вложенности (для отступов)
- `actionLabels` - словарь меток действий
- `allNodes` - все узлы для рекурсии

**Выходные события:**
- `onSelect` - выбор узла
- `onAddChild` - добавление дочернего элемента
- `onEdit` - редактирование узла
- `onDelete` - удаление узла

**Ключевые фичи:**
```typescript
// Рекурсивный рендеринг
<app-ivr-tree-node
  *ngFor="let child of children"
  [node]="child"
  [children]="getNodeChildren(child.id)"
  [level]="level + 1"
  ...
></app-ivr-tree-node>

// Сворачивание/разворачивание
expanded = true;
toggleExpand(event: Event) {
  event.stopPropagation();
  this.expanded = !this.expanded;
}
```

### IvrAdminComponent (обновлен)

**Новые свойства:**
```typescript
allNodes: IvrNodeDto[] = [];  // Все узлы для построения дерева
```

**Новые методы:**
```typescript
// Загрузка всех узлов рекурсивно
loadAllNodes()
loadAllChildren()
loadChildrenRecursive(parentId: string): Promise<void>

// Получение детей узла
getNodeChildren(nodeId?: string): IvrNodeDto[]

// Обработчики событий дерева
onNodeSelect(node: IvrNodeDto)
onNodeAddChild(node: IvrNodeDto)
onNodeEdit(node: IvrNodeDto)
onNodeDelete(node: IvrNodeDto)
```

## Использование

### Создание многоуровневой структуры

```
Главное меню (root)
├── 1 → Техподдержка (child level 1)
│   ├── 1 → Общие вопросы (child level 2)
│   │   ├── 1 → FAQ (child level 3)
│   │   └── 2 → Инструкции (child level 3)
│   ├── 2 → Критичные вопросы (child level 2)
│   └── 0 → Назад (child level 2)
├── 2 → Отдел продаж (child level 1)
│   ├── 1 → Новые клиенты (child level 2)
│   ├── 2 → Существующие клиенты (child level 2)
│   └── 3 → Партнеры (child level 2)
└── 0 → Повторить (child level 1)
```

### Добавление дочернего элемента на любом уровне

1. Выберите корневой элемент в левой панели
2. В средней панели (дерево) выберите элемент, к которому хотите добавить ребенка
3. Нажмите кнопку **"+"** (Add) в действиях узла
4. Или нажмите **"+"** в заголовке панели для добавления к выбранному

### Навигация по дереву

- **Кликните на стрелку** (>) для сворачивания/разворачивания ветки
- **Кликните на узел** для выбора и редактирования
- **Наведите на узел** для отображения действий (Add, Edit, Delete)

## Визуальные индикаторы

### Иконки уровней
- **Корневой элемент**: Синяя иконка `device_hub`
- **Дочерние элементы**: Фиолетовые иконки `subdirectory_arrow_right`

### Отступы
Каждый уровень добавляет 20px отступа слева для визуальной иерархии.

### Счетчик детей
Отображается количество прямых дочерних элементов:
```
"3 элемента" или "1 элемент"
```

### Состояние разворачивания
- **Развернуто**: `expand_more` (стрелка вниз)
- **Свернуто**: `chevron_right` (стрелка вправо)

## API запросы

### Загрузка дерева
```typescript
// 1. Загрузка корневых элементов
GET /api/ivr/nodes/root

// 2. Для каждого корня рекурсивно:
GET /api/ivr/nodes/:id/children

// 3. Для каждого ребенка снова:
GET /api/ivr/nodes/:id/children

// И так далее до самого глубокого уровня
```

### Создание дочернего элемента на любом уровне
```typescript
POST /api/ivr/nodes
{
  "name": "Новый элемент",
  "parentId": "ID_РОДИТЕЛЯ",  // ID любого узла
  "action": "menu",
  "digit": "1"
}
```

## Производительность

### Оптимизации
1. **Кэширование всех узлов** в `allNodes` после первой загрузки
2. **Ленивая рекурсия** - дети загружаются только при необходимости
3. **Promise.all** для параллельной загрузки веток
4. **Фильтрация на клиенте** для быстрого получения детей

### Рекомендации
- Для очень глубоких деревьев (>10 уровней) рассмотрите ленивую загрузку
- Используйте кэш `allNodes` вместо повторных запросов
- При изменениях обновляйте только затронутую ветку

## Примеры использования

### Пример 1: Простое меню с подменю
```
Главное меню
├── 1 → Услуги
│   ├── 1 → Консультация
│   ├── 2 → Установка
│   └── 0 → Назад
└── 2 → Поддержка
```

### Пример 2: Сложная навигация
```
Call Center
├── 1 → Русский язык
│   ├── 1 → Продажи
│   │   ├── 1 → Корпоративные клиенты
│   │   ├── 2 → Физические лица
│   │   └── 0 → Назад
│   ├── 2 → Поддержка
│   │   ├── 1 → Техническая
│   │   ├── 2 → Финансовая
│   │   └── 0 → Назад
│   └── 0 → Главное меню
└── 2 → English
    └── 1 → Sales
```

## Отладка

### Проверка структуры дерева
```typescript
console.log('Root nodes:', this.rootNodes);
console.log('All nodes:', this.allNodes);
console.log('Children map:', this.childrenMap);
```

### Проверка родителей
```sql
SELECT id, name, "parentId", action 
FROM ivr_node 
WHERE "parentId" IS NOT NULL 
ORDER BY "parentId", "order";
```

## Будущие улучшения

- [ ] Drag & Drop для перемещения между уровнями
- [ ] Поиск по дереву с подсветкой
- [ ] Массовое редактирование веток
- [ ] Экспорт/импорт дерева в JSON
- [ ] Визуализация дерева в виде графа
- [ ] Копирование веток
- [ ] Шаблоны типовых структур

---

**Дата обновления**: 23 октября 2025  
**Версия**: 2.0
