[default]
exten => 1000,1,NoOp(Call uniqueid=${UNIQUEID})
exten => 1000,n,Set(CDR(userfield)=${UNIQUEID})
exten => 1000,n,Answer()
exten => 1000,n,Gosub(sub-record-start,s,1())
exten => 1000,n,NoOp(Entering ARI Stasis application crm-app)
exten => 1000,n,Stasis(crm-app,${CALLERID(num)},1000)
exten => 1000,n,Playback(demo-congrats)
exten => 1000,n,Hangup()

; Dedicated IVR entry extension -> dynamic IVR tree (root node must exist)
exten => 6000,1,NoOp(Call uniqueid=${UNIQUEID})
exten => 6000,n,Set(CDR(userfield)=${UNIQUEID})
exten => 6000,n,Answer()
exten => 6000,n,NoOp(Entering dynamic IVR via ARI crm-app)
exten => 6000,n,Gosub(sub-record-start,s,1())
exten => 6000,n,Stasis(crm-app,${CALLERID(num)})
exten => 6000,n,Hangup()

; Support queue extension
exten => 100,1,NoOp(Call uniqueid=${UNIQUEID})
exten => 100,n,Set(CDR(userfield)=${UNIQUEID})
exten => 100,n,NoOp(Routing to support queue)
exten => 100,n,Answer()
exten => 100,n,Gosub(sub-record-start,s,1())
exten => 100,n,Queue(support,n)
exten => 100,n,Hangup()

; ARI test extension routes call into Stasis application "crm-app"
exten => 1100,1,NoOp(Call uniqueid=${UNIQUEID})
exten => 1100,n,Set(CDR(userfield)=${UNIQUEID})
exten => 1100,n,NoOp(Entering ARI Stasis application crm-app)
exten => 1100,n,Stasis(crm-app,${CALLERID(num)})
exten => 1100,n,Hangup()

; Operator extensions
exten => 2001,1,NoOp(Call uniqueid=${UNIQUEID})
exten => 2001,n,Set(CDR(userfield)=${UNIQUEID})
exten => 2001,n,Answer()
exten => 2001,n,Gosub(sub-record-start,s,1())
exten => 2001,n,Playback(custom/1755270740097_45543)
exten => 2001,n,Hangup()

exten => 2002,1,NoOp(Call uniqueid=${UNIQUEID})
exten => 2002,n,Set(CDR(userfield)=${UNIQUEID})
exten => 2002,n,Answer()
exten => 2002,n,Gosub(sub-record-start,s,1())
exten => 2002,n,Playback(hello-world)
exten => 2002,n,Hangup()

exten => 2003,1,NoOp(Call uniqueid=${UNIQUEID})
exten => 2003,n,Set(CDR(userfield)=${UNIQUEID})
exten => 2003,n,Answer()
exten => 2003,n,Gosub(sub-record-start,s,1())
exten => 2003,n,Playback(hello-world)
exten => 2003,n,Hangup()

exten => 2004,1,NoOp(Call uniqueid=${UNIQUEID})
exten => 2004,n,Set(CDR(userfield)=${UNIQUEID})
exten => 2004,n,Answer()
exten => 2004,n,Gosub(sub-record-start,s,1())
exten => 2004,n,Playback(hello-world)
exten => 2004,n,Hangup()

; Allow direct calls by operator username (e.g. sip:operator2@host)
; Map logical operator names to PJSIP endpoints so INVITEs to 'operator2' resolve
exten => operator1,1,NoOp(Call uniqueid=${UNIQUEID})
exten => operator1,n,Set(CDR(userfield)=${UNIQUEID})
exten => operator1,n,NoOp(Calling operator1 by name)
exten => operator1,n,Dial(PJSIP/operator1,20)
exten => operator1,n,Hangup()

exten => operator2,1,NoOp(Call uniqueid=${UNIQUEID})
exten => operator2,n,Set(CDR(userfield)=${UNIQUEID})
exten => operator2,n,NoOp(Calling operator2 by name)
exten => operator2,n,Dial(PJSIP/operator2,20)
exten => operator2,n,Hangup()

exten => operator3,1,NoOp(Call uniqueid=${UNIQUEID})
exten => operator3,n,Set(CDR(userfield)=${UNIQUEID})
exten => operator3,n,NoOp(Calling operator3 by name)
exten => operator3,n,Dial(PJSIP/operator3,20)
exten => operator3,n,Hangup()

exten => operator4,1,NoOp(Call uniqueid=${UNIQUEID})
exten => operator4,n,Set(CDR(userfield)=${UNIQUEID})
exten => operator4,n,NoOp(Calling operator4 by name)
exten => operator4,n,Dial(PJSIP/operator4,20)
exten => operator4,n,Hangup()

; Queue entries for [default] context
; Note: Channels from IVR are already answered, skip Answer() and record init
; Recording starts when agent answers (gosub parameter)
exten => _queue_.,1,NoOp(Queue bridge for ${EXTEN} from IVR)
exten => _queue_.,n,Set(QNAME=${EXTEN:6})
exten => _queue_.,n,ExecIf($[${REGEX("^[0-9]+$" "${QNAME}")} = 1]?Set(QNAME=support))
exten => _queue_.,n,NoOp(Resolved QNAME=${QNAME})
exten => _queue_.,n,Queue(${QNAME},n,,,,,sub-record-start,s,1)
exten => _queue_.,n,Hangup()

exten => microsip,1,NoOp(Call uniqueid=${UNIQUEID})
exten => microsip,n,Set(CDR(userfield)=${UNIQUEID})
exten => microsip,n,NoOp(Calling microsip by name)
exten => microsip,n,Dial(PJSIP/microsip,20)
exten => microsip,n,Gosub(sub-record-start,s,1())
exten => microsip,n,Hangup()

; Generic queue bridge: callers redirected to extension queue_<name> will be sent to Queue(<name>)
; Note: Channel is already answered from IVR, no need to Answer() again
; Recording starts when agent answers (gosub parameter)
exten => support,1,NoOp(Call uniqueid=${UNIQUEID})
exten => support,n,Set(CDR(userfield)=${UNIQUEID})
exten => support,n,NoOp(Routing to queue support from IVR)
exten => support,n,Queue(support,n,,,,,sub-record-start,s,1)
exten => support,n,Hangup()

; Context for channels continued from ARI
[from-ari]
; Example: POST /ari/channels/{channelId}/continue?context=from-ari&extension=1000&priority=1
; Map explicit dialplan entries for ARI continue/originate targets
exten => 1000,1,NoOp(From ARI: routing to extension 1000)
exten => 1000,2,Answer()
exten => 1000,3,Gosub(sub-record-start,s,1())
exten => 1000,4,Queue(support,n)
exten => 1000,5,Hangup()

; Handle queue continuation requests like extension=queue_support
exten => _queue_.,1,NoOp(From ARI: queue bridge for ${EXTEN})
exten => _queue_.,n,Set(QNAME=${EXTEN:6})
; If QNAME is purely numeric (e.g. queue_1) map it to the default support queue
; Use REGEX("<pattern>" <string>) form and compare to 1 to avoid func_strings error
exten => _queue_.,n,ExecIf($[${REGEX("^[0-9]+$" "${QNAME}")} = 1]?Set(QNAME=support))
exten => _queue_.,n,NoOp(Resolved QNAME=${QNAME})
exten => _queue_.,n,Gosub(sub-record-start,s,1())
exten => _queue_.,n,Queue(${QNAME},n)
exten => _queue_.,n,Hangup()

; Invalid extension handler to prevent 'no invalid handler' errors
exten => i,1,NoOp(Invalid extension received in from-ari)
exten => i,n,NoOp(Exten=${EXTEN} Caller=${CALLERID(num)})
exten => i,n,Hangup()

; Subroutine: start MixMonitor recording for the current channel
[sub-record-start]
exten => s,1,NoOp(Start MixMonitor for channel ${CHANNEL(name)} uniqueid=${UNIQUEID})
; Write recordings to the project-mounted recordings directory
exten => s,n,Set(RECORDINGS_DIR=/var/lib/asterisk/recordings)
exten => s,n,Set(REC_FILENAME=${UNIQUEID})
exten => s,n,Set(REC_FULLPATH=${RECORDINGS_DIR}/${REC_FILENAME}.wav)
exten => s,n,NoOp(MixMonitor target: ${REC_FULLPATH})
; Start MixMonitor only if not already running (check if variable is empty)
exten => s,n,GotoIf($["${MIXMONITOR_EXISTS}" != ""]?skip_mixmonitor)
exten => s,n,MixMonitor(${REC_FULLPATH},b)
exten => s,n,Set(MIXMONITOR_EXISTS=1)
exten => s,n(skip_mixmonitor),Set(__REC_FILE=${REC_FULLPATH})
exten => s,n,NoOp(Recording file: ${__REC_FILE})
exten => s,n,Return()

; Support alternative extension name expected by some ARI redirects (queue_<name>)
exten => support,1,NoOp(From ARI: routing to support queue by queue_<name>)
exten => support,2,Gosub(sub-record-start,s,1())
exten => support,3,Queue(support,n)
exten => support,4,Hangup()


